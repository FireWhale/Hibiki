// Copyright (c) 2018 NHOGS Interactive.
(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("d3"),require("jquery")):"function"==typeof define&&define.amd?define(["exports","d3","jquery"],t):t(e.popoto=e.popoto||{},e.d3,e.jQuery)})(this,function(e,u,o){"use strict";o=o&&o.hasOwnProperty("default")?o.default:o;var t="2.0.8",m={};m.idGen=0,m.generateId=function(){return m.idGen++},m.nodes=[],m.links=[],m.ids=[],m.getRootNode=function(){return m.nodes[0]},m.inDataNodes=function(t,n){return m.nodes.filter(function(e){return void 0!==e.attributes?parseInt(e.attributes.uuid)==n&&e.label==t:void 0!==e.value&&(parseInt(e.value[0].attributes.uuid)==n&&e.label==t)})},m.inDataLinks=function(t,n){return m.links.filter(function(e){return e.target.id==t&&e.source.id==n||e.target.id==n&&e.source.id==t})},d3.functor=function(e){return"function"==typeof e?e:function(){return e}};var p={};p.LogLevels=Object.freeze({DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4}),p.LEVEL=p.LogLevels.NONE,p.TRACE=!1,p.log=function(e,t){if(console&&e>=p.LEVEL)switch(p.TRACE&&(t=t+"\n"+(new Error).stack),e){case p.LogLevels.DEBUG:case p.LogLevels.INFO:console.log(t);break;case p.LogLevels.WARN:console.warn(t);break;case p.LogLevels.ERROR:console.error(t)}},p.debug=function(e){p.log(p.LogLevels.DEBUG,e)},p.info=function(e){p.log(p.LogLevels.INFO,e)},p.warn=function(e){p.log(p.LogLevels.WARN,e)};var b={MAX_RESULTS_COUNT:10,VALUE_QUERY_LIMIT:10,USE_PARENT_RELATION:!(p.error=function(e){p.log(p.LogLevels.ERROR,e)}),USE_RELATION_DIRECTION:!1,COLLECT_RELATIONS_WITH_VALUES:!1,prefilter:""};b.NEO4J_INTERNAL_ID=Object.freeze({queryInternalName:"NEO4JID"}),b.filterRelation=function(e){return!0},b.generateTaxonomyCountQuery=function(e){var t=N.node.getConstraintAttribute(e),n=[];return N.node.getPredefinedConstraints(e).forEach(function(e){n.push(e.replace(new RegExp("\\$identifier","g"),"n"))}),t===b.NEO4J_INTERNAL_ID?"MATCH (n:`"+e+"`)"+(0<n.length?" WHERE "+n.join(" AND "):"")+" RETURN count(DISTINCT ID(n)) as count":"MATCH (n:`"+e+"`)"+(0<n.length?" WHERE "+n.join(" AND "):"")+" RETURN count(DISTINCT n."+t+") as count"},b.generateHibikiElements=function(e,t){N.node.getPredefinedConstraints(rootNode.label).forEach(function(e){whereElements.push(e.replace(new RegExp("\\$identifier","g"),rootNode.internalLabel))}),[].push("("+rootNode.internalLabel+":`"+rootNode.label+"`)")},b.generateQueryElements=function(t,u,e,p,c){var g=[],f=[],h=[],v=[],E={};if(N.node.getPredefinedConstraints(t.label).forEach(function(e){f.push(e.replace(new RegExp("\\$identifier","g"),t.internalLabel))}),g.push("("+t.internalLabel+":`"+t.label+"`)"),p||t.immutable){var n=b.generateNodeValueConstraints(t,c);for(var r in f=f.concat(n.whereElements),n.parameters)n.parameters.hasOwnProperty(r)&&(E[r]=n.parameters[r])}var y=0;return e.forEach(function(r){var a=r.source,o=r.target,l="->";b.USE_RELATION_DIRECTION&&!0!==o.isParentRelReverse||(l="-");var e="r"+y++;if(h.push(e),N.node.getPredefinedConstraints(o.label).forEach(function(e){f.push(e.replace(new RegExp("\\$identifier","g"),o.internalLabel))}),o!==u&&!0===o.isNegative)if(void 0!==o.value&&0<o.value.length){var i=0;o.value.forEach(function(e){var t,n=N.node.getConstraintAttribute(e.label);0===i?(t=o.internalLabel+"_"+n,i++):t=o.internalLabel+"_"+n+i++,f.push("(NOT ("+a.internalLabel+":`"+a.label+"`)-[:`"+r.label+"`]"+l+"(:`"+o.label+"`{"+n+":$"+t+"}) )")})}else f.push("(NOT ("+a.internalLabel+":`"+a.label+"`)-[:`"+r.label+"`]"+l+"(:`"+o.label+"`) )");else{b.COLLECT_RELATIONS_WITH_VALUES&&o===u&&v.push("COLLECT("+e+") AS incomingRels");var t="";c&&void 0!==N.node.getGenerateNodeValueConstraints(a)||(t=":`"+a.label+"`");var n="";c&&void 0!==N.node.getGenerateNodeValueConstraints(o)||(n=":`"+o.label+"`"),g.push("("+a.internalLabel+t+")-["+e+":`"+r.label+"`]"+l+"("+o.internalLabel+n+")")}if(o!==u&&(p||o.immutable)){var s=b.generateNodeValueConstraints(o,c);for(var d in f=f.concat(s.whereElements),s.parameters)s.parameters.hasOwnProperty(d)&&(E[d]=s.parameters[d])}}),{matchElements:g,whereElements:f,relationElements:h,returnElements:v,parameters:E}},b.generateNodeValueConstraints=function(e,t){if(t&&void 0!==N.node.getGenerateNodeValueConstraints(e))return N.node.getGenerateNodeValueConstraints(e)(e);var n={},r=[];if(void 0!==e.value&&0<e.value.length){var a=N.node.getConstraintAttribute(e.label),o=e.internalLabel+"_"+a;if(1<e.value.length)if(void 0!==e.isNegative&&e.isNegative){var l=0;e.value.forEach(function(e){var t;t=a===b.NEO4J_INTERNAL_ID?e.internalID:e.attributes[a],0===l?(n[o]=t,l++):n[o+l++]=t})}else n[o]=[],e.value.forEach(function(e){var t;t=a===b.NEO4J_INTERNAL_ID?e.internalID:e.attributes[a],n[o].push(t)}),a===b.NEO4J_INTERNAL_ID?r.push("ID("+e.internalLabel+") IN {`"+o+"`}"):r.push(e.internalLabel+"."+a+" IN {`"+o+"`}");else if(a===b.NEO4J_INTERNAL_ID?n[o]=e.value[0].internalID:n[o]=e.value[0].attributes[a],void 0===e.isNegative||!e.isNegative){a===b.NEO4J_INTERNAL_ID?r.push("ID("+e.internalLabel+") = {`"+o+"`}"):r.push(e.internalLabel+"."+a+" = {`"+o+"`}")}}return{parameters:n,whereElements:r}},b.getRelevantLinks=function(a,t,e){var o=e.slice(),n=[],l=[];return o.forEach(function(e){(void 0!==e.target.value&&0<e.target.value.length||e.target===t||e.target.isNegative)&&n.push(e)}),n.forEach(function(e){o.splice(o.indexOf(e),1)}),n.forEach(function(e){for(var t=e.source,n=!0;n;){var r=null;o.forEach(function(e){e.target===t&&(r=e)}),null===r?n=!1:r.source===a?(l.push(r),o.splice(o.indexOf(r),1),n=!1):(l.push(r),o.splice(o.indexOf(r),1),t=r.source)}}),n.concat(l)},b.getLinksToRoot=function(e,t){for(var n=[],r=e;r!==m.getRootNode();){for(var a,o=0;o<t.length;o++){var l=t[o];if(l.target===r){a=l;break}}a&&(n.push(a),r=a.source)}return n},b.generateResultQuery=function(e){var t=m.getRootNode(),n=b.generateQueryElements(t,t,b.getRelevantLinks(t,t,m.links),!0,!0),r=n.matchElements,a=n.whereElements,o=n.relationElements,l=[],i=[],s=n.parameters,d=N.node.getResultOrderByAttribute(t.label);if(d){var u=N.node.isResultOrderAscending(t.label)?"ASC":"DESC";i.push("ORDER BY "+d+" "+u)}i.push("LIMIT "+b.MAX_RESULTS_COUNT);var p=N.node.getReturnAttributes(t.label);if(e)l.push(t.internalLabel),o.forEach(function(e){l.push(e)});else for(var c=0;c<p.length;c++){var g=p[c];g===b.NEO4J_INTERNAL_ID?l.push("ID("+t.internalLabel+") AS "+b.NEO4J_INTERNAL_ID.queryInternalName):l.push(t.internalLabel+"."+g+" AS "+g)}var f="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN DISTINCT "+l.join(", ")+" "+i.join(" "),h=N.node.filterResultQuery(t.label,{statement:f,matchElements:r,whereElements:a,withElements:[],returnElements:l,endElements:i,parameters:s});return h.statement=b.prefilter+h.statement,h},b.generateNodeCountQuery=function(e){var t=b.generateQueryElements(m.getRootNode(),e,b.getRelevantLinks(m.getRootNode(),e,m.links),!0,!0),n=t.matchElements,r=t.whereElements,a=[],o=t.parameters,l=N.node.getConstraintAttribute(e.label);l===b.NEO4J_INTERNAL_ID?a.push("count(DISTINCT ID("+e.internalLabel+")) as count"):a.push("count(DISTINCT "+e.internalLabel+"."+l+") as count");var i="MATCH "+n.join(", ")+(0<r.length?" WHERE "+r.join(" AND "):"")+" RETURN "+a.join(", "),s=N.node.filterNodeCountQuery(e,{statement:i,matchElements:n,whereElements:r,returnElements:a,endElements:[],parameters:o});return{statement:b.prefilter+s.statement,parameters:s.parameters}},b.generateNodeValueQuery=function(e){var t=m.getRootNode(),n=b.generateQueryElements(t,e,b.getRelevantLinks(t,e,m.links),!0,!1),r=n.matchElements,a=n.whereElements,o=[],l=[],i=n.parameters,s=N.node.getValueOrderByAttribute(e.label);if(s){var d=N.node.isValueOrderAscending(e.label)?"ASC":"DESC";l.push("ORDER BY "+s+" "+d)}l.push("LIMIT "+b.VALUE_QUERY_LIMIT);for(var u=N.node.getReturnAttributes(e.label),p=(N.node.getConstraintAttribute(e.label),0);p<u.length;p++)u[p]===b.NEO4J_INTERNAL_ID?o.push("ID("+e.internalLabel+") AS "+b.NEO4J_INTERNAL_ID.queryInternalName):o.push(e.internalLabel+"."+u[p]+" AS "+u[p]);var c=N.node.getConstraintAttribute(t.label);c===b.NEO4J_INTERNAL_ID?o.push("count(DISTINCT ID("+t.internalLabel+")) AS count"):o.push("count(DISTINCT "+t.internalLabel+"."+c+") AS count"),b.COLLECT_RELATIONS_WITH_VALUES&&n.returnElements.forEach(function(e){o.push(e)});var g="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN "+o.join(", ")+" "+l.join(" "),f=N.node.filterNodeValueQuery(e,{statement:g,matchElements:r,whereElements:a,returnElements:o,endElements:l,parameters:i});return{statement:b.prefilter+f.statement,parameters:f.parameters}},b.generateNodeRelationQuery=function(e){var t=b.getLinksToRoot(e,m.links),n=b.generateQueryElements(m.getRootNode(),e,t,!1,!1),r=n.matchElements,a=n.whereElements,o=[],l=[],i=n.parameters,s=b.USE_RELATION_DIRECTION?"->":"-";r.push("("+e.internalLabel+":`"+e.label+"`)-[r]"+s+"(x)"),o.push("type(r) AS label"),b.USE_PARENT_RELATION?o.push("head(labels(x)) AS target"):o.push("last(labels(x)) AS target"),o.push("count(r) AS count"),l.push("ORDER BY count(r) DESC");var d="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN "+o.join(", ")+" "+l.join(" "),u=N.node.filterNodeRelationQuery(e,{statement:d,matchElements:r,whereElements:a,returnElements:o,endElements:l,parameters:i});return{statement:b.prefilter+u.statement,parameters:u.parameters}};var N={};N.colorScale=u.scaleOrdinal(u.schemeCategory10),N.link={},N.link.Provider={},N.taxonomy={},N.taxonomy.Provider={},N.node={},N.node.Provider={},N.link.getTextValue=function(e){return N.link.Provider.hasOwnProperty("getTextValue")?N.link.Provider.getTextValue(e):N.link.DEFAULT_PROVIDER.hasOwnProperty("getTextValue")?N.link.DEFAULT_PROVIDER.getTextValue(e):void p.error("No provider defined for link getTextValue")},N.link.getColor=function(e,t,n){return N.link.Provider.hasOwnProperty("getColor")?N.link.Provider.getColor(e,t,n):N.link.DEFAULT_PROVIDER.hasOwnProperty("getColor")?N.link.DEFAULT_PROVIDER.getColor(e,t,n):void p.error("No provider defined for getColor")},N.link.getCSSClass=function(e,t){return N.link.Provider.hasOwnProperty("getCSSClass")?N.link.Provider.getCSSClass(e,t):N.link.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass")?N.link.DEFAULT_PROVIDER.getCSSClass(e,t):void p.error("No provider defined for getCSSClass")},N.link.getDistance=function(e){return N.link.Provider.hasOwnProperty("getDistance")?N.link.Provider.getDistance(e):N.link.DEFAULT_PROVIDER.hasOwnProperty("getDistance")?N.link.DEFAULT_PROVIDER.getDistance(e):void p.error("No provider defined for getDistance")},N.link.getSemanticValue=function(e){return N.link.Provider.hasOwnProperty("getSemanticValue")?N.link.Provider.getSemanticValue(e):N.link.DEFAULT_PROVIDER.hasOwnProperty("getSemanticValue")?N.link.DEFAULT_PROVIDER.getSemanticValue(e):void p.error("No provider defined for getSemanticValue")},N.colorLuminance=function(e,t){(e=String(e).replace(/[^0-9a-f]/gi,"")).length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;var n,r,a="#";for(r=0;r<3;r++)n=parseInt(e.substr(2*r,2),16),a+=("00"+(n=Math.round(Math.min(Math.max(0,n+n*t),255)).toString(16))).substr(n.length);return a},N.link.DEFAULT_PROVIDER={getTextValue:function(e){if(e.type===O.link.LinkTypes.VALUE)return N.node.isTextDisplayed(e.target)?"":N.node.getTextValue(e.target);var t="";return e.type===O.link.LinkTypes.SEGMENT&&(t=" "+N.node.getTextValue(e.target)),e.label+t},getDistance:function(e){return e.type===O.link.LinkTypes.VALUE?13/8*(N.node.getSize(e.source)+N.node.getSize(e.target)):2.5*(N.node.getSize(e.source)+N.node.getSize(e.target))},getColor:function(e,t,n){if(e.type===O.link.LinkTypes.VALUE)return"#525863";var r=e.target.label,a=N.colorScale(r);return"stroke"===n?N.colorLuminance(a,-.2):a},getCSSClass:function(e,t){var n="ppt-link__"+t;if(e.type===O.link.LinkTypes.VALUE)n+="--value";else{var r="ppt-"+e.label.replace(/[^0-9a-z\-_]/gi,"");e.type===O.link.LinkTypes.RELATION&&(n+="--relation",e.target.count,n=n+" "+r)}return n},getSemanticValue:function(e){return N.link.getTextValue(e)}},N.link.Provider=N.link.DEFAULT_PROVIDER,N.taxonomy.getTextValue=function(e){return N.taxonomy.Provider.hasOwnProperty("getTextValue")?N.taxonomy.Provider.getTextValue(e):N.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getTextValue")?N.taxonomy.DEFAULT_PROVIDER.getTextValue(e):void p.error("No provider defined for taxonomy getTextValue")},N.taxonomy.getCSSClass=function(e,t){return N.taxonomy.Provider.hasOwnProperty("getCSSClass")?N.taxonomy.Provider.getCSSClass(e,t):N.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass")?N.taxonomy.DEFAULT_PROVIDER.getCSSClass(e,t):void p.error("No provider defined for taxonomy getCSSClass")},N.taxonomy.DEFAULT_PROVIDER={getTextValue:function(e){return e},getCSSClass:function(e,t){return"ppt-taxo__"+t+" "+e.replace(/[^0-9a-z\-_]/gi,"")}},N.taxonomy.Provider=N.taxonomy.DEFAULT_PROVIDER,N.node.DisplayTypes=Object.freeze({TEXT:0,IMAGE:1,SVG:2,SYMBOL:3}),N.node.getProvider=function(e){if(void 0!==e){if(N.node.Provider.hasOwnProperty(e))return N.node.Provider[e];for(var t in p.debug("No direct provider found for label "+e),N.node.Provider)if(N.node.Provider.hasOwnProperty(t)){var n=N.node.Provider[t];if(n.hasOwnProperty("children")&&-1<n.children.indexOf(e)){p.debug("No provider is defined for label ("+e+"), parent ("+t+") will be used");var r={parent:t};for(var a in n)n.hasOwnProperty(a)&&"children"!==a&&"parent"!==a&&(r[a]=n[a]);return N.node.Provider[e]=r,N.node.Provider[e]}}for(var o in p.debug("No label provider defined for label ("+e+") default one will be created from provider.node.DEFAULT_PROVIDER"),N.node.Provider[e]={},N.node.DEFAULT_PROVIDER)N.node.DEFAULT_PROVIDER.hasOwnProperty(o)&&(N.node.Provider[e][o]=N.node.DEFAULT_PROVIDER[o]);return N.node.Provider[e]}p.error("Node label is undefined, no label provider can be found.")},N.node.getProperty=function(e,t){var n=N.node.getProvider(e);if(!n.hasOwnProperty(t)){for(var r=n,a=!1;r.hasOwnProperty("parent")&&!a;)(r=N.node.getProvider(r.parent)).hasOwnProperty(t)&&(n[t]=r[t],a=!0);a||(N.node.DEFAULT_PROVIDER.hasOwnProperty(t)?n[t]=N.node.DEFAULT_PROVIDER[t]:p.debug('No default value for "'+t+'" property found for label provider ('+e+")"))}return n[t]},N.node.getIsAutoLoadValue=function(e){return N.node.getProperty(e,"isAutoLoadValue")},N.node.getIsSearchable=function(e){return N.node.getProperty(e,"isSearchable")},N.node.getIsAutoExpandRelations=function(e){return N.node.getProperty(e,"autoExpandRelations")},N.node.getSchema=function(e){return N.node.getProperty(e,"schema")},N.node.getReturnAttributes=function(e){var t=N.node.getProvider(e),n={};if(t.hasOwnProperty("returnAttributes"))for(var r=0;r<t.returnAttributes.length;r++)t.returnAttributes[r]===b.NEO4J_INTERNAL_ID?n[b.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[t.returnAttributes[r]]=!0;for(;t.hasOwnProperty("parent");)if((t=N.node.getProvider(t.parent)).hasOwnProperty("returnAttributes"))for(var a=0;a<t.returnAttributes.length;a++)t.returnAttributes[a]===b.NEO4J_INTERNAL_ID?n[b.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[t.returnAttributes[a]]=!0;if(N.node.DEFAULT_PROVIDER.hasOwnProperty("returnAttributes"))for(var o=0;o<N.node.DEFAULT_PROVIDER.returnAttributes.length;o++)N.node.DEFAULT_PROVIDER.returnAttributes[o]!==b.NEO4J_INTERNAL_ID&&(n[N.node.DEFAULT_PROVIDER.returnAttributes[o]]=!0);var l=N.node.getConstraintAttribute(e);l===b.NEO4J_INTERNAL_ID?n[b.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[l]=!0;var i=[];for(var s in n)n.hasOwnProperty(s)&&(s===b.NEO4J_INTERNAL_ID.queryInternalName?i.push(b.NEO4J_INTERNAL_ID):i.push(s));return i.length<=0&&i.push(b.NEO4J_INTERNAL_ID),i},N.node.getConstraintAttribute=function(e){return N.node.getProperty(e,"constraintAttribute")},N.node.getDisplayAttribute=function(e){var t=N.node.getProperty(e,"displayAttribute");if(void 0===t){var n=N.node.getReturnAttributes(e);t=0<n.length?n[0]:N.node.getConstraintAttribute(e)}return t},N.node.getPredefinedConstraints=function(e){return N.node.getProperty(e,"getPredefinedConstraints")()},N.node.filterResultQuery=function(e,t){return N.node.getProperty(e,"filterResultQuery")(t)},N.node.getValueOrderByAttribute=function(e){return N.node.getProperty(e,"valueOrderByAttribute")},N.node.isValueOrderAscending=function(e){return N.node.getProperty(e,"isValueOrderAscending")},N.node.getResultOrderByAttribute=function(e){return N.node.getProperty(e,"resultOrderByAttribute")},N.node.isResultOrderAscending=function(e){return N.node.getProperty(e,"isResultOrderAscending")},N.node.getTextValue=function(e,t){return N.node.getProperty(e.label,"getTextValue")(e,t)},N.node.getSemanticValue=function(e){return N.node.getProperty(e.label,"getSemanticValue")(e)},N.node.getSVGPaths=function(e){return N.node.getProperty(e.label,"getSVGPaths")(e)},N.node.isTextDisplayed=function(e){return N.node.getProperty(e.label,"getIsTextDisplayed")(e)},N.node.getSize=function(e){return N.node.getProperty(e.label,"getSize")(e)},N.node.getColor=function(e,t){return N.node.getProperty(e.label,"getColor")(e,t)},N.node.getCSSClass=function(e,t){return N.node.getProperty(e.label,"getCSSClass")(e,t)},N.node.getIsGroup=function(e){return N.node.getProperty(e.label,"getIsGroup")(e)},N.node.getNodeDisplayType=function(e){return N.node.getProperty(e.label,"getDisplayType")(e)},N.node.getImagePath=function(e){return N.node.getProperty(e.label,"getImagePath")(e)},N.node.getImageWidth=function(e){return N.node.getProperty(e.label,"getImageWidth")(e)},N.node.getImageHeight=function(e){return N.node.getProperty(e.label,"getImageHeight")(e)},N.node.filterNodeValueQuery=function(e,t){return N.node.getProperty(e.label,"filterNodeValueQuery")(e,t)},N.node.filterNodeCountQuery=function(e,t){return N.node.getProperty(e.label,"filterNodeCountQuery")(e,t)},N.node.filterNodeRelationQuery=function(e,t){return N.node.getProperty(e.label,"filterNodeRelationQuery")(e,t)},N.node.getGenerateNodeValueConstraints=function(e){return N.node.getProperty(e.label,"generateNodeValueConstraints")},N.node.getDisplayResults=function(e){return N.node.getProperty(e,"displayResults")};var l={CYPHER_URL:"http://localhost:7474/db/data/transaction/commit",WITH_CREDENTIALS:!(N.node.DEFAULT_PROVIDER={isSearchable:!0,autoExpandRelations:!1,isAutoLoadValue:!1,returnAttributes:[b.NEO4J_INTERNAL_ID],valueOrderByAttribute:"count",isValueOrderAscending:!1,resultOrderByAttribute:null,isResultOrderAscending:!0,constraintAttribute:b.NEO4J_INTERNAL_ID,displayAttribute:void 0,getPredefinedConstraints:function(){return[]},filterResultQuery:function(e){return e},getDisplayType:function(e){return N.node.DisplayTypes.TEXT},getSize:function(e){return 50},getColor:function(e){if(e.type===O.node.NodeTypes.VALUE&&void 0===e.parentRel)return N.node.getColor(e.parent);e.hasOwnProperty("parent")&&e.parent.label;e.parentRel;var t=e.label;return N.colorScale(t)},getCSSClass:function(e,t){var n=e.label.replace(/[^0-9a-z\-_]/gi,""),r="ppt-node__"+t;return e.type===O.node.NodeTypes.ROOT&&(r+="--root"),e.type===O.node.NodeTypes.CHOOSE&&(r+="--choose"),e.type===O.node.NodeTypes.GROUP&&(r+="--group"),e.type!==O.node.NodeTypes.VALUE&&e.type!==O.node.NodeTypes.HIBIKI||(r+="--value"),void 0!==e.value&&0<e.value.length&&(r+="--value-selected"),e.count,r+" "+n},getIsGroup:function(e){return!1},getIsTextDisplayed:function(e){return!0},getTextValue:function(e,t){var n="",r=N.node.getDisplayAttribute(e.label);if(e.type===O.node.NodeTypes.VALUE||e.type===O.node.NodeTypes.HIBIKI)n=r===b.NEO4J_INTERNAL_ID?""+e.internalID:""+e.attributes[r];else if(void 0!==e.value&&0<e.value.length)if(r===b.NEO4J_INTERNAL_ID){var a="";e.value.forEach(function(e){n+=a+e.internalID,a=" or "})}else{a="";e.value.forEach(function(e){n+=a+e.attributes[r],a=" or "})}else n=e.label;return n},getSemanticValue:function(e){var t="",n=N.node.getDisplayAttribute(e.label);if(e.type===O.node.NodeTypes.VALUE||e.type===O.node.NodeTypes.HIBIKI)t=n===b.NEO4J_INTERNAL_ID?""+e.internalID:""+e.attributes[n];else if(void 0!==e.value&&0<e.value.length)if(n===b.NEO4J_INTERNAL_ID){var r="";e.value.forEach(function(e){t+=r+e.internalID,r=" or "})}else{r="";e.value.forEach(function(e){t+=r+e.attributes[n],r=" or "})}else t=e.label;return t},getImagePath:function(e){return"image/node/"+e.label.toLowerCase()+"/"+e.label.toLowerCase()+".svg"},getSVGPaths:function(e){var t=N.node.getSize(e);return[{d:"M 0, 0 m -"+t+", 0 a "+t+","+t+" 0 1,0 "+2*t+",0 a "+t+","+t+" 0 1,0 -"+2*t+",0",fill:"transparent",stroke:N.node.getColor(e),"stroke-width":"2px"}]},getImageWidth:function(e){return 2*N.node.getSize(e)},getImageHeight:function(e){return 2*N.node.getSize(e)},filterNodeValueQuery:function(e,t){return t},filterNodeCountQuery:function(e,t){return t},filterNodeRelationQuery:function(e,t){return t},displayResults:function(r){var a=r.data()[0];N.node.getReturnAttributes(a.label).forEach(function(e){var t=r.append("div").attr("class","ppt-result-attribute-div"),n=e;b.NEO4J_INTERNAL_ID===e&&(n=b.NEO4J_INTERNAL_ID.queryInternalName),t.append("span").text(function(){return e===b.NEO4J_INTERNAL_ID?"internal ID:":e+":"}),void 0!==a.attributes[n]&&t.append("span").text(function(e){return e.attributes[n]})})}}),post:function(e,t){var n=JSON.stringify(e);p.info("REST POST:"+n);var r={type:"POST",beforeSend:function(e){l.AUTHORIZATION&&e.setRequestHeader("Authorization",l.AUTHORIZATION)},contentType:"application/json"};void 0!==e&&(r.data=n),!0===l.WITH_CREDENTIALS&&(r.xhrFields={withCredentials:!0}),"/interactive"==t&&(r={type:"GET",data:e,dataType:"json",contentType:"application/json"}),"/interactive_info"==t&&(r={type:"GET",data:e,dataType:"html",contentType:"application/json"});var a=l.CYPHER_URL;return void 0!==t&&(a=t),o.ajax(a,r)}};l.response={parse:function(e){p.debug(JSON.stringify(e));var t=[];return void 0!==e&&e.hasOwnProperty("results")&&0<e.results.length&&!(e.hasOwnProperty("errors")&&0<e.errors.length)&&(t=e.results.map(function(e){for(var t=[],n=0;n<e.data.length;n++){for(var r={},a=0;a<e.columns.length;a++)r[e.columns[a]]=e.data[n].row[a];t.push(r)}return t})),p.info(JSON.stringify(t)),t}};var i={};function c(){g();var e=m.getRootNode();e&&e.label}function g(){O.isActive&&(O.link.updateLinks(),O.node.updateNodes(),O.force.nodes(m.nodes),O.force.force("link").links(m.links),O.force.alpha(1).restart())}i.containerId="popoto-info",i.QUERY_STARTER="I'm looking for",i.CHOOSE_LABEL="choose",i.createInfoArea=function(){},i.showInfo=function(e){p.info("Displaying information in viewer"),e.hasOwnProperty("attributes")?l.post("model="+e.label+"&id="+e.attributes.uuid,"/interactive_info").done(function(e){$("#popoto-info").eq(0).html(e)}):void 0!==e.value&&void 0!==e.value[0]&&l.post("model="+e.label+"&id="+e.value[0].attributes.uuid,"/interactive_info").done(function(e){$("#popoto-info").eq(0).html(e)})};var s={containerId:"popoto-taxonomy",createTaxonomyPanel:function(){var e=u.select("#"+s.containerId).append("ul").attr("class","ppt-taxo-ul"),t=s.generateTaxonomiesData(),n=e.selectAll(".taxo").data(t).enter().append("li").attr("id",function(e){return e.id}).attr("class","ppt-taxo-li").attr("value",function(e){return e.label});n.append("span").attr("class",function(e){return"ppt-icon "+N.taxonomy.getCSSClass(e.label,"span-icon")}).html("&nbsp;"),n.append("span").attr("class","ppt-label").text(function(e){return N.taxonomy.getTextValue(e.label)}),n.append("span").attr("class","ppt-count"),n.on("click",s.onClick),s.addTaxonomyChildren(n);var r=[];t.forEach(function(e){r.push(e),e.children&&s.flattenChildren(e,r)}),s.updateCount(r)},flattenChildren:function(e,t){e.children.forEach(function(e){t.push(e),e.children&&t.concat(s.flattenChildren(e,t))})},updateCount:function(e){var t=[];e.forEach(function(e){t.push({statement:b.generateTaxonomyCountQuery(e.label)})}),p.info("Hibiki RestPost TaxoCount "),l.post("type=count","/interactive").done(function(t){for(var n=0;n<t.length;n++)u.selectAll(".ppt-taxo-li").filter(function(e){return e.label===t[n][0]}).select(".ppt-count").text(" ("+t[n][1]+")")})},addTaxonomyChildren:function(e){e.each(function(e){var t=u.select(this),n=e.children;if(e.children){var r=t.append("ul").attr("class","ppt-taxo-sub-ul").selectAll("li").data(n).enter().append("li").attr("id",function(e){return e.id}).attr("class","ppt-taxo-sub-li").attr("value",function(e){return e.label});r.append("span").attr("class",function(e){return"ppt-icon "+N.taxonomy.getCSSClass(e.label,"span-icon")}).html("&nbsp;"),r.append("span").attr("class","ppt-label").text(function(e){return N.taxonomy.getTextValue(e.label)}),r.append("span").attr("class","ppt-count"),r.on("click",s.onClick),s.addTaxonomyChildren(r)}})},onClick:function(){u.event.stopPropagation();var e=this.attributes.value.value;m.nodes.length=0,m.links.length=0,O.node.internalLabels={},c(),O.mainLabel=e,void 0!==N.node.getSchema(e)?O.addSchema(N.node.getSchema(e)):O.addRootNode(e),O.hasGraphChanged=!0,O.ignoreCount=!1,c(),n.center()},generateTaxonomiesData:function(){var t=0,e=[];for(var n in N.node.Provider)N.node.Provider.hasOwnProperty(n)&&N.node.getProperty(n,"isSearchable")&&!N.node.Provider[n].parent&&e.push({label:n,id:"popoto-lbl-"+t++});return e.forEach(function(e){N.node.getProvider(e.label).hasOwnProperty("children")&&(t=s.addChildrenData(e,t))}),e},addChildrenData:function(r,a){return r.children=[],N.node.getProvider(r.label).children.forEach(function(e){var t=N.node.getProvider(e),n={label:e,id:"popoto-lbl-"+a++};t.hasOwnProperty("children")&&(a=s.addChildrenData(n,a)),N.node.getProperty(e,"isSearchable")&&r.children.push(n)}),a}},n={CENTER_GRAPH:!0,RESET_GRAPH:!0,SAVE_GRAPH:!1,TOGGLE_TAXONOMY:!1,TOGGLE_FULL_SCREEN:!0,TOGGLE_VIEW_RELATION:!0,TOGGLE_FIT_TEXT:!0,reset:function(){m.nodes.length=0,m.links.length=0,O.node.internalLabels={},"string"==typeof O.mainLabel||O.mainLabel instanceof String?void 0!==N.node.getSchema(O.mainLabel)?O.addSchema(N.node.getSchema(O.mainLabel)):O.addRootNode(O.mainLabel):O.loadSchema(O.mainLabel),O.hasGraphChanged=!0,result.hasChanged=!0,c(),n.center()},center:function(){O.svgTag.transition().call(O.zoom.transform,u.zoomIdentity)},toggleTaxonomy:function(){var e=u.select("#"+s.containerId);e.filter(".disabled").empty()?e.classed("disabled",!0):e.classed("disabled",!1),O.centerRootNode()},toggleFitText:function(){O.USE_FIT_TEXT=!O.USE_FIT_TEXT,O.node.updateNodes()},toggleViewRelation:function(){O.DISABLE_RELATION=!O.DISABLE_RELATION,u.selectAll(".ppt-g-node-background").classed("hide",O.DISABLE_RELATION),O.tick()},toggleFullScreen:function(){var e=document.getElementById(O.containerId);document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}},r={TOOL_TAXONOMY:"Show/hide taxonomy panel",TOOL_RELATION:"Show/hide relation",TOOL_CENTER:"Center view",TOOL_FULL_SCREEN:"Full screen",TOOL_RESET:"Reset graph",TOOL_SAVE:"Save graph",TOOL_FIT_TEXT:"Fit text in nodes",render:function(e){var t=e.append("div").attr("class","ppt-toolbar");n.TOGGLE_VIEW_RELATION&&t.append("span").attr("id","popoto-toggle-relation").attr("class","ppt-icon ppt-menu relation").attr("title",t.TOOL_RELATION).on("click",function(){n.toggleViewRelation()}),n.RESET_GRAPH&&t.append("span").attr("id","popoto-reset-menu").attr("class","ppt-icon ppt-menu reset").attr("title",t.TOOL_RESET).on("click",function(){O.notifyListeners(O.Events.GRAPH_RESET,[]),n.reset()}),n.TOGGLE_TAXONOMY&&t.append("span").attr("id","popoto-taxonomy-menu").attr("class","ppt-icon ppt-menu taxonomy").attr("title",t.TOOL_TAXONOMY).on("click",n.toggleTaxonomy),n.CENTER_GRAPH&&t.append("span").attr("id","popoto-center-menu").attr("class","ppt-icon ppt-menu center").attr("title",t.TOOL_CENTER).on("click",n.center),n.TOGGLE_FULL_SCREEN&&t.append("span").attr("id","popoto-fullscreen-menu").attr("class","ppt-icon ppt-menu fullscreen").attr("title",t.TOOL_FULL_SCREEN).on("click",n.toggleFullScreen),n.SAVE_GRAPH&&t.append("span").attr("id","popoto-save-menu").attr("class","ppt-icon ppt-menu save").attr("title",t.TOOL_SAVE).on("click",function(){O.notifyListeners(O.Events.GRAPH_SAVE,[O.getSchema()])}),n.TOGGLE_FIT_TEXT&&t.append("span").attr("id","popoto-fit-text-menu").attr("class","ppt-icon ppt-menu fit-text").attr("title",t.TOOL_FIT_TEXT).on("click",n.toggleFitText)}},a={};function f(e){return"function"==typeof e?e:function(){return e}}a.LinkTypes=Object.freeze({RELATION:0,VALUE:1,SEGMENT:2}),a.TEXT_DY=-4,a.SHOW_MARKER=!1,a.gID="popoto-glinks",a.updateLinks=function(){var e=a.updateData();a.removeElements(e.exit()),a.addNewElements(e.enter()),a.updateElements()},a.updateData=function(){return O.svg.select("#"+a.gID).selectAll(".ppt-glink").data(m.links,function(e){return e.id})},a.removeElements=function(e){e.remove()},a.addNewElements=function(e){var t=e.append("g").attr("class","ppt-glink").on("click",a.clickLink).on("mouseover",a.mouseOverLink).on("mouseout",a.mouseOutLink);t.append("path").attr("class","ppt-link"),t.append("text").attr("text-anchor","middle").attr("dy",a.TEXT_DY).append("textPath").attr("class","ppt-textPath").attr("startOffset","50%")},a.updateElements=function(){var e=O.svg.select("#"+a.gID).selectAll(".ppt-glink");e.attr("id",function(e){return"ppt-glink_"+e.id}),e.selectAll(".ppt-link").attr("id",function(e){return"ppt-path_"+e.id}).attr("stroke",function(e){return N.link.getColor(e,"path","stroke")}).attr("class",function(e){return"ppt-link "+N.link.getCSSClass(e,"path")}),e.selectAll("text").attr("id",function(e){return"ppt-text_"+e.id}).attr("class",function(e){return N.link.getCSSClass(e,"text")}).attr("fill",function(e){return N.link.getColor(e,"text","fill")}).selectAll(".ppt-textPath").attr("id",function(e){return"ppt-textpath_"+e.id}).attr("class",function(e){return"ppt-textpath "+N.link.getCSSClass(e,"text-path")}).attr("xlink:href",function(e){return"#ppt-path_"+e.id}).text(function(e){return N.link.getTextValue(e)})},a.mouseOverLink=function(){u.select(this).select("path").attr("class",function(e){return"ppt-link "+N.link.getCSSClass(e,"path--hover")}),u.select(this).select("text").attr("class",function(e){return N.link.getCSSClass(e,"text--hover")});u.select(this).data()[0]},a.mouseOutLink=function(){u.select(this).select("path").attr("class",function(e){return"ppt-link "+N.link.getCSSClass(e,"path")}),u.select(this).select("text").attr("class",function(e){return N.link.getCSSClass(e,"text")});u.select(this).data()[0]},a.clickLink=function(){u.select(this).data()[0].type!==a.LinkTypes.VALUE&&(O.node.collapseAllNode(),O.hasGraphChanged=!0,c())};var d=document.createElement("canvas").getContext("2d"),h=12;function v(e){return d.measureText(e).width}function E(e){if(null==e)return[];var t,n,r=String(e);return function(e,t){for(var n,r=1/0,a=[],o=0,l=e.length;o<l;++o){var i=(n?n.text+" ":"")+e[o],s=v(i);(r+s)/2<t?(n.width=r=s,n.text=i):(n={width:r=v(e[o]),text:e[o]},a.push(n))}return a}(((t=r.split(/\s+/g))[t.length-1]||t.pop(),t[0]||t.shift(),t),(n=r,Math.sqrt(v(n.trim())*h)))}function y(e,t,n,r){var a,o=f(n),l=f(t),i=r?f(r):r;a=i,e.each(function(e){var t=u.select(this).selectAll(".fitted-text").data([{}]);t.enter().append("text").merge(t).attr("class","fitted-text"+(void 0!==a?" "+a(e):"")).attr("style","text-anchor: middle; font: 10px sans-serif")});var s,d=e.select(".fitted-text");s=l,d.each(function(e){var n=E(s(e)),t=u.select(this).selectAll("tspan").data(n);t.exit().remove(),t.enter().append("tspan").merge(t).attr("x",0).attr("y",function(e,t){return(t-n.length/2+.8)*h}).text(function(e){return e.text})}),d.attr("transform",function(e){var t=function(e){for(var t=0,n=0,r=e.length;n<r;++n){var a=e[n].width/2,o=(Math.abs(n-r/2+.5)+.5)*h;t=Math.max(t,Math.sqrt(a*a+o*o))}return t}(E(l(e))),n=1;return 0!==t&&t&&(n=o(e)/t),"translate(0,0) scale("+n+")"})}var A={getNodeBoundingBox:function(e){return e.getBBox()},render:function(e){var t=e.append("rect").attr("fill",function(e){return N.node.getColor(e,"back-text","fill")}).attr("class",function(e){return N.node.getCSSClass(e,"back-text")});y(e,function(e){return N.node.getTextValue(e)},function(e){return N.node.getSize(e)},function(e){return N.node.getCSSClass(e,"text")}),t.attr("x",function(e){return A.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).x-3}).attr("y",function(e){return A.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).y}).attr("rx","5").attr("ry","5").attr("width",function(e){return A.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).width+6}).attr("height",function(e){return A.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).height}).attr("transform",function(e){return u.select(this.parentNode).select("text").attr("transform")})}},R={TEXT_Y:8,getNodeBoundingBox:function(e){return e.getBBox()},render:function(e){var t=e.append("rect").attr("fill",function(e){return N.node.getColor(e,"back-text","fill")}).attr("class",function(e){return N.node.getCSSClass(e,"back-text")});e.append("text").attr("x",0).attr("y",R.TEXT_Y).attr("text-anchor","middle").attr("class",function(e){return N.node.getCSSClass(e,"text")}).text(function(e){return N.node.getTextValue(e)}),t.attr("x",function(e){return R.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).x-3}).attr("y",function(e){return R.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).y}).attr("rx","5").attr("ry","5").attr("width",function(e){return R.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).width+6}).attr("height",function(e){return R.getNodeBoundingBox(u.select(this.parentNode).select("text").node()).height})}},T={gID:"popoto-gnodes",DONUTS_MARGIN:0,DONUT_WIDTH:9,NODE_MAX_CHARS:11,NODE_TITLE_MAX_CHARS:100,PAGE_SIZE:10,CountBox:{x:16,y:33,w:52,h:19},chooseWaiting:!1,getDonutInnerRadius:function(e){return N.node.getSize(e)+T.DONUTS_MARGIN},getDonutOuterRadius:function(e){return N.node.getSize(e)+T.DONUTS_MARGIN+T.DONUT_WIDTH}};T.pie=u.pie().sort(null).value(function(e){return 1}),T.NodeTypes=Object.freeze({ROOT:0,CHOOSE:1,VALUE:2,GROUP:3,HIBIKI:4}),T.internalLabels={},T.generateInternalLabel=function(e){var t=e?e.toLowerCase().replace(/ /g,""):"n";return t in T.internalLabels?(T.internalLabels[t]=T.internalLabels[t]+1,t+T.internalLabels[t]):(T.internalLabels[t]=0,t)},T.updateNodes=function(){var e=T.updateData();T.removeElements(e.exit()),T.addNewElements(e.enter()),T.updateElements()},T.updateData=function(){var e=O.svg.select("#"+T.gID).selectAll(".ppt-gnode").data(m.nodes,function(e){return e.id});return O.hasGraphChanged&&(T.updateAutoLoadValues(),O.DISABLE_COUNT||O.ignoreCount||T.updateCount()),O.hasGraphChanged=!1,e},T.updateCount=function(){void 0!==T.updateCountXhr&&T.updateCountXhr.abort();var n=[],r=m.nodes.filter(function(e){return!(e.type===T.NodeTypes.VALUE||e.type===T.NodeTypes.GROUP||e.hasOwnProperty("isNegative")&&e.isNegative)});r.forEach(function(e){var t=b.generateNodeCountQuery(e);n.push({statement:t.statement,parameters:t.parameters})}),p.info("Count nodes ==>"),T.updateCountXhr=l.post({statements:n}).done(function(e){p.info("<== Count nodes");for(var t=l.response.parse(e),n=0;n<r.length;n++)r[n].count=t[n][0].count;T.updateElements(),O.link.updateElements()}).fail(function(e,t,n){"abort"!==t?(p.error(t+': error while accessing Neo4j server on URL:"'+l.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),r.forEach(function(e){e.count=0}),T.updateElements(),O.link.updateElements()):p.info("<=X= Count nodes - Aborted!")})},T.updateAutoLoadValues=function(){for(var e=[],o=T.getAutoLoadValueNodes(),t=0;t<o.length;t++){var n=o[t],r=b.generateNodeValueQuery(n);e.push({statement:r.statement,parameters:r.parameters})}0<e.length&&(p.info("AutoLoadValue ==>"),l.post({statements:e}).done(function(e){p.info("<== AutoLoadValue");for(var t=l.response.parse(e),n=0;n<o.length;n++){var r=o[n],a=N.node.getConstraintAttribute(r.label);r.data=t[n].filter(function(t){var n=!0;return r.hasOwnProperty("value")&&0<r.value.length&&r.value.forEach(function(e){e.attributes[a]===t[a]&&(n=!1)}),n}),r.page=1}O.notifyListeners(O.Events.GRAPH_NODE_DATA_LOADED,[o])}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+l.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)}))},T.removeElements=function(e){e.filter(function(e){return!e.parent}).remove(),e.filter(function(e){return e.parent}).transition().duration(300).attr("transform",function(e){return"translate("+e.parent.x+","+e.parent.y+")"}).remove()},T.addNewElements=function(e){var t=e.append("g").attr("class","ppt-gnode");t.on("click",T.nodeClick).on("dblclick",T.nodeDblClick),t.filter(function(e){return e.type===T.NodeTypes.VALUE}).on("contextmenu",function(){u.event.preventDefault()}),t.on("contextmenu",function(){u.event.preventDefault()}),t.append("defs").append("clipPath").attr("id",function(e){return"node-view"+e.id}).append("circle").attr("cx",0).attr("cy",0),T.addBackgroundElements(t),T.addMiddlegroundElements(t)},T.addBackgroundElements=function(e){var t=e.append("g").attr("class","ppt-g-node-background").classed("hide",O.DISABLE_RELATION);t.append("g").attr("class","ppt-donut-labels"),t.append("g").attr("class","ppt-donut-segments")},T.addMiddlegroundElements=function(e){e.append("g").attr("class","ppt-g-node-middleground").on("mouseover",O.tip.show).on("mouseout",O.tip.hide)},T.addForegroundElements=function(e){var t=e.append("g").attr("class","ppt-g-node-foreground"),n=t.filter(function(e){return e.type===T.NodeTypes.ROOT||e.type===T.NodeTypes.CHOOSE}).append("g").attr("class","ppt-node-foreground-g-arrows"),r=n.append("g");r.append("circle").attr("class","ppt-larrow").attr("cx","-43").attr("cy","-23").attr("r","17"),r.append("path").attr("class","ppt-arrow").attr("d","m -44.905361,-23 6.742,-6.742 c 0.81,-0.809 0.81,-2.135 0,-2.944 l -0.737,-0.737 c -0.81,-0.811 -2.135,-0.811 -2.945,0 l -8.835,8.835 c -0.435,0.434 -0.628,1.017 -0.597,1.589 -0.031,0.571 0.162,1.154 0.597,1.588 l 8.835,8.834 c 0.81,0.811 2.135,0.811 2.945,0 l 0.737,-0.737 c 0.81,-0.808 0.81,-2.134 0,-2.943 l -6.742,-6.743 z"),r.on("click",function(e){u.event.stopPropagation(),1<e.page&&(e.page--,T.collapseNode(e),T.expandNode(e))});var a=n.append("g");if(a.append("circle").attr("class","ppt-rarrow").attr("cx","43").attr("cy","-23").attr("r","17"),a.append("path").attr("class","ppt-arrow").attr("d","m 51.027875,-24.5875 -8.835,-8.835 c -0.811,-0.811 -2.137,-0.811 -2.945,0 l -0.738,0.737 c -0.81,0.81 -0.81,2.136 0,2.944 l 6.742,6.742 -6.742,6.742 c -0.81,0.81 -0.81,2.136 0,2.943 l 0.737,0.737 c 0.81,0.811 2.136,0.811 2.945,0 l 8.835,-8.836 c 0.435,-0.434 0.628,-1.017 0.597,-1.588 0.032,-0.569 -0.161,-1.152 -0.596,-1.586 z"),a.on("click",function(e){u.event.stopPropagation(),e.page*T.PAGE_SIZE<e.count&&(e.page++,T.collapseNode(e),T.expandNode(e))}),!O.DISABLE_COUNT){var o=t.filter(function(e){return e.type!==T.NodeTypes.GROUP});o.append("rect").attr("x",T.CountBox.x).attr("y",T.CountBox.y).attr("width",T.CountBox.w).attr("height",T.CountBox.h).attr("class","ppt-count-box"),o.append("text").attr("x",42).attr("y",48).attr("text-anchor","middle").attr("class","ppt-count-text")}t.filter(function(e){return e.type===T.NodeTypes.CHOOSE}).append("g").attr("class","ppt-g-node-ban").append("path").attr("d","M89.1 19.2C88 17.7 86.6 16.2 85.2 14.8 83.8 13.4 82.3 12 80.8 10.9 72 3.9 61.3 0 50 0 36.7 0 24.2 5.4 14.8 14.8 5.4 24.2 0 36.7 0 50c0 11.4 3.9 22.1 10.9 30.8 1.2 1.5 2.5 3 3.9 4.4 1.4 1.4 2.9 2.7 4.4 3.9C27.9 96.1 38.6 100 50 100 63.3 100 75.8 94.6 85.2 85.2 94.6 75.8 100 63.3 100 50 100 38.7 96.1 28 89.1 19.2ZM11.9 50c0-10.2 4-19.7 11.1-27C30.3 15.9 39.8 11.9 50 11.9c8.2 0 16 2.6 22.4 7.3L19.3 72.4C14.5 66 11.9 58.2 11.9 50Zm65 27c-7.2 7.1-16.8 11.1-27 11.1-8.2 0-16-2.6-22.4-7.4L80.8 27.6C85.5 34 88.1 41.8 88.1 50c0 10.2-4 19.7-11.1 27z")},T.updateElements=function(){var e=O.svg.select("#"+T.gID).selectAll(".ppt-gnode");e.attr("id",function(e){return"popoto-gnode_"+e.id}),O.USE_VORONOI_LAYOUT&&e.attr("clip-path",function(e){return"url(#voroclip-"+e.id+")"}),e.select("defs").select("clipPath").attr("id",function(e){return"node-view"+e.id}).selectAll("circle").attr("r",function(e){return N.node.getSize(e)}),e.call(u.drag().on("start",function(e){O.tip.hide(),u.event.active||O.force.alphaTarget(.3).restart();e.fx=e.x,e.fy=e.y}).on("drag",function(e){e.fx=u.event.x,e.fy=u.event.y}).on("end",function(e){u.event.active||O.force.alphaTarget(0);!1===e.fixed&&(e.fx=null,e.fy=null)})),T.updateBackgroundElements(),T.updateMiddlegroundElements(),T.updateForegroundElements()},T.updateBackgroundElements=function(){var e=O.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-background");e.select(".ppt-donut-labels").selectAll("*").remove(),e.select(".ppt-donut-segments").selectAll("*").remove();var t=e.select(".ppt-donut-segments").selectAll(".ppt-segment-container").data(function(e){var t=[];return!e.hasOwnProperty("value")&&e.hasOwnProperty("relationships")&&(t=e.relationships),t},function(e){return e.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",T.segmentClick).on("mouseover",function(e){u.select(this).select(".ppt-text-arc").classed("hover",!0)}).on("mouseout",function(e){u.select(this).select(".ppt-text-arc").classed("hover",!1)});t.append("title").attr("class","ppt-svg-title").text(function(e){return e.label+" "+e.target});var n=e.select(".ppt-donut-segments").selectAll(".ppt-segment-container").data(function(e){var t=[];return!e.hasOwnProperty("value")&&e.hasOwnProperty("relationships")||(t=[{id:e.label,directionAngle:Math.PI,endAngle:2*Math.PI,startAngle:0}]),t},function(e){return e.id}).enter().append("g").attr("class",".ppt-segment-container");e.select(".ppt-donut-labels").selectAll(".ppt-segment-container").data(function(e){var t=[];return!e.hasOwnProperty("value")&&e.hasOwnProperty("relationships")&&(t=e.relationships),t},function(e){return e.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",T.segmentClick).on("mouseover",function(e){u.select(this).select(".ppt-text-arc").classed("hover",!0)}).on("mouseout",function(e){u.select(this).select(".ppt-text-arc").classed("hover",!1)}).append("path").attr("class","ppt-hidden-arc").attr("id",function(e,t){return"arc_"+u.select(this.parentNode.parentNode).datum().id+"_"+t}).attr("d",function(e){var t=u.select(this.parentNode.parentNode).datum(),n={startAngle:e.directionAngle-(Math.PI-.1),endAngle:e.directionAngle+(Math.PI-.1)},r=u.arc().innerRadius(T.getDonutInnerRadius(t)).outerRadius(T.getDonutOuterRadius(t))(n),a=/(^.+?)L/.exec(r);return(a&&1<a.length?a[1]:/(^.+?)M/.exec(r)[1]).replace(/,/g," ")}).style("fill","none").style("stroke","none"),t.append("text").attr("text-anchor","middle").attr("class",function(e){var t=u.select(this.parentNode.parentNode).datum();return t.hasOwnProperty("count")&&0===t.count?"ppt-text-arc disabled":"ppt-text-arc"}).attr("fill",function(e){var t=u.select(this.parentNode.parentNode).datum();return N.link.getColor({label:e.label,type:O.link.LinkTypes.SEGMENT,source:t,target:{label:e.target}},"segment","fill")}).attr("dy",O.link.TEXT_DY).append("textPath").attr("startOffset","50%").attr("xlink:href",function(e,t){return"#arc_"+u.select(this.parentNode.parentNode.parentNode).datum().id+"_"+t}).text(function(e){var t=u.select(this.parentNode.parentNode.parentNode).datum();return N.link.getTextValue({source:t,target:{label:e.target},label:e.label,type:O.link.LinkTypes.SEGMENT})}),t.append("path").attr("class",function(e){var t=u.select(this.parentNode.parentNode).datum();return t.hasOwnProperty("count")&&0===t.count?"ppt-segment disabled":"ppt-segment"}).attr("d",function(e){var t=u.select(this.parentNode.parentNode).datum();return u.arc().innerRadius(T.getDonutInnerRadius(t)).outerRadius(T.getDonutOuterRadius(t))(e)}).attr("fill",function(e){var t=u.select(this.parentNode.parentNode).datum();return N.link.getColor({label:e.label,type:O.link.LinkTypes.RELATION,source:t,target:{label:e.target}},"path","fill")}).attr("stroke",function(e){var t=u.select(this.parentNode.parentNode).datum();return N.link.getColor({label:e.label,type:O.link.LinkTypes.RELATION,source:t,target:{label:e.target}},"path","stroke")}),n.append("path").attr("class","ppt-segment").attr("d",function(e){var t=u.select(this.parentNode.parentNode).datum();return u.arc().innerRadius(T.getDonutInnerRadius(t)).outerRadius(T.getDonutOuterRadius(t))(e)}).attr("fill",function(e){var t=u.select(this.parentNode.parentNode).datum();return N.link.getColor({type:O.link.LinkTypes.RELATION,target:{label:t.label}},"path","fill")}).attr("stroke",function(e){var t=u.select(this.parentNode.parentNode).datum();return N.link.getColor({label:e.label,type:O.link.LinkTypes.RELATION,source:t,target:{label:e.target}},"path","stroke")})},T.updateMiddlegroundElements=function(){var e=O.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-middleground");e.attr("clip-path",function(e){return"url(#node-view"+e.id+")"}),e.selectAll("*").remove(),T.updateMiddlegroundElementsTooltip(e),T.updateMiddlegroundElementsText(e.filter(function(e){return N.node.getNodeDisplayType(e)===N.node.DisplayTypes.TEXT})),T.updateMiddlegroundElementsImage(e.filter(function(e){return N.node.getNodeDisplayType(e)===N.node.DisplayTypes.IMAGE})),T.updateMiddlegroundElementsSymbol(e.filter(function(e){return N.node.getNodeDisplayType(e)===N.node.DisplayTypes.SYMBOL})),T.updateMiddlegroundElementsSVG(e.filter(function(e){return N.node.getNodeDisplayType(e)===N.node.DisplayTypes.SVG})),T.updateMiddlegroundElementsDisplayedText(e.filter(function(e){return N.node.isTextDisplayed(e)}))},T.updateMiddlegroundElementsTooltip=function(e){e.append("title").attr("class",function(e){return N.node.getCSSClass(e,"title")}).text(function(e){return N.node.getTextValue(e,T.NODE_TITLE_MAX_CHARS)})},T.updateMiddlegroundElementsText=function(e){e.append("circle").attr("r",function(e){return N.node.getSize(e)}).attr("class",function(e){return N.node.getCSSClass(e,"circle")}).attr("fill",function(e){return N.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return N.node.getColor(e,"circle","stroke")})},T.updateMiddlegroundElementsImage=function(e){T.updateMiddlegroundElementsText(e.filter(function(e){return e.hasOwnProperty("attributes")?null==e.attributes.image_path:!e.hasOwnProperty("value")||null==e.value[0].attributes.image_path}));var t=e.filter(function(e){return e.hasOwnProperty("attributes")?null!=e.attributes.image_path:!!e.hasOwnProperty("value")&&null!=e.value[0].attributes.image_path});t.append("circle").attr("r",function(e){return N.node.getSize(e)}).attr("class",function(e){return N.node.getCSSClass(e,"image-background-circle")}).attr("fill",function(e){return N.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return N.node.getColor(e,"circle","stroke")}),t.append("image").attr("title",function(e){return e.hasOwnProperty("value")?e.value[0].attributes.name:e.hasOwnProperty("attributes")?e.attributes.name:N.node.getCSSClass(e,"image")}).attr("width",function(e){return N.node.getImageWidth(e)}).attr("height",function(e){return N.node.getImageHeight(e)}).attr("transform",function(e){return"translate("+-N.node.getImageWidth(e)/2+","+-N.node.getImageHeight(e)/2+")"}).attr("xlink:href",function(e){return e.hasOwnProperty("attributes")?"http://www.hibiki.moe/images/"+e.attributes.image_path:e.hasOwnProperty("value")?"http://www.hibiki.moe/images/"+e.value[0].attributes.image_path:N.node.getImagePath(e)})},T.updateMiddlegroundElementsSymbol=function(e){e.append("circle").attr("r",function(e){return N.node.getSize(e)}).attr("class",function(e){return N.node.getCSSClass(e,"symbol-background-circle")}).attr("fill",function(e){return N.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return N.node.getColor(e,"circle","stroke")}),e.append("use").attr("class",function(e){return N.node.getCSSClass(e,"symbol")}).attr("width",function(e){return N.node.getImageWidth(e)}).attr("height",function(e){return N.node.getImageHeight(e)}).attr("transform",function(e){return"translate("+-N.node.getImageWidth(e)/2+","+-N.node.getImageHeight(e)/2+")"}).attr("xlink:href",function(e){return N.node.getImagePath(e)}).attr("fill",function(e){return N.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return N.node.getColor(e,"circle","stroke")})},T.updateMiddlegroundElementsSVG=function(e){var t=e.append("g"),n=(t.append("circle").attr("r",function(e){return N.node.getSize(e)}).attr("class","ppt-svg-node-background"),t.selectAll("path").data(function(e){return N.node.getSVGPaths(e)}));n.exit().remove(),n.enter().append("path"),t.selectAll("path").attr("class",function(e){var t=u.select(this.parentNode).datum();return N.node.getCSSClass(t,"path")}).each(function(e,t){for(var n in e)e.hasOwnProperty(n)&&u.select(this).attr(n,e[n])})},T.updateMiddlegroundElementsDisplayedText=function(e){var t=e.filter(function(e){return e.hasOwnProperty("attributes")?null==e.attributes.image_path:!e.hasOwnProperty("value")||null==e.value[0].attributes.image_path});O.USE_FIT_TEXT?A.render(t):R.render(t)},T.updateForegroundElements=function(){var e=O.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-node-foreground-g-arrows");e.classed("active",function(e){return e.valueExpanded&&e.data&&e.data.length>T.PAGE_SIZE}),e.selectAll(".ppt-larrow").classed("enabled",function(e){return 1<e.page}),e.selectAll(".ppt-rarrow").classed("enabled",function(e){if(e.data){var t=e.data.length;return e.page*T.PAGE_SIZE<t}return!1});var t=O.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground");t.selectAll(".ppt-count-box").filter(function(e){return e.type!==T.NodeTypes.CHOOSE}).classed("root",!0),t.selectAll(".ppt-count-box").filter(function(e){return e.type===T.NodeTypes.CHOOSE}).classed("value",!0),t.selectAll(".ppt-count-box").classed("disabled",function(e){return 0===e.count}),O.DISABLE_COUNT||t.selectAll(".ppt-count-text").text(function(e){return null!==e.count?e.count:"..."}).classed("disabled",function(e){return 0===e.count}),O.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").filter(function(e){return!0===e.isNegative}).selectAll(".ppt-g-node-ban").attr("transform",function(e){return"translate("+-N.node.getSize(e)+","+-N.node.getSize(e)+") scale("+2*N.node.getSize(e)/100+")"}).attr("stroke-width",function(e){return 2/(2*N.node.getSize(e)/100)+"px"}),O.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-g-node-ban").classed("active",function(e){return!0===e.isNegative})},T.segmentClick=function(e){u.event.preventDefault();var t=u.select(this.parentNode.parentNode).datum();O.ignoreCount=!0,O.addRelationshipData(t,e,function(t){O.notifyListeners(O.Events.GRAPH_NODE_RELATION_ADD,[m.links.filter(function(e){return e.target===t})]),O.ignoreCount=!1,O.hasGraphChanged=!0,c()})},T.mouseOverNode=function(){u.event.preventDefault();var e=u.select(this).data()[0];i.isActive&&(p.info("Hovered! infoviewer changed! node:"),p.info(e))},T.mouseOutNode=function(){u.event.preventDefault();u.select(this).data()[0]},T.nodeDblClick=function(){p.info("Hibiki: Double Click")},T.nodeClick=function(){if(!u.event.defaultPrevented){var e=u.select(this).data()[0];if(e.type===T.NodeTypes.VALUE)T.valueNodeClick(e);else if(e.type===T.NodeTypes.HIBIKI)T.HibikiNodeClick(e);else if(e.type===T.NodeTypes.CHOOSE||e.type===T.NodeTypes.ROOT)if(p.debug("NonHibikiNodeClick ("+e.label+")"),u.event.ctrlKey){if(e.type===T.NodeTypes.CHOOSE){if(e.isNegative=!e.hasOwnProperty("isNegative")||!e.isNegative,T.collapseAllNode(),e.hasOwnProperty("value")&&0<e.value.length);else if(e.isNegative){for(var t=m.links.length-1;0<=t;t--)m.links[t].source===e&&T.removeNode(m.links[t].target);e.count=0}O.hasGraphChanged=!0,c()}}else e.valueExpanded&&!e.hasOwnProperty("value")?T.collapseNode(e):T.chooseNodeClick(e)}},T.collapseNode=function(t){if(t.valueExpanded){p.debug("collapseNode ("+t.label+")"),O.notifyListeners(O.Events.GRAPH_NODE_VALUE_COLLAPSE,[t]);var e=m.links.filter(function(e){return e.source===t&&e.type===O.link.LinkTypes.VALUE});e.forEach(function(e){m.nodes.splice(m.nodes.indexOf(e.target),1)});for(var n=m.links.length-1;0<=n;n--)0<=e.indexOf(m.links[n])&&m.links.splice(n,1);t.type!==T.NodeTypes.ROOT&&(t.fixed=!1,t.fx=null,t.fy=null),t.parent&&t.parent.type!==T.NodeTypes.ROOT&&(t.parent.fixed=!1,t.parent.fx=null,t.parent.fy=null),t.valueExpanded=!1,c()}else p.debug("collapseNode called on an unexpanded node")},T.collapseAllNode=function(){m.nodes.forEach(function(e){e.type!==T.NodeTypes.CHOOSE&&e.type!==T.NodeTypes.ROOT||!e.valueExpanded||T.collapseNode(e)})},T.valueNodeClick=function(t){p.debug("valueNodeClick ("+t.label+")"),O.notifyListeners(O.Events.GRAPH_NODE_ADD_VALUE,[t]),void 0===t.parent.value&&void 0===t.parent.attributes?(t.parent.value=[],t.parent.value.push(t)):l.post("model="+t.label+"&id="+t.attributes.uuid+"&type=record","/interactive").done(function(e){p.info(e),t.data=e,t.page=1,T.expandNodeHibiki(t),T.chooseWaiting=!1}).fail(function(e,t,n){T.chooseWaiting=!1,p.error(t+': error while accessing Hibiki server on URL:"'+l.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)}),O.hasGraphChanged=!0,T.collapseNode(t.parent)},T.HibikiNodeClick=function(t){p.debug("HibikiNodeClick ("+t.label+")"),i.showInfo(t),O.notifyListeners(O.Events.GRAPH_NODE_ADD_VALUE,[t]),void 0===t.parent.value&&void 0===t.parent.attributes?(t.parent.value=[],t.parent.value.push(t),T.collapseNode(t.parent),t.parent.data=[],t.parent.page=0):(p.info("HibikiNode rest post for label:"+t.label+", "+t.attributes.uuid),l.post("model="+t.label+"&id="+t.attributes.uuid+"&type=record&page="+(t.page+1),"/interactive").done(function(e){p.info(e),t.hasOwnProperty("data")?t.data=t.data.concat(e):t.data=e,t.hasOwnProperty("page")?t.page+=1:t.page=1,T.expandNodeHibiki(t),T.chooseWaiting=!1}).fail(function(e,t,n){T.chooseWaiting=!1,p.error(t+': error while accessing Hibiki server on URL:"'+l.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)})),O.hasGraphChanged=!0},T.chooseNodeClick=function(t){p.debug("chooseNodeClick ("+t.label+") with waiting state set to "+T.chooseWaiting),T.chooseWaiting||t.immutable||0===t.count||(T.collapseAllNode(),T.chooseWaiting=!0,void 0!==t.data&&t.isAutoLoadValue?(t.page=1,T.expandNode(t),T.chooseWaiting=!1):void 0!==t.value&&void 0!==t.value[0]?(i.showInfo(t),p.info("chooseNode rest post for ("+t.label+"):"),l.post("model="+t.label+"&id="+t.value[0].attributes.uuid+"&type=record&page="+(t.page+1),"/interactive").done(function(e){p.info(e),t.hasOwnProperty("data")?t.data=t.data.concat(e):t.data=e,t.hasOwnProperty("page")?t.page+=1:t.page=1,T.expandNodeHibiki(t),T.chooseWaiting=!1}).fail(function(e,t,n){T.chooseWaiting=!1,p.error(t+': error while accessing Hibiki server on URL:"'+l.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)})):(p.info("Model rest post for ("+t.label+"):"),l.post("model="+t.label+"&type=model","/interactive").done(function(e){p.info("<== Values ("+t.label+")"),t.data=e,t.page=1,T.expandNode(t),T.chooseWaiting=!1}).fail(function(e,t,n){T.chooseWaiting=!1,p.error(t+': error while accessing Neo4j server on URL:"'+l.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)})))},T.addExpandedValue=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].valueExpanded){for(var a=m.nodes[r].data.length-1;0<=a;a--)m.nodes[r].data[a][e]===t&&(n=!0,m.nodes[r].hasOwnProperty("value")||(m.nodes[r].value=[]),m.nodes[r].value.push({attributes:m.nodes[r].data[a]}),m.nodes[r].data.splice(a,1));T.collapseNode(m.nodes[r]),T.expandNode(m.nodes[r])}n&&(O.hasGraphChanged=!0,c())},T.getContainingValue=function(n){var r=[],e=m.links,t=m.nodes;if(0<t.length){var a=t[0];void 0!==a.value&&0<a.value.length&&(void 0!==n&&n!==a.label||r.push(a)),e.forEach(function(e){var t=e.target;e.type===O.link.LinkTypes.RELATION&&void 0!==t.value&&0<t.value.length&&(void 0!==n&&n!==t.label||r.push(t))})}return r},T.addValueForLabel=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].type===T.NodeTypes.CHOOSE&&m.nodes[r].label===e){m.nodes[r].hasOwnProperty("value")||(m.nodes[r].value=[]);var a=!1,o=N.node.getConstraintAttribute(e);m.nodes[r].value.forEach(function(e){e.attributes.hasOwnProperty(o)&&e.attributes[o]===t.attributes[o]&&(a=!0)}),a||(m.nodes[r].value.push(t),n=!0)}return n},T.addValue=function(e,t){for(var n=!1,r=0;r<m.nodes.length;r++){var a=m.nodes[r];if(0<=e.indexOf(a.id)){a.hasOwnProperty("value")||(a.value=[]);var o=N.node.getReturnAttributes(a.label)[0];a.data.forEach(function(e){e.hasOwnProperty(o)&&e[o]===t&&(n=!0,a.value.push({attributes:e}))})}}n&&(O.hasGraphChanged=!0,c())},T.removeValue=function(e,t){var n=!1;T.collapseNode(e);for(var r=e.value.length-1;0<=r;r--)e.value[r]===t&&(e.value.splice(r,1),n=!0);return n},T.removeValues=function(e){var t=!1;return T.collapseNode(e),void 0!==e.value&&0<e.value.length&&(t=!(e.value.length=0)),t},T.getValue=function(e,t){for(var n=0;n<m.nodes.length;n++){var r=m.nodes[n];if(r.id===e)for(var a=N.node.getConstraintAttribute(r.label),o=r.value.length-1;0<=o;o--)if(r.value[o].attributes[a]===t)return r.value[o]}},T.removeExpandedValue=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].valueExpanded){for(var a=[],o=m.nodes[r].value.length-1;0<=o;o--)m.nodes[r].value[o].attributes[e]===t&&(n=!0,a=a.concat(m.nodes[r].value.splice(o,1)));for(var l=0;l<a.length;l++)m.nodes[r].data.push(a[l].attributes);T.collapseNode(m.nodes[r]),T.expandNode(m.nodes[r])}n&&(O.hasGraphChanged=!0,c())},T.getAutoLoadValueNodes=function(){return m.nodes.filter(function(e){return e.hasOwnProperty("isAutoLoadValue")&&!0===e.isAutoLoadValue&&!(!0===e.isNegative)})},T.addRelatedValues=function(d,e,u){var t=T.filterExistingValues(d,e);if(!(t.length<=0)){var o=[];t.forEach(function(e){var t=N.node.getConstraintAttribute(e.label),n="MATCH ";t===b.NEO4J_INTERNAL_ID?n+="(v:`"+e.label+"`) WHERE (ID(v) = $p)":n+="(v:`"+e.label+"`) WHERE (v."+t+" = $p)";var r=N.node.getReturnAttributes(e.label),a="";n+=' RETURN DISTINCT "'+e.rel+'" AS rel, "'+e.label+'" AS label, {'+r.reduce(function(e,t){return e+=a+t+":v."+t,a=", ",e},"")+"} AS value LIMIT 1",o.push({statement:n,parameters:{p:e.id},resultDataContents:["row"]})}),p.info("addRelatedValues ==>"),l.post({statements:o}).done(function(e){p.info("<== addRelatedValues");var i=l.response.parse(e),s=0;i.forEach(function(e){if(0<e.length){var t=e[0].label,n=e[0].value,r=e[0].rel,a={id:m.generateId(),parent:d,attributes:n,type:T.NodeTypes.VALUE,label:t};O.ignoreCount=!0;var o=d.relationships.filter(function(e){return e.label===r&&e.target===t}),l={label:r,target:t};0<o.length&&(l=o[0]),O.addRelationshipData(d,l,function(){++s===i.length&&(O.ignoreCount=!1,O.hasGraphChanged=!0,c())},[a],u)}})}).fail(function(e,t,n){console.error(e,t,n)})}},T.addRelatedBranch=function(e,t,n,r){if(0<t.length){var a=t[0];t=t.slice(1);var o=e.relationships.filter(function(e){return e.label===a.type&&e.target===a.target});0<o.length&&O.addRelationshipData(e,o[0],function(e){T.addRelatedBranch(e,t,n,r)})}else T.addRelatedValues(e,n,r)},T.filterExistingValues=function(e,t){var a=[],o=m.nodes.filter(function(e){return e.parent===e&&e.hasOwnProperty("value")&&0<e.value.length});return t.forEach(function(t){var n=!1,r=N.node.getConstraintAttribute(t.label);o.forEach(function(e){e.label===t.label&&e.value.forEach(function(e){e.attributes[r]===t.id&&(n=!0)})}),n||a.push(t)}),a},T.expandNodeHibiki=function(l){O.notifyListeners(O.Events.GRAPH_NODE_VALUE_EXPAND,[l]);var e=l.page*T.PAGE_SIZE,t=e-T.PAGE_SIZE,i=l.data.slice(t,e),s=O.computeParentAngle(l),d=1;i.forEach(function(e){var t;t=l.parent?360/(i.length+1)*d:360/i.length*d;var n=l.x+100*Math.cos(t*(Math.PI/180)-s),r=l.y+100*Math.sin(t*(Math.PI/180)-s),a=m.inDataNodes(e.label,e.uuid);if(0<a.length){p.info("Hibiki(7) Existing Data node!: count: "+a.length),0==m.inDataLinks(a[0].id,l.id).length&&m.links.push({id:"l"+m.generateId(),source:l,target:a[0],type:O.link.LinkTypes.RELATION,label:e.type})}else{var o={id:m.generateId(),parent:l,attributes:e,type:T.NodeTypes.HIBIKI,label:e.label,count:e.count,rel_count:e.count,parentRel:e.type,x:n,y:r,internalID:e[b.NEO4J_INTERNAL_ID.queryInternalName]};m.nodes.push(o),m.links.push({id:"l"+m.generateId(),source:l,target:o,type:O.link.LinkTypes.RELATION,label:e.type})}d++}),p.info(m.nodes),p.info(m.links),l.fixed=!0,l.fx=l.x,l.fy=l.y,l.parent&&l.parent.type!==T.NodeTypes.ROOT&&(l.parent.fixed=!0,l.parent.fx=l.parent.x,l.parent.fy=l.parent.y),l.valueExpanded=!0,c()},T.expandNode=function(o){O.notifyListeners(O.Events.GRAPH_NODE_VALUE_EXPAND,[o]);var e=o.page*T.PAGE_SIZE,t=e-T.PAGE_SIZE,l=o.data.slice(t,e),i=O.computeParentAngle(o),s=1;p.info("Hibiki: Expand Node"),l.forEach(function(e){var t;t=o.parent?360/(l.length+1)*s:360/l.length*s;var n=o.x+100*Math.cos(t*(Math.PI/180)-i),r=o.y+100*Math.sin(t*(Math.PI/180)-i),a={id:m.generateId(),parent:o,attributes:e,type:T.NodeTypes.HIBIKI,label:o.label,count:e.count,rel_count:e.count,x:n,y:r,internalID:e[b.NEO4J_INTERNAL_ID.queryInternalName]};m.nodes.push(a),m.links.push({id:"l"+m.generateId(),source:o,target:a,type:O.link.LinkTypes.VALUE}),s++}),o.fixed=!0,o.fx=o.x,o.fy=o.y,o.parent&&o.parent.type!==T.NodeTypes.ROOT&&(o.parent.fixed=!0,o.parent.fx=o.parent.x,o.parent.fy=o.parent.y),o.valueExpanded=!0,c()},T.loadRelationshipData=function(n,r,a){var e=N.node.getSchema(n.label);if(void 0!==e)e.hasOwnProperty("rel")&&0<e.rel.length?r(T.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(e.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})):r([]);else{var t=b.generateNodeRelationQuery(n);p.info("Relations ("+n.label+") ==>"),l.post({statements:[{statement:t.statement,parameters:t.parameters}]}).done(function(e){p.info("<== Relations ("+n.label+")");var t=l.response.parse(e)[0].filter(function(e){return b.filterRelation(e)});t=T.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(t).map(function(e){return{id:e.data.label+e.data.target,label:e.data.label,target:e.data.target,count:e.data.count,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2}}),r(t)}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+l.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),r([])})}},T.expandRelationships=function(e,t){var n=0;if(e.hasOwnProperty("relationships")&&0<e.relationships.length)for(var r=0;r<e.relationships.length;r++)O.addRelationshipData(e,e.relationships[r],function(){++n===e.relationships.length&&t()});else t()},T.removeNode=function(t){var n=t.hasOwnProperty("value")&&0<t.value.length;m.links.filter(function(e){return e.source===t}).forEach(function(e){var t=T.removeNode(e.target);n=n||t});for(var e=m.links.length-1;0<=e;e--)m.links[e].target===t&&m.links.splice(e,1);return m.nodes.splice(m.nodes.indexOf(t),1),n},T.clearSelection=function(){u.event.preventDefault();var e=u.select(this).data()[0];if(T.collapseAllNode(),void 0!==e.value&&0<e.value.length&&!e.immutable){if(e.value.pop(),!0===e.isNegative&&0===e.value.length){for(var t=m.links.length-1;0<=t;t--)m.links[t].source===e&&T.removeNode(m.links[t].target);e.count=0}O.hasGraphChanged=!0,c()}};var O={};O.link=a,O.node=T,O.DISABLE_RELATION=!1,O.DISABLE_COUNT=!0,O.containerId="popoto-graph",O.hasGraphChanged=!0,O.zoom=u.zoom().scaleExtent([.1,10]),O.WHEEL_ZOOM_ENABLED=!0,O.USE_DONUT_FORCE=!1,O.USE_VORONOI_LAYOUT=!1,O.USE_FIT_TEXT=!1,O.Events=Object.freeze({NODE_ROOT_ADD:"root.node.add",NODE_EXPAND_RELATIONSHIP:"node.expandRelationship",GRAPH_SAVE:"graph.save",GRAPH_RESET:"graph.reset",GRAPH_NODE_RELATION_ADD:"graph.node.relation_add",GRAPH_NODE_VALUE_EXPAND:"graph.node.value_expand",GRAPH_NODE_VALUE_COLLAPSE:"graph.node.value_collapse",GRAPH_NODE_ADD_VALUE:"graph.node.add_value",GRAPH_NODE_DATA_LOADED:"graph.node.data_loaded"}),O.listeners={},O.on=function(e,t){O.listeners.hasOwnProperty(e)||(O.listeners[e]=[]),O.listeners[e].push(t)},O.notifyListeners=function(t,n){O.listeners.hasOwnProperty(t)&&O.listeners[t].forEach(function(e){e.apply(t,n)})},O.onSave=function(e){O.on(O.Events.GRAPH_SAVE,e)},O.onReset=function(e){O.on(O.Events.GRAPH_RESET,e)},O.setDefaultGraph=function(e){e.mainLabel=e},O.tip=function(){var d=function(){return"n"},u=function(){return[0,0]},p=function(){return" "},n=e(),r=null,s=null,c=null;function g(e){var t;r="svg"===(t=(t=e).node()).tagName.toLowerCase()?t:t.ownerSVGElement,s=r.createSVGPoint(),document.body.appendChild(n)}g.show=function(){var e=Array.prototype.slice.call(arguments);e[e.length-1]instanceof SVGElement&&(c=e.pop());var t,n=p.apply(this,e),r=u.apply(this,e),a=d.apply(this,e),o=v(),l=h.length,i=document.documentElement.scrollTop||document.body.scrollTop,s=document.documentElement.scrollLeft||document.body.scrollLeft;for(o.html(n).style("position","absolute").style("opacity",1).style("pointer-events","all"),c=this.childNodes[1];l--;)o.classed(h[l],!1);return t=f[a].apply(this),o.classed(a,!0).style("top",t.top+r[0]+i+"px").style("left",t.left+r[1]+s+"px"),g},g.hide=function(){return v().style("opacity",0).style("pointer-events","none"),g},g.attr=function(e,t){if(arguments.length<2&&"string"==typeof e)return v().attr(e);var n=Array.prototype.slice.call(arguments);return d3.selection.prototype.attr.apply(v(),n),g},g.style=function(e,t){if(arguments.length<2&&"string"==typeof e)return v().style(e);var n=Array.prototype.slice.call(arguments);if(1===n.length){var r=n[0];Object.keys(r).forEach(function(e){return d3.selection.prototype.style.apply(v(),[e,r[e]])})}return g},g.direction=function(e){return arguments.length?(d=null==e?e:d3.functor(e),g):d},g.offset=function(e){return arguments.length?(u=null==e?e:d3.functor(e),g):u},g.html=function(e){return arguments.length?(p=null==e?e:d3.functor(e),g):p},g.destroy=function(){return n&&(v().remove(),n=null),g};var f={n:function(){var e=t();return{top:e.n.y-n.offsetHeight,left:e.n.x-n.offsetWidth/2}},s:function(){var e=t();return{top:e.s.y,left:e.s.x-n.offsetWidth/2}},e:function(){var e=t();return{top:e.e.y-n.offsetHeight/2,left:e.e.x}},w:function(){var e=t();return{top:e.w.y-n.offsetHeight/2,left:e.w.x-n.offsetWidth}},nw:function(){var e=t();return{top:e.nw.y-n.offsetHeight,left:e.nw.x-n.offsetWidth}},ne:function(){var e=t();return{top:e.ne.y-n.offsetHeight,left:e.ne.x}},sw:function(){var e=t();return{top:e.sw.y,left:e.sw.x-n.offsetWidth}},se:function(){var e=t();return{top:e.se.y,left:e.e.x}}},h=Object.keys(f);function e(){var e=d3.select(document.createElement("div"));return e.style("position","absolute").style("top","0").style("opacity","0").style("pointer-events","none").style("box-sizing","border-box"),e.node()}function v(){return null===n&&(n=e(),document.body.appendChild(n)),d3.select(n)}function t(){for(var e=c||d3.event.target;void 0===e.getScreenCTM&&"undefined"===e.parentNode;)e=e.parentNode;var t={},n=e.getScreenCTM(),r=e.getBBox(),a=r.width,o=r.height,l=r.x,i=r.y;return s.x=l,s.y=i,t.nw=s.matrixTransform(n),s.x+=a,t.ne=s.matrixTransform(n),s.y+=o,t.se=s.matrixTransform(n),s.x-=a,t.sw=s.matrixTransform(n),s.y-=o/2,t.w=s.matrixTransform(n),s.x+=a,t.e=s.matrixTransform(n),s.x-=a/2,s.y-=o/2,t.n=s.matrixTransform(n),s.y+=o,t.s=s.matrixTransform(n),t}return g}().attr("class","d3-tip").offset([-14,0]).html(function(e){return e.hasOwnProperty("value")||e.hasOwnProperty("attributes")?O.generateTipInfo(e):null}),O.generateTipInfo=function(t){var e=t;t.hasOwnProperty("value")&&(e=t.value[0]);var n=m.links.filter(function(e){return t.id==e.source.id||t.id==e.target.id}).length;return e.attributes.name+"</br>"+(e.rel_count-n)+" more links (total: "+e.rel_count+")"},O.createGraphArea=function(){var e=u.select("#"+O.containerId);r.render(e),O.svgTag=e.append("svg").attr("class","ppt-svg-graph").call(O.zoom.on("zoom",O.rescale)),O.svgTag.on("dblclick.zoom",null),O.WHEEL_ZOOM_ENABLED||O.svgTag.on("wheel.zoom",null).on("mousewheel.zoom",null),O.svgdefs=O.svgTag.append("defs"),O.svgdefs.append("marker").attr("id","cross").attr("refX",10).attr("refY",10).attr("markerWidth",20).attr("markerHeight",20).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-cross").attr("d","M5,5 L15,15 M15,5 L5,15"),O.svgdefs.append("marker").attr("id","arrow").attr("refX",9).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-arrow").attr("d","M0,0 L0,6 L9,3 z"),O.svgdefs.append("marker").attr("id","reverse-arrow").attr("refX",0).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-reverse-arrow").attr("d","M0,3 L9,6 L9,0 z"),O.svgdefs.append("filter").attr("id","grayscale").append("feColorMatrix").attr("type","saturate").attr("values","0");var t=O.svgdefs.append("filter").attr("id","gooey");t.append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","10").attr("color-interpolation-filters","sRGB").attr("result","blur"),t.append("feColorMatrix").attr("class","blurValues").attr("in","blur").attr("mode","matrix").attr("values","1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 35 -6").attr("result","gooey"),t.append("feBlend").attr("in","SourceGraphic").attr("in2","gooey").attr("operator","atop"),O.svgdefs.append("g").attr("id","voronoi-clip-path"),O.svg=O.svgTag.append("svg:g"),O.svg.append("g").attr("id",O.link.gID),O.svg.append("g").attr("id",O.node.gID),O.svgTag.call(O.tip),window.addEventListener("resize",O.centerRootNode)},O.getRootNode=function(){return m.getRootNode()},O.centerRootNode=function(){m.getRootNode().fx=O.getSVGWidth()/2,m.getRootNode().fy=O.getSVGHeight()/2,c()},O.getSVGWidth=function(){return void 0===O.svg||O.svg.empty()?(p.debug("graph.svg is undefined or empty."),0):document.getElementById(O.containerId).clientWidth},O.getSVGHeight=function(){return void 0===O.svg||O.svg.empty()?(p.debug("graph.svg is undefined or empty."),0):document.getElementById(O.containerId).clientHeight},O.rescale=function(){O.svg.attr("transform",u.event.transform)},O.CHARGE=-500,O.createForceLayout=function(){O.force=u.forceSimulation().force("charge",u.forceManyBody().strength(function(e){return e.charge?e.charge:O.CHARGE})).force("link",u.forceLink().id(function(e){return e.id}).distance(N.link.getDistance)),O.force.nodes(m.nodes),O.force.force("link").links(m.links),O.force.on("tick",O.tick)},O.addRootNode=function(t){if(0<m.nodes.length&&p.warn("graph.addRootNode is called but the graph is not empty."),void 0!==N.node.getSchema(t))O.addSchema(N.node.getSchema(t));else{var n={id:m.generateId(),type:O.node.NodeTypes.ROOT,x:O.getSVGWidth()/2,y:O.getSVGHeight()/2,fx:O.getSVGWidth()/2,fy:O.getSVGHeight()/2,tx:O.getSVGWidth()/2,ty:O.getSVGHeight()/2,label:t,fixed:!0,internalLabel:O.node.generateInternalLabel(t),relationships:[],isAutoLoadValue:!0===N.node.getIsAutoLoadValue(t)};m.nodes.push(n),O.notifyListeners(O.Events.NODE_ROOT_ADD,[n]),O.node.loadRelationshipData(n,function(e){n.relationships=e,N.node.getIsAutoExpandRelations(t)?(O.ignoreCount=!0,O.node.expandRelationships(n,function(){O.ignoreCount=!1,O.hasGraphChanged=!0,g()})):(O.hasGraphChanged=!0,g())},Math.PI/2)}},O.loadSchema=function(e){0<m.nodes.length&&p.warn("graph.loadSchema is called but the graph is not empty.");var t=e,n={id:m.generateId(),type:O.node.NodeTypes.ROOT,x:O.getSVGWidth()/2,y:O.getSVGHeight()/2,fx:O.getSVGWidth()/2,fy:O.getSVGHeight()/2,tx:O.getSVGWidth()/2,ty:O.getSVGHeight()/2,label:t.label,fixed:!0,internalLabel:O.node.generateInternalLabel(t.label),relationships:[],isAutoLoadValue:!0===N.node.getIsAutoLoadValue(t.label)};m.nodes.push(n),O.notifyListeners(O.Events.NODE_ROOT_ADD,[n]);var r=N.node.getSchema(e.label);if(void 0!==r&&r.hasOwnProperty("rel")&&0<r.rel.length){var a=Math.PI/2;n.relationships=O.node.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(r.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}else O.node.loadRelationshipData(n,function(e){n.relationships=e,O.hasGraphChanged=!0,g()},Math.PI/2);if(t.hasOwnProperty("value")){var o=[].concat(t.value);n.value=[],o.forEach(function(e){n.value.push({id:m.generateId(),parent:n,attributes:e,type:O.node.NodeTypes.VALUE,label:n.label,rel_count:t.rel_count})})}if(t.hasOwnProperty("rel"))for(var l=0;l<t.rel.length;l++)O.loadSchemaRelation(t.rel[l],n,l+1,t.rel.length)},O.loadSchemaRelation=function(e,t,n,r){var a=e.target,o=O.loadSchemaNode(a,t,n,r,e.label,e.hasOwnProperty("isReverse")&&!0===e.isReverse),l={id:"l"+m.generateId(),source:t,target:o,type:O.link.LinkTypes.RELATION,label:e.label,schema:e};m.links.push(l);var i=N.node.getSchema(a.label);if(void 0!==i&&i.hasOwnProperty("rel")&&0<i.rel.length){var s=Math.PI/2;o.relationships=O.node.pie.startAngle(s-Math.PI).endAngle(s+Math.PI)(i.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}else O.node.loadRelationshipData(o,function(e){o.relationships=e,O.hasGraphChanged=!0,g()},Math.PI/2);if(a.hasOwnProperty("rel"))for(var d=0;d<a.rel.length;d++)O.loadSchemaRelation(a.rel[d],o,d+1,a.rel.length)},O.loadSchemaNode=function(e,t,n,r,a,o){var l,i=N.node.getIsGroup(e),s=O.computeParentAngle(t);l=s?360/(r+1)*n:360/r*n;var d=t.x+200*Math.cos(l*(Math.PI/180)-s),u=t.y+200*Math.sin(l*(Math.PI/180)-s),p={id:m.generateId(),parent:t,parentRel:a,type:i?O.node.NodeTypes.GROUP:O.node.NodeTypes.CHOOSE,label:e.label,fixed:!1,internalLabel:O.node.generateInternalLabel(e.label),x:d,y:u,schema:e,isAutoLoadValue:!0===N.node.getIsAutoLoadValue(e.label),relationships:[]};if(!0===o&&(p.isParentRelReverse=!0),e.hasOwnProperty("isNegative")&&!0===e.isNegative&&(p.isNegative=!0,p.count=0),m.nodes.push(p),e.hasOwnProperty("value")){var c=[].concat(e.value);p.value=[],c.forEach(function(e){p.value.push({id:m.generateId(),parent:p,attributes:e,type:O.node.NodeTypes.VALUE,label:p.label})})}return p},O.addSchema=function(e){0<m.nodes.length&&p.warn("graph.addSchema is called but the graph is not empty.");var t=e,n={id:m.generateId(),type:O.node.NodeTypes.ROOT,x:O.getSVGWidth()/2,y:O.getSVGHeight()/2,fx:O.getSVGWidth()/2,fy:O.getSVGHeight()/2,tx:O.getSVGWidth()/2,ty:O.getSVGHeight()/2,label:t.label,fixed:!0,internalLabel:O.node.generateInternalLabel(t.label),relationships:[],isAutoLoadValue:!0===N.node.getIsAutoLoadValue(t.label)};if(m.nodes.push(n),O.notifyListeners(O.Events.NODE_ROOT_ADD,[n]),t.hasOwnProperty("rel")&&0<t.rel.length){var r=Math.PI/2;n.relationships=O.node.pie.startAngle(r-Math.PI).endAngle(r+Math.PI)(t.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}},O.addSchemaRelation=function(e,t,n,r){var a=e.target,o=O.addSchemaNode(a,t,n,r,e.label),l={id:"l"+m.generateId(),source:t,target:o,type:O.link.LinkTypes.RELATION,label:e.label,schema:e};m.links.push(l)},O.addSchemaNode=function(e,t,n,r,a){var o,l=N.node.getIsGroup(e),i=e.hasOwnProperty("collapsed")&&!0===e.collapsed,s=O.computeParentAngle(t);o=s?360/(r+1)*n:360/r*n;var d=t.x+200*Math.cos(o*(Math.PI/180)-s),u=t.y+200*Math.sin(o*(Math.PI/180)-s),p={id:m.generateId(),parent:t,parentRel:a,type:l?O.node.NodeTypes.GROUP:O.node.NodeTypes.CHOOSE,label:e.label,fixed:!1,internalLabel:O.node.generateInternalLabel(e.label),x:d,y:u,schema:e,isAutoLoadValue:!0===N.node.getIsAutoLoadValue(e.label),relationships:[]};if(e.hasOwnProperty("rel")&&0<e.rel.length){for(var c={},g=[],f=0;f<e.rel.length;f++){var h=e.rel[f],v=h.label+h.target.label;c.hasOwnProperty(v)||(c[v]=h,g.push(h))}p.relationships=O.node.pie(g).map(function(e){return{id:e.data.label+e.data.target.label,count:e.data.count||0,label:e.data.label,target:e.data.target.label,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2}})}if(e.hasOwnProperty("value")){var E=[].concat(e.value);p.value=[],E.forEach(function(e){p.value.push({id:m.generateId(),parent:p,attributes:e,type:O.node.NodeTypes.VALUE,label:p.label})})}if(m.nodes.push(p),!i&&e.hasOwnProperty("rel"))for(var y=0;y<e.rel.length;y++)O.addSchemaRelation(e.rel[y],p,y+1,e.rel.length);return p},O.getSchema=function(){var a={},t=m.getRootNode();a[t.id]={label:t.label},t.hasOwnProperty("value")&&(a[t.id].value=[],t.value.forEach(function(e){a[t.id].value.push(e.attributes)}));var e=m.links;return 0<e.length&&e.forEach(function(e){if(e.type===O.link.LinkTypes.RELATION){var t=e.source,n=e.target;a.hasOwnProperty(t.id)||(a[t.id]={label:t.label},t.hasOwnProperty("isNegative")&&!0===t.isNegative&&(a[t.id].isNegative=!0),t.hasOwnProperty("value")&&(a[t.id].value=[],t.value.forEach(function(e){a[t.id].value.push(e.attributes)}))),a.hasOwnProperty(n.id)||(a[n.id]={label:n.label},n.hasOwnProperty("isNegative")&&!0===n.isNegative&&(a[n.id].isNegative=!0),n.hasOwnProperty("value")&&(a[n.id].value=[],n.value.forEach(function(e){a[n.id].value.push(e.attributes)}))),a[t.id].hasOwnProperty("rel")||(a[t.id].rel=[]);var r={label:e.label,target:a[n.id]};n.hasOwnProperty("isParentRelReverse")&&!0===n.isParentRelReverse&&(r.isReverse=!0),a[t.id].rel.push(r)}}),a[t.id]},O.tick=function(){var e=O.svg.selectAll("#"+O.link.gID+" > g");if(e.selectAll(".ppt-link").attr("d",function(e){var t=e.source,n=e.target,r=O.computeParentAngle(n),a=N.node.getSize(t),o=N.node.getSize(n);!O.DISABLE_RELATION&&t.hasOwnProperty("relationships")&&0<t.relationships.length&&(a=O.node.getDonutOuterRadius(t)),!O.DISABLE_RELATION&&n.hasOwnProperty("relationships")&&0<n.relationships.length&&(o=O.node.getDonutOuterRadius(n));var l=n.x+o*Math.cos(r),i=n.y-o*Math.sin(r),s=t.x-a*Math.cos(r),d=t.y+a*Math.sin(r),u=(l+s)/2,p=(i+d)/2;return t.x<=n.x||!0===O.ignoreMirroLinkLabels?"M"+s+" "+d+"L"+u+" "+p+"L"+l+" "+i:"M"+l+" "+i+"L"+u+" "+p+"L"+s+" "+d}).attr("marker-end",function(e){if(O.link.SHOW_MARKER)if(!0===e.target.isParentRelReverse){if(e.source.x>e.target.x)return"url(#arrow)"}else if(e.source.x<=e.target.x)return"url(#arrow)";return null}).attr("marker-start",function(e){if(O.link.SHOW_MARKER)if(!0===e.target.isParentRelReverse){if(e.source.x<=e.target.x)return"url(#reverse-arrow)"}else if(e.source.x>e.target.x)return"url(#reverse-arrow)";return null}),e.selectAll(".ppt-textPath").attr("xlink:href",function(e){return"#ppt-path_"+e.id}),O.svg.selectAll("#"+O.node.gID+" > g").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),!0===O.USE_VORONOI_LAYOUT){var t=u.select("#voronoi-clip-path").selectAll(".voroclip").data(O.recenterVoronoi(m.nodes),function(e){return e.point.id});t.enter().append("clipPath").attr("id",function(e){return"voroclip-"+e.point.id}).attr("class","voroclip"),t.exit().remove(),t.selectAll("path").remove(),t.append("path").attr("id",function(e){return"pvoroclip-"+e.point.id}).attr("d",function(e){return"M"+e.join(",")+"Z"})}},O.computeParentAngle=function(e){var t=0;if(e.parent){var n=e.parent.x,r=e.parent.y,a=e.x,o=e.y,l=100/(Math.sqrt(Math.pow(n-a,2)+Math.pow(r-o,2))-100),i=((a+l*n)/(1+l)-a)/100;i<-1&&(i=-1),1<i&&(i=1),t=Math.acos(i),o<r&&(t=2*Math.PI-t)}return t},O.addRelationshipData=function(e,t,n,r,a){var o={id:""+m.generateId(),parent:e,parentRel:t.label,type:O.node.NodeTypes.CHOOSE,label:t.target,fixed:!1,internalLabel:O.node.generateInternalLabel(t.target),relationships:[]};!0===t.isReverse&&(o.isParentRelReverse=!0),void 0!==r&&0<r.length&&(o.value=r),void 0!==a&&!0===a&&(o.isNegative=!0);var l={id:"l"+m.generateId(),source:e,target:o,type:O.link.LinkTypes.RELATION,label:t.label};o.x=e.x+2*N.link.getDistance(l)/3*Math.cos(t.directionAngle-Math.PI/2)+10*Math.random(),o.y=e.y+2*N.link.getDistance(l)/3*Math.sin(t.directionAngle-Math.PI/2)+10*Math.random(),o.tx=e.tx+N.link.getDistance(l)*Math.cos(t.directionAngle-Math.PI/2),o.ty=e.ty+N.link.getDistance(l)*Math.sin(t.directionAngle-Math.PI/2),m.nodes.push(o),m.links.push(l),O.hasGraphChanged=!0,g(),O.node.loadRelationshipData(o,function(e){o.relationships=e,O.hasGraphChanged=!0,g(),N.node.getIsAutoExpandRelations(o.label)?O.node.expandRelationships(o,function(){n(o)}):n(o)},t.directionAngle)},O.voronoi=u.voronoi().x(function(e){return e.x}).y(function(e){return e.y}),O.recenterVoronoi=function(e){var r=[];return O.voronoi.polygons(e.map(function(e){return e.x=e.x||0,e.y=e.y||0,e})).forEach(function(t){if(t.length){var n=[];t.forEach(function(e){n.push([e[0]-t.data.x,e[1]-t.data.y])}),n.point=t.data,r.push(n)}}),r},e.version=t,e.dataModel=m,e.graph=O,e.logger=p,e.provider=N,e.query=b,e.rest=l,e.taxonomy=s,e.tools=n,e.start=function(e){if(p.info("Popoto 2.0.8 start on "+e),O.mainLabel=e,void 0===l.CYPHER_URL)p.error("popoto.rest.CYPHER_URL is not set but is required.");else{if(n=u.select("#"+O.containerId),r=u.select("#"+s.containerId),a=u.select("#"+i.containerId),n.empty()?(p.debug("The page doesn't contain a container with ID = \""+O.containerId+'" no graph area will be generated. This ID is defined in graph.containerId property.'),O.isActive=!1):O.isActive=!0,r.empty()?(p.debug("The page doesn't contain a container with ID = \""+s.containerId+'" no taxonomy filter will be generated. This ID is defined in taxonomy.containerId property.'),s.isActive=!1):s.isActive=!0,a.empty()?(p.debug("The page doesn't contain a container with ID = \""+i.containerId+'" no query viewer will be generated. This ID is defined in infoviewer.containerId property.'),i.isActive=!1):i.isActive=!0,s.isActive&&s.createTaxonomyPanel(),O.isActive)if(O.createGraphArea(),O.createForceLayout(),"string"==typeof e||e instanceof String){var t=N.node.getSchema(e);void 0!==t?O.addSchema(t):O.addRootNode(e)}else O.loadSchema(e);i.isActive&&i.createInfoArea(),!0===O.USE_VORONOI_LAYOUT&&O.voronoi.extent([[-popoto.graph.getSVGWidth(),-popoto.graph.getSVGWidth()],[2*popoto.graph.getSVGWidth(),2*popoto.graph.getSVGHeight()]]),c()}var n,r,a},e.update=c,e.updateGraph=g,e.appendFittedText=y,Object.defineProperty(e,"__esModule",{value:!0})});