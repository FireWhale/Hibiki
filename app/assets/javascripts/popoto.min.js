// Copyright (c) 2018 NHOGS Interactive.
(function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("jquery"),require("d3")):"function"==typeof define&&define.amd?define(["exports","jquery","d3"],t):t(e.popoto=e.popoto||{},e.jQuery,e.d3)})(this,function(e,o,d){"use strict";o=o&&o.hasOwnProperty("default")?o.default:o;var t="2.0.8",m={idGen:0,generateId:function(){return m.idGen++},nodes:[],links:[],getRootNode:function(){return m.nodes[0]}},p={};p.LogLevels=Object.freeze({DEBUG:0,INFO:1,WARN:2,ERROR:3,NONE:4}),p.LEVEL=p.LogLevels.NONE,p.TRACE=!1,p.log=function(e,t){if(console&&e>=p.LEVEL)switch(p.TRACE&&(t=t+"\n"+(new Error).stack),e){case p.LogLevels.DEBUG:case p.LogLevels.INFO:console.log(t);break;case p.LogLevels.WARN:console.warn(t);break;case p.LogLevels.ERROR:console.error(t)}},p.debug=function(e){p.log(p.LogLevels.DEBUG,e)},p.info=function(e){p.log(p.LogLevels.INFO,e)},p.warn=function(e){p.log(p.LogLevels.WARN,e)};var A={MAX_RESULTS_COUNT:100,VALUE_QUERY_LIMIT:100,USE_PARENT_RELATION:!(p.error=function(e){p.log(p.LogLevels.ERROR,e)}),USE_RELATION_DIRECTION:!0,COLLECT_RELATIONS_WITH_VALUES:!1,prefilter:""};A.NEO4J_INTERNAL_ID=Object.freeze({queryInternalName:"NEO4JID"}),A.filterRelation=function(e){return!0},A.generateTaxonomyCountQuery=function(e){var t=O.node.getConstraintAttribute(e),n=[];return O.node.getPredefinedConstraints(e).forEach(function(e){n.push(e.replace(new RegExp("\\$identifier","g"),"n"))}),t===A.NEO4J_INTERNAL_ID?"MATCH (n:`"+e+"`)"+(0<n.length?" WHERE "+n.join(" AND "):"")+" RETURN count(DISTINCT ID(n)) as count":"MATCH (n:`"+e+"`)"+(0<n.length?" WHERE "+n.join(" AND "):"")+" RETURN count(DISTINCT n."+t+") as count"},A.generateHibikiElements=function(e,t){O.node.getPredefinedConstraints(rootNode.label).forEach(function(e){whereElements.push(e.replace(new RegExp("\\$identifier","g"),rootNode.internalLabel))}),[].push("("+rootNode.internalLabel+":`"+rootNode.label+"`)")},A.generateQueryElements=function(t,d,e,p,c){var g=[],f=[],h=[],v=[],E={};if(O.node.getPredefinedConstraints(t.label).forEach(function(e){f.push(e.replace(new RegExp("\\$identifier","g"),t.internalLabel))}),g.push("("+t.internalLabel+":`"+t.label+"`)"),p||t.immutable){var n=A.generateNodeValueConstraints(t,c);for(var r in f=f.concat(n.whereElements),n.parameters)n.parameters.hasOwnProperty(r)&&(E[r]=n.parameters[r])}var y=0;return e.forEach(function(r){var a=r.source,o=r.target,l="->";A.USE_RELATION_DIRECTION&&!0!==o.isParentRelReverse||(l="-");var e="r"+y++;if(h.push(e),O.node.getPredefinedConstraints(o.label).forEach(function(e){f.push(e.replace(new RegExp("\\$identifier","g"),o.internalLabel))}),o!==d&&!0===o.isNegative)if(void 0!==o.value&&0<o.value.length){var i=0;o.value.forEach(function(e){var t,n=O.node.getConstraintAttribute(e.label);0===i?(t=o.internalLabel+"_"+n,i++):t=o.internalLabel+"_"+n+i++,f.push("(NOT ("+a.internalLabel+":`"+a.label+"`)-[:`"+r.label+"`]"+l+"(:`"+o.label+"`{"+n+":$"+t+"}) )")})}else f.push("(NOT ("+a.internalLabel+":`"+a.label+"`)-[:`"+r.label+"`]"+l+"(:`"+o.label+"`) )");else{A.COLLECT_RELATIONS_WITH_VALUES&&o===d&&v.push("COLLECT("+e+") AS incomingRels");var t="";c&&void 0!==O.node.getGenerateNodeValueConstraints(a)||(t=":`"+a.label+"`");var n="";c&&void 0!==O.node.getGenerateNodeValueConstraints(o)||(n=":`"+o.label+"`"),g.push("("+a.internalLabel+t+")-["+e+":`"+r.label+"`]"+l+"("+o.internalLabel+n+")")}if(o!==d&&(p||o.immutable)){var s=A.generateNodeValueConstraints(o,c);for(var u in f=f.concat(s.whereElements),s.parameters)s.parameters.hasOwnProperty(u)&&(E[u]=s.parameters[u])}}),{matchElements:g,whereElements:f,relationElements:h,returnElements:v,parameters:E}},A.generateNodeValueConstraints=function(e,t){if(t&&void 0!==O.node.getGenerateNodeValueConstraints(e))return O.node.getGenerateNodeValueConstraints(e)(e);var n={},r=[];if(void 0!==e.value&&0<e.value.length){var a=O.node.getConstraintAttribute(e.label),o=e.internalLabel+"_"+a;if(1<e.value.length)if(void 0!==e.isNegative&&e.isNegative){var l=0;e.value.forEach(function(e){var t;t=a===A.NEO4J_INTERNAL_ID?e.internalID:e.attributes[a],0===l?(n[o]=t,l++):n[o+l++]=t})}else n[o]=[],e.value.forEach(function(e){var t;t=a===A.NEO4J_INTERNAL_ID?e.internalID:e.attributes[a],n[o].push(t)}),a===A.NEO4J_INTERNAL_ID?r.push("ID("+e.internalLabel+") IN {`"+o+"`}"):r.push(e.internalLabel+"."+a+" IN {`"+o+"`}");else if(a===A.NEO4J_INTERNAL_ID?n[o]=e.value[0].internalID:n[o]=e.value[0].attributes[a],void 0===e.isNegative||!e.isNegative){a===A.NEO4J_INTERNAL_ID?r.push("ID("+e.internalLabel+") = {`"+o+"`}"):r.push(e.internalLabel+"."+a+" = {`"+o+"`}")}}return{parameters:n,whereElements:r}},A.getRelevantLinks=function(a,t,e){var o=e.slice(),n=[],l=[];return o.forEach(function(e){(void 0!==e.target.value&&0<e.target.value.length||e.target===t||e.target.isNegative)&&n.push(e)}),n.forEach(function(e){o.splice(o.indexOf(e),1)}),n.forEach(function(e){for(var t=e.source,n=!0;n;){var r=null;o.forEach(function(e){e.target===t&&(r=e)}),null===r?n=!1:r.source===a?(l.push(r),o.splice(o.indexOf(r),1),n=!1):(l.push(r),o.splice(o.indexOf(r),1),t=r.source)}}),n.concat(l)},A.getLinksToRoot=function(e,t){for(var n=[],r=e;r!==m.getRootNode();){for(var a,o=0;o<t.length;o++){var l=t[o];if(l.target===r){a=l;break}}a&&(n.push(a),r=a.source)}return n},A.generateResultQuery=function(e){var t=m.getRootNode(),n=A.generateQueryElements(t,t,A.getRelevantLinks(t,t,m.links),!0,!0),r=n.matchElements,a=n.whereElements,o=n.relationElements,l=[],i=[],s=n.parameters,u=O.node.getResultOrderByAttribute(t.label);if(u){var d=O.node.isResultOrderAscending(t.label)?"ASC":"DESC";i.push("ORDER BY "+u+" "+d)}i.push("LIMIT "+A.MAX_RESULTS_COUNT);var p=O.node.getReturnAttributes(t.label);if(e)l.push(t.internalLabel),o.forEach(function(e){l.push(e)});else for(var c=0;c<p.length;c++){var g=p[c];g===A.NEO4J_INTERNAL_ID?l.push("ID("+t.internalLabel+") AS "+A.NEO4J_INTERNAL_ID.queryInternalName):l.push(t.internalLabel+"."+g+" AS "+g)}var f="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN DISTINCT "+l.join(", ")+" "+i.join(" "),h=O.node.filterResultQuery(t.label,{statement:f,matchElements:r,whereElements:a,withElements:[],returnElements:l,endElements:i,parameters:s});return h.statement=A.prefilter+h.statement,h},A.generateNodeCountQuery=function(e){var t=A.generateQueryElements(m.getRootNode(),e,A.getRelevantLinks(m.getRootNode(),e,m.links),!0,!0),n=t.matchElements,r=t.whereElements,a=[],o=t.parameters,l=O.node.getConstraintAttribute(e.label);l===A.NEO4J_INTERNAL_ID?a.push("count(DISTINCT ID("+e.internalLabel+")) as count"):a.push("count(DISTINCT "+e.internalLabel+"."+l+") as count");var i="MATCH "+n.join(", ")+(0<r.length?" WHERE "+r.join(" AND "):"")+" RETURN "+a.join(", "),s=O.node.filterNodeCountQuery(e,{statement:i,matchElements:n,whereElements:r,returnElements:a,endElements:[],parameters:o});return{statement:A.prefilter+s.statement,parameters:s.parameters}},A.generateNodeValueQuery=function(e){var t=m.getRootNode(),n=A.generateQueryElements(t,e,A.getRelevantLinks(t,e,m.links),!0,!1),r=n.matchElements,a=n.whereElements,o=[],l=[],i=n.parameters,s=O.node.getValueOrderByAttribute(e.label);if(s){var u=O.node.isValueOrderAscending(e.label)?"ASC":"DESC";l.push("ORDER BY "+s+" "+u)}l.push("LIMIT "+A.VALUE_QUERY_LIMIT);for(var d=O.node.getReturnAttributes(e.label),p=(O.node.getConstraintAttribute(e.label),0);p<d.length;p++)d[p]===A.NEO4J_INTERNAL_ID?o.push("ID("+e.internalLabel+") AS "+A.NEO4J_INTERNAL_ID.queryInternalName):o.push(e.internalLabel+"."+d[p]+" AS "+d[p]);var c=O.node.getConstraintAttribute(t.label);c===A.NEO4J_INTERNAL_ID?o.push("count(DISTINCT ID("+t.internalLabel+")) AS count"):o.push("count(DISTINCT "+t.internalLabel+"."+c+") AS count"),A.COLLECT_RELATIONS_WITH_VALUES&&n.returnElements.forEach(function(e){o.push(e)});var g="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN "+o.join(", ")+" "+l.join(" "),f=O.node.filterNodeValueQuery(e,{statement:g,matchElements:r,whereElements:a,returnElements:o,endElements:l,parameters:i});return{statement:A.prefilter+f.statement,parameters:f.parameters}};var c={CYPHER_URL:"http://localhost:7474/db/data/transaction/commit",WITH_CREDENTIALS:!(A.generateNodeRelationQuery=function(e){var t=A.getLinksToRoot(e,m.links),n=A.generateQueryElements(m.getRootNode(),e,t,!1,!1),r=n.matchElements,a=n.whereElements,o=[],l=[],i=n.parameters,s=A.USE_RELATION_DIRECTION?"->":"-";r.push("("+e.internalLabel+":`"+e.label+"`)-[r]"+s+"(x)"),o.push("type(r) AS label"),A.USE_PARENT_RELATION?o.push("head(labels(x)) AS target"):o.push("last(labels(x)) AS target"),o.push("count(r) AS count"),l.push("ORDER BY count(r) DESC");var u="MATCH "+r.join(", ")+(0<a.length?" WHERE "+a.join(" AND "):"")+" RETURN "+o.join(", ")+" "+l.join(" "),d=O.node.filterNodeRelationQuery(e,{statement:u,matchElements:r,whereElements:a,returnElements:o,endElements:l,parameters:i});return{statement:A.prefilter+d.statement,parameters:d.parameters}}),post:function(e,t){var n=JSON.stringify(e);p.info("REST POST:"+n);var r={type:"POST",beforeSend:function(e){c.AUTHORIZATION&&e.setRequestHeader("Authorization",c.AUTHORIZATION)},contentType:"application/json"};void 0!==e&&(r.data=n),!0===c.WITH_CREDENTIALS&&(r.xhrFields={withCredentials:!0}),"/interactive"==t&&(r={type:"GET",data:e,dataType:"json",contentType:"application/json"});var a=c.CYPHER_URL;return void 0!==t&&(a=t),o.ajax(a,r)}};c.response={parse:function(e){p.debug(JSON.stringify(e));var t=[];return void 0!==e&&e.hasOwnProperty("results")&&0<e.results.length&&!(e.hasOwnProperty("errors")&&0<e.errors.length)&&(t=e.results.map(function(e){for(var t=[],n=0;n<e.data.length;n++){for(var r={},a=0;a<e.columns.length;a++)r[e.columns[a]]=e.data[n].row[a];t.push(r)}return t})),p.info(JSON.stringify(t)),t}};var g={};function f(){h();var e=m.getRootNode();e&&void 0!==e.label&&(L.isActive&&L.updateQuery(),I.isActive&&I.updateQuery(),(g.isActive||0<g.resultListeners.length||0<g.resultCountListeners.length||0<g.graphResultListeners.length)&&g.updateResults())}function h(){b.isActive&&(b.link.updateLinks(),b.node.updateNodes(),b.force.nodes(m.nodes),b.force.force("link").links(m.links),b.force.alpha(1).restart())}g.containerId="popoto-results",g.hasChanged=!0,g.resultCountListeners=[],g.resultListeners=[],g.graphResultListeners=[],g.RESULTS_PAGE_SIZE=10,g.TOTAL_COUNT=!1,g.onTotalResultCount=function(e){g.resultCountListeners.push(e)},g.onResultReceived=function(e){g.resultListeners.push(e)},g.onGraphResultReceived=function(e){g.graphResultListeners.push(e)},g.parseGraphResultData=function(e){var t={},n={};e.results[1].data.forEach(function(e){e.graph.nodes.forEach(function(e){t.hasOwnProperty(e.id)||(t[e.id]=e)}),e.graph.relationships.forEach(function(e){n.hasOwnProperty(e.id)||(n[e.id]=e)})});var r=[],a=[];for(var o in t)t.hasOwnProperty(o)&&r.push(t[o]);for(var l in n)n.hasOwnProperty(l)&&a.push(n[l]);return{nodes:r,edges:a}},g.updateResults=function(){if(g.hasChanged){var l={},e=0;void 0!==g.resultsXhr&&g.resultsXhr.abort();var t=A.generateResultQuery(),n={statements:[{statement:(g.lastGeneratedQuery=t).statement,parameters:t.parameters,resultDataContents:["row"]}]};if(l.results=e++,0<g.graphResultListeners.length){var r=A.generateResultQuery(!0);g.lastGeneratedQuery=r,n.statements.push({statement:r.statement,parameters:r.parameters,resultDataContents:["row","graph"]}),l.graph=e++}if(!0===g.TOTAL_COUNT&&0<g.resultCountListeners.length){var a=A.generateNodeCountQuery(m.getRootNode());n.statements.push({statement:a.statement,parameters:a.parameters}),l.total=e++}p.info("Results ==>"),g.resultsXhr=c.post(n).done(function(e){p.info("<== Results");var t=c.response.parse(e),n=t[l.results].map(function(e,t){return{resultIndex:t,label:m.getRootNode().label,attributes:e}});if(g.lastResults=n,l.hasOwnProperty("total")){var r=t[l.total][0].count;g.resultCountListeners.forEach(function(e){e(r)})}if(g.resultListeners.forEach(function(e){e(n)}),0<g.graphResultListeners.length){var a=g.parseGraphResultData(e);g.graphResultListeners.forEach(function(e){e(a)})}if(g.isActive){var o=d.select("#"+g.containerId).selectAll(".ppt-result").data([]);o.exit().remove(),(o=d.select("#"+g.containerId).selectAll(".ppt-result").data(n.slice(0,g.RESULTS_PAGE_SIZE),function(e){return e.resultIndex})).enter().append("div").attr("class","ppt-result").attr("id",function(e){return"popoto-result-"+e.resultIndex}).each(function(e){O.node.getDisplayResults(e.label)(d.select(this))})}g.hasChanged=!1}).fail(function(e,t,n){"abort"!==t?(p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),g.resultListeners.forEach(function(e){e([])})):p.info("<=X= Results - Aborted!")})}},g.updateResultsCount=function(){0<g.resultCountListeners.length&&g.resultCountListeners.forEach(function(e){e(m.getRootNode().count)})},g.generatePreQuery=function(){var t={ids:[]};return g.lastResults.forEach(function(e){t.ids.push(e.attributes.id)}),{query:"MATCH (d) WHERE d.id IN $ids WITH d",param:t}};var i={containerId:"popoto-taxonomy",createTaxonomyPanel:function(){var e=d.select("#"+i.containerId).append("ul").attr("class","ppt-taxo-ul"),t=i.generateTaxonomiesData(),n=e.selectAll(".taxo").data(t).enter().append("li").attr("id",function(e){return e.id}).attr("class","ppt-taxo-li").attr("value",function(e){return e.label});n.append("span").attr("class",function(e){return"ppt-icon "+O.taxonomy.getCSSClass(e.label,"span-icon")}).html("&nbsp;"),n.append("span").attr("class","ppt-label").text(function(e){return O.taxonomy.getTextValue(e.label)}),n.append("span").attr("class","ppt-count"),n.on("click",i.onClick),i.addTaxonomyChildren(n);var r=[];t.forEach(function(e){r.push(e),e.children&&i.flattenChildren(e,r)}),b.DISABLE_COUNT||i.updateCount(r)},flattenChildren:function(e,t){e.children.forEach(function(e){t.push(e),e.children&&t.concat(i.flattenChildren(e,t))})},updateCount:function(e){var a,t=[];e.forEach(function(e){t.push({statement:A.generateTaxonomyCountQuery(e.label)})}),a=e,p.info("Count taxonomies ==>"),c.post({statements:t}).done(function(e){p.info("<== Count taxonomies");for(var t=c.response.parse(e),n=0;n<a.length;n++){var r=t[n][0].count;d.select("#"+a[n].id).select(".ppt-count").text(" ("+r+")")}}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),d.select("#popoto-taxonomy").selectAll(".ppt-count").text(" (0)")})},addTaxonomyChildren:function(e){e.each(function(e){var t=d.select(this),n=e.children;if(e.children){var r=t.append("ul").attr("class","ppt-taxo-sub-ul").selectAll("li").data(n).enter().append("li").attr("id",function(e){return e.id}).attr("class","ppt-taxo-sub-li").attr("value",function(e){return e.label});r.append("span").attr("class",function(e){return"ppt-icon "+O.taxonomy.getCSSClass(e.label,"span-icon")}).html("&nbsp;"),r.append("span").attr("class","ppt-label").text(function(e){return O.taxonomy.getTextValue(e.label)}),r.append("span").attr("class","ppt-count"),r.on("click",i.onClick),i.addTaxonomyChildren(r)}})},onClick:function(){d.event.stopPropagation();var e=this.attributes.value.value;m.nodes.length=0,m.links.length=0,b.node.internalLabels={},f(),b.mainLabel=e,void 0!==O.node.getSchema(e)?b.addSchema(O.node.getSchema(e)):b.addRootNode(e),b.hasGraphChanged=!0,g.hasChanged=!0,b.ignoreCount=!1,f(),n.center()},generateTaxonomiesData:function(){var t=0,e=[];for(var n in O.node.Provider)O.node.Provider.hasOwnProperty(n)&&O.node.getProperty(n,"isSearchable")&&!O.node.Provider[n].parent&&e.push({label:n,id:"popoto-lbl-"+t++});return e.forEach(function(e){O.node.getProvider(e.label).hasOwnProperty("children")&&(t=i.addChildrenData(e,t))}),e},addChildrenData:function(r,a){return r.children=[],O.node.getProvider(r.label).children.forEach(function(e){var t=O.node.getProvider(e),n={label:e,id:"popoto-lbl-"+a++};t.hasOwnProperty("children")&&(a=i.addChildrenData(n,a)),O.node.getProperty(e,"isSearchable")&&r.children.push(n)}),a}},n={CENTER_GRAPH:!0,RESET_GRAPH:!0,SAVE_GRAPH:!1,TOGGLE_TAXONOMY:!1,TOGGLE_FULL_SCREEN:!0,TOGGLE_VIEW_RELATION:!0,TOGGLE_FIT_TEXT:!0,reset:function(){m.nodes.length=0,m.links.length=0,b.node.internalLabels={},"string"==typeof b.mainLabel||b.mainLabel instanceof String?void 0!==O.node.getSchema(b.mainLabel)?b.addSchema(O.node.getSchema(b.mainLabel)):b.addRootNode(b.mainLabel):b.loadSchema(b.mainLabel),b.hasGraphChanged=!0,g.hasChanged=!0,f(),n.center()},center:function(){b.svgTag.transition().call(b.zoom.transform,d.zoomIdentity)},toggleTaxonomy:function(){var e=d.select("#"+i.containerId);e.filter(".disabled").empty()?e.classed("disabled",!0):e.classed("disabled",!1),b.centerRootNode()},toggleFitText:function(){b.USE_FIT_TEXT=!b.USE_FIT_TEXT,b.node.updateNodes()},toggleViewRelation:function(){b.DISABLE_RELATION=!b.DISABLE_RELATION,d.selectAll(".ppt-g-node-background").classed("hide",b.DISABLE_RELATION),b.tick()},toggleFullScreen:function(){var e=document.getElementById(b.containerId);document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():e.requestFullscreen?e.requestFullscreen():e.msRequestFullscreen?e.msRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen&&e.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}},r={TOOL_TAXONOMY:"Show/hide taxonomy panel",TOOL_RELATION:"Show/hide relation",TOOL_CENTER:"Center view",TOOL_FULL_SCREEN:"Full screen",TOOL_RESET:"Reset graph",TOOL_SAVE:"Save graph",TOOL_FIT_TEXT:"Fit text in nodes",render:function(e){var t=e.append("div").attr("class","ppt-toolbar");n.TOGGLE_VIEW_RELATION&&t.append("span").attr("id","popoto-toggle-relation").attr("class","ppt-icon ppt-menu relation").attr("title",t.TOOL_RELATION).on("click",function(){n.toggleViewRelation()}),n.RESET_GRAPH&&t.append("span").attr("id","popoto-reset-menu").attr("class","ppt-icon ppt-menu reset").attr("title",t.TOOL_RESET).on("click",function(){b.notifyListeners(b.Events.GRAPH_RESET,[]),n.reset()}),n.TOGGLE_TAXONOMY&&t.append("span").attr("id","popoto-taxonomy-menu").attr("class","ppt-icon ppt-menu taxonomy").attr("title",t.TOOL_TAXONOMY).on("click",n.toggleTaxonomy),n.CENTER_GRAPH&&t.append("span").attr("id","popoto-center-menu").attr("class","ppt-icon ppt-menu center").attr("title",t.TOOL_CENTER).on("click",n.center),n.TOGGLE_FULL_SCREEN&&t.append("span").attr("id","popoto-fullscreen-menu").attr("class","ppt-icon ppt-menu fullscreen").attr("title",t.TOOL_FULL_SCREEN).on("click",n.toggleFullScreen),n.SAVE_GRAPH&&t.append("span").attr("id","popoto-save-menu").attr("class","ppt-icon ppt-menu save").attr("title",t.TOOL_SAVE).on("click",function(){b.notifyListeners(b.Events.GRAPH_SAVE,[b.getSchema()])}),n.TOGGLE_FIT_TEXT&&t.append("span").attr("id","popoto-fit-text-menu").attr("class","ppt-icon ppt-menu fit-text").attr("title",t.TOOL_FIT_TEXT).on("click",n.toggleFitText)}},a={};function v(e){return"function"==typeof e?e:function(){return e}}a.LinkTypes=Object.freeze({RELATION:0,VALUE:1,SEGMENT:2}),a.TEXT_DY=-4,a.SHOW_MARKER=!1,a.gID="popoto-glinks",a.updateLinks=function(){var e=a.updateData();a.removeElements(e.exit()),a.addNewElements(e.enter()),a.updateElements()},a.updateData=function(){return b.svg.select("#"+a.gID).selectAll(".ppt-glink").data(m.links,function(e){return e.id})},a.removeElements=function(e){e.remove()},a.addNewElements=function(e){var t=e.append("g").attr("class","ppt-glink").on("click",a.clickLink).on("mouseover",a.mouseOverLink).on("mouseout",a.mouseOutLink);t.append("path").attr("class","ppt-link"),t.append("text").attr("text-anchor","middle").attr("dy",a.TEXT_DY).append("textPath").attr("class","ppt-textPath").attr("startOffset","50%")},a.updateElements=function(){var e=b.svg.select("#"+a.gID).selectAll(".ppt-glink");e.attr("id",function(e){return"ppt-glink_"+e.id}),e.selectAll(".ppt-link").attr("id",function(e){return"ppt-path_"+e.id}).attr("stroke",function(e){return O.link.getColor(e,"path","stroke")}).attr("class",function(e){return"ppt-link "+O.link.getCSSClass(e,"path")}),e.selectAll("text").attr("id",function(e){return"ppt-text_"+e.id}).attr("class",function(e){return O.link.getCSSClass(e,"text")}).attr("fill",function(e){return O.link.getColor(e,"text","fill")}).selectAll(".ppt-textPath").attr("id",function(e){return"ppt-textpath_"+e.id}).attr("class",function(e){return"ppt-textpath "+O.link.getCSSClass(e,"text-path")}).attr("xlink:href",function(e){return"#ppt-path_"+e.id}).text(function(e){return O.link.getTextValue(e)})},a.mouseOverLink=function(){d.select(this).select("path").attr("class",function(e){return"ppt-link "+O.link.getCSSClass(e,"path--hover")}),d.select(this).select("text").attr("class",function(e){return O.link.getCSSClass(e,"text--hover")});var t=d.select(this).data()[0];L.isActive&&(L.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!0),L.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!0)),I.isActive&&I.querySpanElements.filter(function(e){return e.link===t}).classed("hover",!0)},a.mouseOutLink=function(){d.select(this).select("path").attr("class",function(e){return"ppt-link "+O.link.getCSSClass(e,"path")}),d.select(this).select("text").attr("class",function(e){return O.link.getCSSClass(e,"text")});var t=d.select(this).data()[0];L.isActive&&(L.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!1),L.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!1)),I.isActive&&I.querySpanElements.filter(function(e){return e.link===t}).classed("hover",!1)},a.clickLink=function(){var e=d.select(this).data()[0];if(e.type!==a.LinkTypes.VALUE){b.node.collapseAllNode();var t=b.node.removeNode(e.target);b.hasGraphChanged=!0,g.hasChanged=t,f()}};var l=document.createElement("canvas").getContext("2d"),E=12;function u(e){return l.measureText(e).width}function y(e){if(null==e)return[];var t,n,r=String(e);return function(e,t){for(var n,r=1/0,a=[],o=0,l=e.length;o<l;++o){var i=(n?n.text+" ":"")+e[o],s=u(i);(r+s)/2<t?(n.width=r=s,n.text=i):(n={width:r=u(e[o]),text:e[o]},a.push(n))}return a}(((t=r.split(/\s+/g))[t.length-1]||t.pop(),t[0]||t.shift(),t),(n=r,Math.sqrt(u(n.trim())*E)))}function s(e,t,n,r){var a,o=v(n),l=v(t),i=r?v(r):r;a=i,e.each(function(e){var t=d.select(this).selectAll(".fitted-text").data([{}]);t.enter().append("text").merge(t).attr("class","fitted-text"+(void 0!==a?" "+a(e):"")).attr("style","text-anchor: middle; font: 10px sans-serif")});var s,u=e.select(".fitted-text");s=l,u.each(function(e){var n=y(s(e)),t=d.select(this).selectAll("tspan").data(n);t.exit().remove(),t.enter().append("tspan").merge(t).attr("x",0).attr("y",function(e,t){return(t-n.length/2+.8)*E}).text(function(e){return e.text})}),u.attr("transform",function(e){var t=function(e){for(var t=0,n=0,r=e.length;n<r;++n){var a=e[n].width/2,o=(Math.abs(n-r/2+.5)+.5)*E;t=Math.max(t,Math.sqrt(a*a+o*o))}return t}(y(l(e))),n=1;return 0!==t&&t&&(n=o(e)/t),"translate(0,0) scale("+n+")"})}var N={getNodeBoundingBox:function(e){return e.getBBox()},render:function(e){var t=e.append("rect").attr("fill",function(e){return O.node.getColor(e,"back-text","fill")}).attr("class",function(e){return O.node.getCSSClass(e,"back-text")});s(e,function(e){return O.node.getTextValue(e)},function(e){return O.node.getSize(e)},function(e){return O.node.getCSSClass(e,"text")}),t.attr("x",function(e){return N.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).x-3}).attr("y",function(e){return N.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).y}).attr("rx","5").attr("ry","5").attr("width",function(e){return N.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).width+6}).attr("height",function(e){return N.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).height}).attr("transform",function(e){return d.select(this.parentNode).select("text").attr("transform")})}},R={TEXT_Y:8,getNodeBoundingBox:function(e){return e.getBBox()},render:function(e){var t=e.append("rect").attr("fill",function(e){return O.node.getColor(e,"back-text","fill")}).attr("class",function(e){return O.node.getCSSClass(e,"back-text")});e.append("text").attr("x",0).attr("y",R.TEXT_Y).attr("text-anchor","middle").attr("class",function(e){return O.node.getCSSClass(e,"text")}).on("mouseover",function(e){d.select(this.parentNode).attr("clip-path",null)}).on("mouseout",function(e){d.select(this.parentNode).attr("clip-path",function(e){return"url(#node-view"+e.id+")"})}).text(function(e){return O.node.getTextValue(e)}),t.attr("x",function(e){return R.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).x-3}).attr("y",function(e){return R.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).y}).attr("rx","5").attr("ry","5").attr("width",function(e){return R.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).width+6}).attr("height",function(e){return R.getNodeBoundingBox(d.select(this.parentNode).select("text").node()).height})}},T={gID:"popoto-gnodes",DONUTS_MARGIN:0,DONUT_WIDTH:20,NODE_MAX_CHARS:11,NODE_TITLE_MAX_CHARS:100,PAGE_SIZE:10,CountBox:{x:16,y:33,w:52,h:19},chooseWaiting:!1,getDonutInnerRadius:function(e){return O.node.getSize(e)+T.DONUTS_MARGIN},getDonutOuterRadius:function(e){return O.node.getSize(e)+T.DONUTS_MARGIN+T.DONUT_WIDTH}};T.pie=d.pie().sort(null).value(function(e){return 1}),T.NodeTypes=Object.freeze({ROOT:0,CHOOSE:1,VALUE:2,GROUP:3}),T.internalLabels={},T.generateInternalLabel=function(e){var t=e?e.toLowerCase().replace(/ /g,""):"n";return t in T.internalLabels?(T.internalLabels[t]=T.internalLabels[t]+1,t+T.internalLabels[t]):(T.internalLabels[t]=0,t)},T.updateNodes=function(){var e=T.updateData();T.removeElements(e.exit()),T.addNewElements(e.enter()),T.updateElements()},T.updateData=function(){var e=b.svg.select("#"+T.gID).selectAll(".ppt-gnode").data(m.nodes,function(e){return e.id});return b.hasGraphChanged&&(T.updateAutoLoadValues(),b.DISABLE_COUNT||b.ignoreCount||T.updateCount()),b.hasGraphChanged=!1,e},T.updateCount=function(){void 0!==T.updateCountXhr&&T.updateCountXhr.abort();var n=[],r=m.nodes.filter(function(e){return!(e.type===T.NodeTypes.VALUE||e.type===T.NodeTypes.GROUP||e.hasOwnProperty("isNegative")&&e.isNegative)});r.forEach(function(e){var t=A.generateNodeCountQuery(e);n.push({statement:t.statement,parameters:t.parameters})}),p.info("Count nodes ==>"),T.updateCountXhr=c.post({statements:n}).done(function(e){p.info("<== Count nodes");for(var t=c.response.parse(e),n=0;n<r.length;n++)r[n].count=t[n][0].count;0<g.resultCountListeners.length&&g.updateResultsCount(),T.updateElements(),b.link.updateElements()}).fail(function(e,t,n){"abort"!==t?(p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),r.forEach(function(e){e.count=0}),T.updateElements(),b.link.updateElements()):p.info("<=X= Count nodes - Aborted!")})},T.updateAutoLoadValues=function(){for(var e=[],o=T.getAutoLoadValueNodes(),t=0;t<o.length;t++){var n=o[t],r=A.generateNodeValueQuery(n);e.push({statement:r.statement,parameters:r.parameters})}0<e.length&&(p.info("AutoLoadValue ==>"),c.post({statements:e}).done(function(e){p.info("<== AutoLoadValue");for(var t=c.response.parse(e),n=0;n<o.length;n++){var r=o[n],a=O.node.getConstraintAttribute(r.label);r.data=t[n].filter(function(t){var n=!0;return r.hasOwnProperty("value")&&0<r.value.length&&r.value.forEach(function(e){e.attributes[a]===t[a]&&(n=!1)}),n}),r.page=1}b.notifyListeners(b.Events.GRAPH_NODE_DATA_LOADED,[o])}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)}))},T.removeElements=function(e){e.filter(function(e){return!e.parent}).remove(),e.filter(function(e){return e.parent}).transition().duration(300).attr("transform",function(e){return"translate("+e.parent.x+","+e.parent.y+")"}).remove()},T.addNewElements=function(e){var t=e.append("g").attr("class","ppt-gnode");t.on("click",T.nodeClick).on("mouseover",T.mouseOverNode).on("mouseout",T.mouseOutNode),t.filter(function(e){return e.type!==T.NodeTypes.VALUE}).on("contextmenu",T.clearSelection),t.filter(function(e){return e.type===T.NodeTypes.VALUE}).on("contextmenu",function(){d.event.preventDefault()}),t.append("defs").append("clipPath").attr("id",function(e){return"node-view"+e.id}).append("circle").attr("cx",0).attr("cy",0),T.addBackgroundElements(t),T.addMiddlegroundElements(t),T.addForegroundElements(t)},T.addBackgroundElements=function(e){var t=e.append("g").attr("class","ppt-g-node-background").classed("hide",b.DISABLE_RELATION);t.append("g").attr("class","ppt-donut-labels"),t.append("g").attr("class","ppt-donut-segments")},T.addMiddlegroundElements=function(e){e.append("g").attr("class","ppt-g-node-middleground")},T.addForegroundElements=function(e){var t=e.append("g").attr("class","ppt-g-node-foreground"),n=t.filter(function(e){return e.type===T.NodeTypes.ROOT||e.type===T.NodeTypes.CHOOSE}).append("g").attr("class","ppt-node-foreground-g-arrows"),r=n.append("g");r.append("circle").attr("class","ppt-larrow").attr("cx","-43").attr("cy","-23").attr("r","17"),r.append("path").attr("class","ppt-arrow").attr("d","m -44.905361,-23 6.742,-6.742 c 0.81,-0.809 0.81,-2.135 0,-2.944 l -0.737,-0.737 c -0.81,-0.811 -2.135,-0.811 -2.945,0 l -8.835,8.835 c -0.435,0.434 -0.628,1.017 -0.597,1.589 -0.031,0.571 0.162,1.154 0.597,1.588 l 8.835,8.834 c 0.81,0.811 2.135,0.811 2.945,0 l 0.737,-0.737 c 0.81,-0.808 0.81,-2.134 0,-2.943 l -6.742,-6.743 z"),r.on("click",function(e){d.event.stopPropagation(),1<e.page&&(e.page--,T.collapseNode(e),T.expandNode(e))});var a=n.append("g");if(a.append("circle").attr("class","ppt-rarrow").attr("cx","43").attr("cy","-23").attr("r","17"),a.append("path").attr("class","ppt-arrow").attr("d","m 51.027875,-24.5875 -8.835,-8.835 c -0.811,-0.811 -2.137,-0.811 -2.945,0 l -0.738,0.737 c -0.81,0.81 -0.81,2.136 0,2.944 l 6.742,6.742 -6.742,6.742 c -0.81,0.81 -0.81,2.136 0,2.943 l 0.737,0.737 c 0.81,0.811 2.136,0.811 2.945,0 l 8.835,-8.836 c 0.435,-0.434 0.628,-1.017 0.597,-1.588 0.032,-0.569 -0.161,-1.152 -0.596,-1.586 z"),a.on("click",function(e){d.event.stopPropagation(),e.page*T.PAGE_SIZE<e.count&&(e.page++,T.collapseNode(e),T.expandNode(e))}),!b.DISABLE_COUNT){var o=t.filter(function(e){return e.type!==T.NodeTypes.GROUP});o.append("rect").attr("x",T.CountBox.x).attr("y",T.CountBox.y).attr("width",T.CountBox.w).attr("height",T.CountBox.h).attr("class","ppt-count-box"),o.append("text").attr("x",42).attr("y",48).attr("text-anchor","middle").attr("class","ppt-count-text")}t.filter(function(e){return e.type===T.NodeTypes.CHOOSE}).append("g").attr("class","ppt-g-node-ban").append("path").attr("d","M89.1 19.2C88 17.7 86.6 16.2 85.2 14.8 83.8 13.4 82.3 12 80.8 10.9 72 3.9 61.3 0 50 0 36.7 0 24.2 5.4 14.8 14.8 5.4 24.2 0 36.7 0 50c0 11.4 3.9 22.1 10.9 30.8 1.2 1.5 2.5 3 3.9 4.4 1.4 1.4 2.9 2.7 4.4 3.9C27.9 96.1 38.6 100 50 100 63.3 100 75.8 94.6 85.2 85.2 94.6 75.8 100 63.3 100 50 100 38.7 96.1 28 89.1 19.2ZM11.9 50c0-10.2 4-19.7 11.1-27C30.3 15.9 39.8 11.9 50 11.9c8.2 0 16 2.6 22.4 7.3L19.3 72.4C14.5 66 11.9 58.2 11.9 50Zm65 27c-7.2 7.1-16.8 11.1-27 11.1-8.2 0-16-2.6-22.4-7.4L80.8 27.6C85.5 34 88.1 41.8 88.1 50c0 10.2-4 19.7-11.1 27z")},T.updateElements=function(){var e=b.svg.select("#"+T.gID).selectAll(".ppt-gnode");e.attr("id",function(e){return"popoto-gnode_"+e.id}),b.USE_VORONOI_LAYOUT&&e.attr("clip-path",function(e){return"url(#voroclip-"+e.id+")"}),e.select("defs").select("clipPath").attr("id",function(e){return"node-view"+e.id}).selectAll("circle").attr("r",function(e){return O.node.getSize(e)}),e.filter(function(e){return e.type!==T.NodeTypes.ROOT}).call(d.drag().on("start",function(e){d.event.active||b.force.alphaTarget(.3).restart();e.fx=e.x,e.fy=e.y}).on("drag",function(e){e.fx=d.event.x,e.fy=d.event.y}).on("end",function(e){d.event.active||b.force.alphaTarget(0);!1===e.fixed&&(e.fx=null,e.fy=null)})),T.updateBackgroundElements(),T.updateMiddlegroundElements(),T.updateForegroundElements()},T.updateBackgroundElements=function(){var e=b.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-background");e.select(".ppt-donut-labels").selectAll("*").remove(),e.select(".ppt-donut-segments").selectAll("*").remove();var t=e.select(".ppt-donut-segments").selectAll(".ppt-segment-container").data(function(e){var t=[];return e.hasOwnProperty("relationships")&&(t=e.relationships),t},function(e){return e.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",T.segmentClick).on("mouseover",function(e){d.select(this).select(".ppt-text-arc").classed("hover",!0)}).on("mouseout",function(e){d.select(this).select(".ppt-text-arc").classed("hover",!1)});t.append("title").attr("class","ppt-svg-title").text(function(e){return e.label+" "+e.target}),e.select(".ppt-donut-labels").selectAll(".ppt-segment-container").data(function(e){var t=[];return e.hasOwnProperty("relationships")&&(t=e.relationships),t},function(e){return e.id}).enter().append("g").attr("class",".ppt-segment-container").on("click",T.segmentClick).on("mouseover",function(e){d.select(this).select(".ppt-text-arc").classed("hover",!0)}).on("mouseout",function(e){d.select(this).select(".ppt-text-arc").classed("hover",!1)}).append("path").attr("class","ppt-hidden-arc").attr("id",function(e,t){return"arc_"+d.select(this.parentNode.parentNode).datum().id+"_"+t}).attr("d",function(e){var t=d.select(this.parentNode.parentNode).datum(),n={startAngle:e.directionAngle-(Math.PI-.1),endAngle:e.directionAngle+(Math.PI-.1)},r=d.arc().innerRadius(T.getDonutInnerRadius(t)).outerRadius(T.getDonutOuterRadius(t))(n),a=/(^.+?)L/.exec(r);return(a&&1<a.length?a[1]:/(^.+?)M/.exec(r)[1]).replace(/,/g," ")}).style("fill","none").style("stroke","none"),t.append("text").attr("text-anchor","middle").attr("class",function(e){var t=d.select(this.parentNode.parentNode).datum();return t.hasOwnProperty("count")&&0===t.count?"ppt-text-arc disabled":"ppt-text-arc"}).attr("fill",function(e){var t=d.select(this.parentNode.parentNode).datum();return O.link.getColor({label:e.label,type:b.link.LinkTypes.SEGMENT,source:t,target:{label:e.target}},"segment","fill")}).attr("dy",b.link.TEXT_DY).append("textPath").attr("startOffset","50%").attr("xlink:href",function(e,t){return"#arc_"+d.select(this.parentNode.parentNode.parentNode).datum().id+"_"+t}).text(function(e){var t=d.select(this.parentNode.parentNode.parentNode).datum();return O.link.getTextValue({source:t,target:{label:e.target},label:e.label,type:b.link.LinkTypes.SEGMENT})}),t.append("path").attr("class",function(e){var t=d.select(this.parentNode.parentNode).datum();return t.hasOwnProperty("count")&&0===t.count?"ppt-segment disabled":"ppt-segment"}).attr("d",function(e){var t=d.select(this.parentNode.parentNode).datum();return d.arc().innerRadius(T.getDonutInnerRadius(t)).outerRadius(T.getDonutOuterRadius(t))(e)}).attr("fill",function(e){var t=d.select(this.parentNode.parentNode).datum();return O.link.getColor({label:e.label,type:b.link.LinkTypes.RELATION,source:t,target:{label:e.target}},"path","fill")}).attr("stroke",function(e){var t=d.select(this.parentNode.parentNode).datum();return O.link.getColor({label:e.label,type:b.link.LinkTypes.RELATION,source:t,target:{label:e.target}},"path","stroke")})},T.updateMiddlegroundElements=function(){var e=b.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-middleground");e.attr("clip-path",function(e){return"url(#node-view"+e.id+")"}),e.selectAll("*").remove(),T.updateMiddlegroundElementsTooltip(e),T.updateMiddlegroundElementsText(e.filter(function(e){return O.node.getNodeDisplayType(e)===O.node.DisplayTypes.TEXT})),T.updateMiddlegroundElementsImage(e.filter(function(e){return O.node.getNodeDisplayType(e)===O.node.DisplayTypes.IMAGE})),T.updateMiddlegroundElementsSymbol(e.filter(function(e){return O.node.getNodeDisplayType(e)===O.node.DisplayTypes.SYMBOL})),T.updateMiddlegroundElementsSVG(e.filter(function(e){return O.node.getNodeDisplayType(e)===O.node.DisplayTypes.SVG})),T.updateMiddlegroundElementsDisplayedText(e.filter(function(e){return O.node.isTextDisplayed(e)}))},T.updateMiddlegroundElementsTooltip=function(e){e.append("title").attr("class",function(e){return O.node.getCSSClass(e,"title")}).text(function(e){return O.node.getTextValue(e,T.NODE_TITLE_MAX_CHARS)})},T.updateMiddlegroundElementsText=function(e){e.append("circle").attr("r",function(e){return O.node.getSize(e)}).attr("class",function(e){return O.node.getCSSClass(e,"circle")}).attr("fill",function(e){return O.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return O.node.getColor(e,"circle","stroke")})},T.updateMiddlegroundElementsImage=function(e){e.append("circle").attr("r",function(e){return O.node.getSize(e)}).attr("class",function(e){return O.node.getCSSClass(e,"image-background-circle")}),e.append("image").attr("class",function(e){return O.node.getCSSClass(e,"image")}).attr("width",function(e){return O.node.getImageWidth(e)}).attr("height",function(e){return O.node.getImageHeight(e)}).attr("transform",function(e){return"translate("+-O.node.getImageWidth(e)/2+","+-O.node.getImageHeight(e)/2+")"}).attr("xlink:href",function(e){return O.node.getImagePath(e)})},T.updateMiddlegroundElementsSymbol=function(e){e.append("circle").attr("r",function(e){return O.node.getSize(e)}).attr("class",function(e){return O.node.getCSSClass(e,"symbol-background-circle")}).attr("fill",function(e){return O.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return O.node.getColor(e,"circle","stroke")}),e.append("use").attr("class",function(e){return O.node.getCSSClass(e,"symbol")}).attr("width",function(e){return O.node.getImageWidth(e)}).attr("height",function(e){return O.node.getImageHeight(e)}).attr("transform",function(e){return"translate("+-O.node.getImageWidth(e)/2+","+-O.node.getImageHeight(e)/2+")"}).attr("xlink:href",function(e){return O.node.getImagePath(e)}).attr("fill",function(e){return O.node.getColor(e,"circle","fill")}).attr("stroke",function(e){return O.node.getColor(e,"circle","stroke")})},T.updateMiddlegroundElementsSVG=function(e){var t=e.append("g"),n=(t.append("circle").attr("r",function(e){return O.node.getSize(e)}).attr("class","ppt-svg-node-background"),t.selectAll("path").data(function(e){return O.node.getSVGPaths(e)}));n.exit().remove(),n.enter().append("path"),t.selectAll("path").attr("class",function(e){var t=d.select(this.parentNode).datum();return O.node.getCSSClass(t,"path")}).each(function(e,t){for(var n in e)e.hasOwnProperty(n)&&d.select(this).attr(n,e[n])})},T.updateMiddlegroundElementsDisplayedText=function(e){var t=e.filter(function(e){return O.node.isTextDisplayed(e)});b.USE_FIT_TEXT?N.render(t):R.render(t)},T.updateForegroundElements=function(){var e=b.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-node-foreground-g-arrows");e.classed("active",function(e){return e.valueExpanded&&e.data&&e.data.length>T.PAGE_SIZE}),e.selectAll(".ppt-larrow").classed("enabled",function(e){return 1<e.page}),e.selectAll(".ppt-rarrow").classed("enabled",function(e){if(e.data){var t=e.data.length;return e.page*T.PAGE_SIZE<t}return!1});var t=b.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground");t.selectAll(".ppt-count-box").filter(function(e){return e.type!==T.NodeTypes.CHOOSE}).classed("root",!0),t.selectAll(".ppt-count-box").filter(function(e){return e.type===T.NodeTypes.CHOOSE}).classed("value",!0),t.selectAll(".ppt-count-box").classed("disabled",function(e){return 0===e.count}),b.DISABLE_COUNT||t.selectAll(".ppt-count-text").text(function(e){return null!==e.count?e.count:"..."}).classed("disabled",function(e){return 0===e.count}),b.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").filter(function(e){return!0===e.isNegative}).selectAll(".ppt-g-node-ban").attr("transform",function(e){return"translate("+-O.node.getSize(e)+","+-O.node.getSize(e)+") scale("+2*O.node.getSize(e)/100+")"}).attr("stroke-width",function(e){return 2/(2*O.node.getSize(e)/100)+"px"}),b.svg.select("#"+T.gID).selectAll(".ppt-gnode").selectAll(".ppt-g-node-foreground").selectAll(".ppt-g-node-ban").classed("active",function(e){return!0===e.isNegative})},T.segmentClick=function(e){d.event.preventDefault();var t=d.select(this.parentNode.parentNode).datum();b.ignoreCount=!0,b.addRelationshipData(t,e,function(t){b.notifyListeners(b.Events.GRAPH_NODE_RELATION_ADD,[m.links.filter(function(e){return e.target===t})]),b.ignoreCount=!1,b.hasGraphChanged=!0,f()})},T.mouseOverNode=function(){d.event.preventDefault();var t=d.select(this).data()[0];L.isActive&&(L.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!0),L.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!0)),I.isActive&&I.querySpanElements.filter(function(e){return e.node===t}).classed("hover",!0)},T.mouseOutNode=function(){d.event.preventDefault();var t=d.select(this).data()[0];L.isActive&&(L.queryConstraintSpanElements.filter(function(e){return e.ref===t}).classed("hover",!1),L.querySpanElements.filter(function(e){return e.ref===t}).classed("hover",!1)),I.isActive&&I.querySpanElements.filter(function(e){return e.node===t}).classed("hover",!1)},T.nodeClick=function(){if(!d.event.defaultPrevented){var e=d.select(this).data()[0];if(p.debug("nodeClick ("+e.label+")"),p.debug("Hibiki node type value: "+e.type),e.type===T.NodeTypes.VALUE)p.info("Hibiki! ATTRI CHECK: "+e.attributes.name),T.valueNodeClick(e);else if(e.type===T.NodeTypes.CHOOSE||e.type===T.NodeTypes.ROOT)if(d.event.ctrlKey){if(e.type===T.NodeTypes.CHOOSE){if(e.isNegative=!e.hasOwnProperty("isNegative")||!e.isNegative,T.collapseAllNode(),e.hasOwnProperty("value")&&0<e.value.length);else if(e.isNegative){for(var t=m.links.length-1;0<=t;t--)m.links[t].source===e&&T.removeNode(m.links[t].target);e.count=0}g.hasChanged=!0,b.hasGraphChanged=!0,f()}}else e.valueExpanded?T.collapseNode(e):T.chooseNodeClickHibiki(e)}},T.collapseNode=function(t){if(t.valueExpanded){p.debug("collapseNode ("+t.label+")"),b.notifyListeners(b.Events.GRAPH_NODE_VALUE_COLLAPSE,[t]);var e=m.links.filter(function(e){return e.source===t&&e.type===b.link.LinkTypes.VALUE});e.forEach(function(e){m.nodes.splice(m.nodes.indexOf(e.target),1)});for(var n=m.links.length-1;0<=n;n--)0<=e.indexOf(m.links[n])&&m.links.splice(n,1);t.type!==T.NodeTypes.ROOT&&(t.fixed=!1,t.fx=null,t.fy=null),t.parent&&t.parent.type!==T.NodeTypes.ROOT&&(t.parent.fixed=!1,t.parent.fx=null,t.parent.fy=null),t.valueExpanded=!1,f()}else p.debug("collapseNode called on an unexpanded node")},T.collapseAllNode=function(){m.nodes.forEach(function(e){e.type!==T.NodeTypes.CHOOSE&&e.type!==T.NodeTypes.ROOT||!e.valueExpanded||T.collapseNode(e)})},T.valueNodeClick=function(e){p.debug("valueNodeClick ("+e.label+")"),b.notifyListeners(b.Events.GRAPH_NODE_ADD_VALUE,[e]),void 0===e.parent.value&&(e.parent.value=[]),e.parent.value.push(e),g.hasChanged=!0,b.hasGraphChanged=!0,T.collapseNode(e.parent)},T.chooseNodeClickHibiki=function(a){if(p.debug("chooseNodeClick ("+a.label+") with waiting state set to "+T.chooseWaiting),!T.chooseWaiting&&!a.immutable&&0!==a.count)if(T.collapseAllNode(),T.chooseWaiting=!0,void 0!==a.data&&a.isAutoLoadValue)a.page=1,T.expandNode(a),T.chooseWaiting=!1;else if(p.info("Hibiki: chooseNodeClickHibiki "),p.info("Values ("+a.label+") ==>"),void 0!==a.value&&void 0!==a.value[0])p.info(a.label),p.info(a.value),p.info("Hibiki LENGTH "+a.value.length),p.info("Hibiki ID: "+a.value[0].attributes.uuid),p.info(window.location.hostname),c.post("model="+a.label+"&id="+a.value[0].attributes.uuid,"/interactive").done(function(e){p.info("<== Values ("+a.label+")"),p.info(e),a.data=e,a.page=1,T.expandNodeHibiki(a),T.chooseWaiting=!1}).fail(function(e,t,n){T.chooseWaiting=!1,p.error(t+': error while accessing Hibiki server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)});else{var e=A.generateNodeValueQuery(a);c.post({statements:[{statement:e.statement,parameters:e.parameters}]}).done(function(e){p.info("<== Values ("+a.label+")");var t=c.response.parse(e),r=O.node.getConstraintAttribute(a.label);a.data=t[0].filter(function(t){var n=!0;return a.hasOwnProperty("value")&&0<a.value.length&&a.value.forEach(function(e){e.attributes[r]===t[r]&&(n=!1)}),n}),p.info("Hibiki: What's the data? "),p.info(a.data),a.page=1,T.expandNode(a),T.chooseWaiting=!1}).fail(function(e,t,n){T.chooseWaiting=!1,p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)})}},T.chooseNodeClick=function(a){if(p.debug("chooseNodeClick ("+a.label+") with waiting state set to "+T.chooseWaiting),!T.chooseWaiting&&!a.immutable&&0!==a.count)if(T.collapseAllNode(),T.chooseWaiting=!0,void 0!==a.data&&a.isAutoLoadValue)a.page=1,T.expandNode(a),T.chooseWaiting=!1;else{p.info("Values ("+a.label+") ==>");var e=A.generateNodeValueQuery(a);c.post({statements:[{statement:e.statement,parameters:e.parameters}]}).done(function(e){p.info("<== Values ("+a.label+")");var t=c.response.parse(e),r=O.node.getConstraintAttribute(a.label);a.data=t[0].filter(function(t){var n=!0;return a.hasOwnProperty("value")&&0<a.value.length&&a.value.forEach(function(e){e.attributes[r]===t[r]&&(n=!1)}),n}),a.page=1,T.expandNode(a),T.chooseWaiting=!1}).fail(function(e,t,n){T.chooseWaiting=!1,p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n)})}},T.addExpandedValue=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].valueExpanded){for(var a=m.nodes[r].data.length-1;0<=a;a--)m.nodes[r].data[a][e]===t&&(n=!0,m.nodes[r].hasOwnProperty("value")||(m.nodes[r].value=[]),m.nodes[r].value.push({attributes:m.nodes[r].data[a]}),m.nodes[r].data.splice(a,1));T.collapseNode(m.nodes[r]),T.expandNode(m.nodes[r])}n&&(g.hasChanged=!0,b.hasGraphChanged=!0,f())},T.getContainingValue=function(n){var r=[],e=m.links,t=m.nodes;if(0<t.length){var a=t[0];void 0!==a.value&&0<a.value.length&&(void 0!==n&&n!==a.label||r.push(a)),e.forEach(function(e){var t=e.target;e.type===b.link.LinkTypes.RELATION&&void 0!==t.value&&0<t.value.length&&(void 0!==n&&n!==t.label||r.push(t))})}return r},T.addValueForLabel=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].type===T.NodeTypes.CHOOSE&&m.nodes[r].label===e){m.nodes[r].hasOwnProperty("value")||(m.nodes[r].value=[]);var a=!1,o=O.node.getConstraintAttribute(e);m.nodes[r].value.forEach(function(e){e.attributes.hasOwnProperty(o)&&e.attributes[o]===t.attributes[o]&&(a=!0)}),a||(m.nodes[r].value.push(t),n=!0)}return n},T.addValue=function(e,t){for(var n=!1,r=0;r<m.nodes.length;r++){var a=m.nodes[r];if(0<=e.indexOf(a.id)){a.hasOwnProperty("value")||(a.value=[]);var o=O.node.getReturnAttributes(a.label)[0];a.data.forEach(function(e){e.hasOwnProperty(o)&&e[o]===t&&(n=!0,a.value.push({attributes:e}))})}}n&&(g.hasChanged=!0,b.hasGraphChanged=!0,f())},T.removeValue=function(e,t){for(var n=!1,r=e.value.length-1;0<=r;r--)e.value[r]===t&&(T.collapseNode(e),e.value.splice(r,1),n=!0);return n},T.getValue=function(e,t){for(var n=0;n<m.nodes.length;n++){var r=m.nodes[n];if(r.id===e)for(var a=O.node.getConstraintAttribute(r.label),o=r.value.length-1;0<=o;o--)if(r.value[o].attributes[a]===t)return r.value[o]}},T.removeExpandedValue=function(e,t){for(var n=!1,r=m.nodes.length-1;0<=r;r--)if(m.nodes[r].valueExpanded){for(var a=[],o=m.nodes[r].value.length-1;0<=o;o--)m.nodes[r].value[o].attributes[e]===t&&(n=!0,a=a.concat(m.nodes[r].value.splice(o,1)));for(var l=0;l<a.length;l++)m.nodes[r].data.push(a[l].attributes);T.collapseNode(m.nodes[r]),T.expandNode(m.nodes[r])}n&&(g.hasChanged=!0,b.hasGraphChanged=!0,f())},T.getAutoLoadValueNodes=function(){return m.nodes.filter(function(e){return e.hasOwnProperty("isAutoLoadValue")&&!0===e.isAutoLoadValue&&!(!0===e.isNegative)})},T.addRelatedValues=function(u,e,d){var t=T.filterExistingValues(u,e);if(!(t.length<=0)){var o=[];t.forEach(function(e){var t=O.node.getConstraintAttribute(e.label),n="MATCH ";t===A.NEO4J_INTERNAL_ID?n+="(v:`"+e.label+"`) WHERE (ID(v) = $p)":n+="(v:`"+e.label+"`) WHERE (v."+t+" = $p)";var r=O.node.getReturnAttributes(e.label),a="";n+=' RETURN DISTINCT "'+e.rel+'" AS rel, "'+e.label+'" AS label, {'+r.reduce(function(e,t){return e+=a+t+":v."+t,a=", ",e},"")+"} AS value LIMIT 1",o.push({statement:n,parameters:{p:e.id},resultDataContents:["row"]})}),p.info("addRelatedValues ==>"),c.post({statements:o}).done(function(e){p.info("<== addRelatedValues");var i=c.response.parse(e),s=0;i.forEach(function(e){if(0<e.length){var t=e[0].label,n=e[0].value,r=e[0].rel,a={id:m.generateId(),parent:u,attributes:n,type:T.NodeTypes.VALUE,label:t};b.ignoreCount=!0;var o=u.relationships.filter(function(e){return e.label===r&&e.target===t}),l={label:r,target:t};0<o.length&&(l=o[0]),b.addRelationshipData(u,l,function(){++s===i.length&&(b.ignoreCount=!1,b.hasGraphChanged=!0,g.hasChanged=!0,f())},[a],d)}})}).fail(function(e,t,n){console.error(e,t,n)})}},T.addRelatedBranch=function(e,t,n,r){if(0<t.length){var a=t[0];t=t.slice(1);var o=e.relationships.filter(function(e){return e.label===a.type&&e.target===a.target});0<o.length&&b.addRelationshipData(e,o[0],function(e){T.addRelatedBranch(e,t,n,r)})}else T.addRelatedValues(e,n,r)},T.filterExistingValues=function(e,t){var a=[],o=m.nodes.filter(function(e){return e.parent===e&&e.hasOwnProperty("value")&&0<e.value.length});return t.forEach(function(t){var n=!1,r=O.node.getConstraintAttribute(t.label);o.forEach(function(e){e.label===t.label&&e.value.forEach(function(e){e.attributes[r]===t.id&&(n=!0)})}),n||a.push(t)}),a},T.expandNodeHibiki=function(o){b.notifyListeners(b.Events.GRAPH_NODE_VALUE_EXPAND,[o]);var e=o.page*T.PAGE_SIZE,t=e-T.PAGE_SIZE,l=o.data.slice(t,e),i=b.computeParentAngle(o),s=1;l.forEach(function(e){var t;t=o.parent?360/(l.length+1)*s:360/l.length*s;var n=o.x+100*Math.cos(t*(Math.PI/180)-i),r=o.y+100*Math.sin(t*(Math.PI/180)-i);p.info(e);var a={id:m.generateId(),parent:o,attributes:e,type:T.NodeTypes.VALUE,label:e.label,count:e.count,x:n,y:r,internalID:e[A.NEO4J_INTERNAL_ID.queryInternalName]};m.nodes.push(a),m.links.push({id:"l"+m.generateId(),source:o,target:a,type:b.link.LinkTypes.RELATION}),s++}),o.fixed=!0,o.fx=o.x,o.fy=o.y,o.parent&&o.parent.type!==T.NodeTypes.ROOT&&(o.parent.fixed=!0,o.parent.fx=o.parent.x,o.parent.fy=o.parent.y),o.valueExpanded=!0,f()},T.expandNode=function(o){b.notifyListeners(b.Events.GRAPH_NODE_VALUE_EXPAND,[o]);var e=o.page*T.PAGE_SIZE,t=e-T.PAGE_SIZE,l=o.data.slice(t,e),i=b.computeParentAngle(o),s=1;l.forEach(function(e){var t;t=o.parent?360/(l.length+1)*s:360/l.length*s;var n=o.x+100*Math.cos(t*(Math.PI/180)-i),r=o.y+100*Math.sin(t*(Math.PI/180)-i);p.info(e);var a={id:m.generateId(),parent:o,attributes:e,type:T.NodeTypes.VALUE,label:o.label,count:e.count,x:n,y:r,internalID:e[A.NEO4J_INTERNAL_ID.queryInternalName]};m.nodes.push(a),m.links.push({id:"l"+m.generateId(),source:o,target:a,type:b.link.LinkTypes.VALUE}),s++}),o.fixed=!0,o.fx=o.x,o.fy=o.y,o.parent&&o.parent.type!==T.NodeTypes.ROOT&&(o.parent.fixed=!0,o.parent.fx=o.parent.x,o.parent.fy=o.parent.y),o.valueExpanded=!0,f()},T.loadRelationshipData=function(n,r,a){var e=O.node.getSchema(n.label);if(void 0!==e)e.hasOwnProperty("rel")&&0<e.rel.length?r(T.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(e.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})):r([]);else{var t=A.generateNodeRelationQuery(n);p.info("Relations ("+n.label+") ==>"),c.post({statements:[{statement:t.statement,parameters:t.parameters}]}).done(function(e){p.info("<== Relations ("+n.label+")");var t=c.response.parse(e)[0].filter(function(e){return A.filterRelation(e)});t=T.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(t).map(function(e){return{id:e.data.label+e.data.target,label:e.data.label,target:e.data.target,count:e.data.count,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2}}),r(t)}).fail(function(e,t,n){p.error(t+': error while accessing Neo4j server on URL:"'+c.CYPHER_URL+'" defined in "rest.CYPHER_URL" property: '+n),r([])})}},T.expandRelationships=function(e,t){var n=0;if(e.hasOwnProperty("relationships")&&0<e.relationships.length)for(var r=0;r<e.relationships.length;r++)b.addRelationshipData(e,e.relationships[r],function(){++n===e.relationships.length&&t()});else t()},T.removeNode=function(t){var n=t.hasOwnProperty("value")&&0<t.value.length;m.links.filter(function(e){return e.source===t}).forEach(function(e){var t=T.removeNode(e.target);n=n||t});for(var e=m.links.length-1;0<=e;e--)m.links[e].target===t&&m.links.splice(e,1);return m.nodes.splice(m.nodes.indexOf(t),1),n},T.clearSelection=function(){d.event.preventDefault();var e=d.select(this).data()[0];if(T.collapseAllNode(),void 0!==e.value&&0<e.value.length&&!e.immutable){if(e.value.pop(),!0===e.isNegative&&0===e.value.length){for(var t=m.links.length-1;0<=t;t--)m.links[t].source===e&&T.removeNode(m.links[t].target);e.count=0}g.hasChanged=!0,b.hasGraphChanged=!0,f()}};var b={};b.link=a,b.node=T,b.DISABLE_RELATION=!1,b.DISABLE_COUNT=!1,b.containerId="popoto-graph",b.hasGraphChanged=!0,b.zoom=d.zoom().scaleExtent([.1,10]),b.WHEEL_ZOOM_ENABLED=!0,b.USE_DONUT_FORCE=!1,b.USE_VORONOI_LAYOUT=!1,b.USE_FIT_TEXT=!1,b.Events=Object.freeze({NODE_ROOT_ADD:"root.node.add",NODE_EXPAND_RELATIONSHIP:"node.expandRelationship",GRAPH_SAVE:"graph.save",GRAPH_RESET:"graph.reset",GRAPH_NODE_RELATION_ADD:"graph.node.relation_add",GRAPH_NODE_VALUE_EXPAND:"graph.node.value_expand",GRAPH_NODE_VALUE_COLLAPSE:"graph.node.value_collapse",GRAPH_NODE_ADD_VALUE:"graph.node.add_value",GRAPH_NODE_DATA_LOADED:"graph.node.data_loaded"}),b.listeners={},b.on=function(e,t){b.listeners.hasOwnProperty(e)||(b.listeners[e]=[]),b.listeners[e].push(t)},b.notifyListeners=function(t,n){b.listeners.hasOwnProperty(t)&&b.listeners[t].forEach(function(e){e.apply(t,n)})},b.onSave=function(e){b.on(b.Events.GRAPH_SAVE,e)},b.onReset=function(e){b.on(b.Events.GRAPH_RESET,e)},b.setDefaultGraph=function(e){e.mainLabel=e},b.createGraphArea=function(){var e=d.select("#"+b.containerId);r.render(e),b.svgTag=e.append("svg").attr("class","ppt-svg-graph").call(b.zoom.on("zoom",b.rescale)),b.svgTag.on("dblclick.zoom",null),b.WHEEL_ZOOM_ENABLED||b.svgTag.on("wheel.zoom",null).on("mousewheel.zoom",null),b.svgdefs=b.svgTag.append("defs"),b.svgdefs.append("marker").attr("id","cross").attr("refX",10).attr("refY",10).attr("markerWidth",20).attr("markerHeight",20).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-cross").attr("d","M5,5 L15,15 M15,5 L5,15"),b.svgdefs.append("marker").attr("id","arrow").attr("refX",9).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-arrow").attr("d","M0,0 L0,6 L9,3 z"),b.svgdefs.append("marker").attr("id","reverse-arrow").attr("refX",0).attr("refY",3).attr("markerWidth",10).attr("markerHeight",10).attr("markerUnits","strokeWidth").attr("orient","auto").append("path").attr("class","ppt-marker-reverse-arrow").attr("d","M0,3 L9,6 L9,0 z"),b.svgdefs.append("filter").attr("id","grayscale").append("feColorMatrix").attr("type","saturate").attr("values","0");var t=b.svgdefs.append("filter").attr("id","gooey");t.append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation","10").attr("color-interpolation-filters","sRGB").attr("result","blur"),t.append("feColorMatrix").attr("class","blurValues").attr("in","blur").attr("mode","matrix").attr("values","1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 35 -6").attr("result","gooey"),t.append("feBlend").attr("in","SourceGraphic").attr("in2","gooey").attr("operator","atop"),b.svgdefs.append("g").attr("id","voronoi-clip-path"),b.svg=b.svgTag.append("svg:g"),b.svg.append("g").attr("id",b.link.gID),b.svg.append("g").attr("id",b.node.gID),window.addEventListener("resize",b.centerRootNode)},b.getRootNode=function(){return m.getRootNode()},b.centerRootNode=function(){m.getRootNode().fx=b.getSVGWidth()/2,m.getRootNode().fy=b.getSVGHeight()/2,f()},b.getSVGWidth=function(){return void 0===b.svg||b.svg.empty()?(p.debug("graph.svg is undefined or empty."),0):document.getElementById(b.containerId).clientWidth},b.getSVGHeight=function(){return void 0===b.svg||b.svg.empty()?(p.debug("graph.svg is undefined or empty."),0):document.getElementById(b.containerId).clientHeight},b.rescale=function(){b.svg.attr("transform",d.event.transform)},b.CHARGE=-500,b.createForceLayout=function(){b.force=d.forceSimulation().force("charge",d.forceManyBody().strength(function(e){return e.charge?e.charge:b.CHARGE})).force("link",d.forceLink().id(function(e){return e.id}).distance(O.link.getDistance)),b.force.nodes(m.nodes),b.force.force("link").links(m.links),b.force.on("tick",b.tick)},b.addRootNode=function(t){if(0<m.nodes.length&&p.warn("graph.addRootNode is called but the graph is not empty."),void 0!==O.node.getSchema(t))b.addSchema(O.node.getSchema(t));else{var n={id:m.generateId(),type:b.node.NodeTypes.ROOT,x:b.getSVGWidth()/2,y:b.getSVGHeight()/2,fx:b.getSVGWidth()/2,fy:b.getSVGHeight()/2,tx:b.getSVGWidth()/2,ty:b.getSVGHeight()/2,label:t,fixed:!0,internalLabel:b.node.generateInternalLabel(t),relationships:[],isAutoLoadValue:!0===O.node.getIsAutoLoadValue(t)};m.nodes.push(n),b.notifyListeners(b.Events.NODE_ROOT_ADD,[n]),b.node.loadRelationshipData(n,function(e){n.relationships=e,O.node.getIsAutoExpandRelations(t)?(b.ignoreCount=!0,b.node.expandRelationships(n,function(){b.ignoreCount=!1,b.hasGraphChanged=!0,h()})):(b.hasGraphChanged=!0,h())},Math.PI/2)}},b.loadSchema=function(e){0<m.nodes.length&&p.warn("graph.loadSchema is called but the graph is not empty.");var t=e,n={id:m.generateId(),type:b.node.NodeTypes.ROOT,x:b.getSVGWidth()/2,y:b.getSVGHeight()/2,fx:b.getSVGWidth()/2,fy:b.getSVGHeight()/2,tx:b.getSVGWidth()/2,ty:b.getSVGHeight()/2,label:t.label,fixed:!0,internalLabel:b.node.generateInternalLabel(t.label),relationships:[],isAutoLoadValue:!0===O.node.getIsAutoLoadValue(t.label)};m.nodes.push(n),b.notifyListeners(b.Events.NODE_ROOT_ADD,[n]);var r=O.node.getSchema(e.label);if(void 0!==r&&r.hasOwnProperty("rel")&&0<r.rel.length){var a=Math.PI/2;n.relationships=b.node.pie.startAngle(a-Math.PI).endAngle(a+Math.PI)(r.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}else b.node.loadRelationshipData(n,function(e){n.relationships=e,b.hasGraphChanged=!0,h()},Math.PI/2);if(t.hasOwnProperty("value")){var o=[].concat(t.value);n.value=[],o.forEach(function(e){n.value.push({id:m.generateId(),parent:n,attributes:e,type:b.node.NodeTypes.VALUE,label:n.label})})}if(t.hasOwnProperty("rel"))for(var l=0;l<t.rel.length;l++)b.loadSchemaRelation(t.rel[l],n,l+1,t.rel.length)},b.loadSchemaRelation=function(e,t,n,r){var a=e.target,o=b.loadSchemaNode(a,t,n,r,e.label,e.hasOwnProperty("isReverse")&&!0===e.isReverse),l={id:"l"+m.generateId(),source:t,target:o,type:b.link.LinkTypes.RELATION,label:e.label,schema:e};m.links.push(l);var i=O.node.getSchema(a.label);if(void 0!==i&&i.hasOwnProperty("rel")&&0<i.rel.length){var s=Math.PI/2;o.relationships=b.node.pie.startAngle(s-Math.PI).endAngle(s+Math.PI)(i.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}else b.node.loadRelationshipData(o,function(e){o.relationships=e,b.hasGraphChanged=!0,h()},Math.PI/2);if(a.hasOwnProperty("rel"))for(var u=0;u<a.rel.length;u++)b.loadSchemaRelation(a.rel[u],o,u+1,a.rel.length)},b.loadSchemaNode=function(e,t,n,r,a,o){var l,i=O.node.getIsGroup(e),s=b.computeParentAngle(t);l=s?360/(r+1)*n:360/r*n;var u=t.x+200*Math.cos(l*(Math.PI/180)-s),d=t.y+200*Math.sin(l*(Math.PI/180)-s),p={id:m.generateId(),parent:t,parentRel:a,type:i?b.node.NodeTypes.GROUP:b.node.NodeTypes.CHOOSE,label:e.label,fixed:!1,internalLabel:b.node.generateInternalLabel(e.label),x:u,y:d,schema:e,isAutoLoadValue:!0===O.node.getIsAutoLoadValue(e.label),relationships:[]};if(!0===o&&(p.isParentRelReverse=!0),e.hasOwnProperty("isNegative")&&!0===e.isNegative&&(p.isNegative=!0,p.count=0),m.nodes.push(p),e.hasOwnProperty("value")){var c=[].concat(e.value);p.value=[],c.forEach(function(e){p.value.push({id:m.generateId(),parent:p,attributes:e,type:b.node.NodeTypes.VALUE,label:p.label})})}return p},b.addSchema=function(e){0<m.nodes.length&&p.warn("graph.addSchema is called but the graph is not empty.");var t=e,n={id:m.generateId(),type:b.node.NodeTypes.ROOT,x:b.getSVGWidth()/2,y:b.getSVGHeight()/2,fx:b.getSVGWidth()/2,fy:b.getSVGHeight()/2,tx:b.getSVGWidth()/2,ty:b.getSVGHeight()/2,label:t.label,fixed:!0,internalLabel:b.node.generateInternalLabel(t.label),relationships:[],isAutoLoadValue:!0===O.node.getIsAutoLoadValue(t.label)};if(m.nodes.push(n),b.notifyListeners(b.Events.NODE_ROOT_ADD,[n]),t.hasOwnProperty("rel")&&0<t.rel.length){var r=Math.PI/2;n.relationships=b.node.pie.startAngle(r-Math.PI).endAngle(r+Math.PI)(t.rel).map(function(e){var t={id:e.data.label+e.data.target.label,label:e.data.label,target:e.data.target.label,count:0,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2};return!0===e.data.isReverse&&(t.isReverse=!0),t})}},b.addSchemaRelation=function(e,t,n,r){var a=e.target,o=b.addSchemaNode(a,t,n,r,e.label),l={id:"l"+m.generateId(),source:t,target:o,type:b.link.LinkTypes.RELATION,label:e.label,schema:e};m.links.push(l)},b.addSchemaNode=function(e,t,n,r,a){var o,l=O.node.getIsGroup(e),i=e.hasOwnProperty("collapsed")&&!0===e.collapsed,s=b.computeParentAngle(t);o=s?360/(r+1)*n:360/r*n;var u=t.x+200*Math.cos(o*(Math.PI/180)-s),d=t.y+200*Math.sin(o*(Math.PI/180)-s),p={id:m.generateId(),parent:t,parentRel:a,type:l?b.node.NodeTypes.GROUP:b.node.NodeTypes.CHOOSE,label:e.label,fixed:!1,internalLabel:b.node.generateInternalLabel(e.label),x:u,y:d,schema:e,isAutoLoadValue:!0===O.node.getIsAutoLoadValue(e.label),relationships:[]};if(e.hasOwnProperty("rel")&&0<e.rel.length){for(var c={},g=[],f=0;f<e.rel.length;f++){var h=e.rel[f],v=h.label+h.target.label;c.hasOwnProperty(v)||(c[v]=h,g.push(h))}p.relationships=b.node.pie(g).map(function(e){return{id:e.data.label+e.data.target.label,count:e.data.count||0,label:e.data.label,target:e.data.target.label,startAngle:e.startAngle,endAngle:e.endAngle,directionAngle:(e.startAngle+e.endAngle)/2}})}if(e.hasOwnProperty("value")){var E=[].concat(e.value);p.value=[],E.forEach(function(e){p.value.push({id:m.generateId(),parent:p,attributes:e,type:b.node.NodeTypes.VALUE,label:p.label})})}if(m.nodes.push(p),!i&&e.hasOwnProperty("rel"))for(var y=0;y<e.rel.length;y++)b.addSchemaRelation(e.rel[y],p,y+1,e.rel.length);return p},b.getSchema=function(){var a={},t=m.getRootNode();a[t.id]={label:t.label},t.hasOwnProperty("value")&&(a[t.id].value=[],t.value.forEach(function(e){a[t.id].value.push(e.attributes)}));var e=m.links;return 0<e.length&&e.forEach(function(e){if(e.type===b.link.LinkTypes.RELATION){var t=e.source,n=e.target;a.hasOwnProperty(t.id)||(a[t.id]={label:t.label},t.hasOwnProperty("isNegative")&&!0===t.isNegative&&(a[t.id].isNegative=!0),t.hasOwnProperty("value")&&(a[t.id].value=[],t.value.forEach(function(e){a[t.id].value.push(e.attributes)}))),a.hasOwnProperty(n.id)||(a[n.id]={label:n.label},n.hasOwnProperty("isNegative")&&!0===n.isNegative&&(a[n.id].isNegative=!0),n.hasOwnProperty("value")&&(a[n.id].value=[],n.value.forEach(function(e){a[n.id].value.push(e.attributes)}))),a[t.id].hasOwnProperty("rel")||(a[t.id].rel=[]);var r={label:e.label,target:a[n.id]};n.hasOwnProperty("isParentRelReverse")&&!0===n.isParentRelReverse&&(r.isReverse=!0),a[t.id].rel.push(r)}}),a[t.id]},b.tick=function(){var e=b.svg.selectAll("#"+b.link.gID+" > g");if(e.selectAll(".ppt-link").attr("d",function(e){var t=e.source,n=e.target,r=b.computeParentAngle(n),a=O.node.getSize(t),o=O.node.getSize(n);!b.DISABLE_RELATION&&t.hasOwnProperty("relationships")&&0<t.relationships.length&&(a=b.node.getDonutOuterRadius(t)),!b.DISABLE_RELATION&&n.hasOwnProperty("relationships")&&0<n.relationships.length&&(o=b.node.getDonutOuterRadius(n));var l=n.x+o*Math.cos(r),i=n.y-o*Math.sin(r),s=t.x-a*Math.cos(r),u=t.y+a*Math.sin(r),d=(l+s)/2,p=(i+u)/2;return t.x<=n.x||!0===b.ignoreMirroLinkLabels?"M"+s+" "+u+"L"+d+" "+p+"L"+l+" "+i:"M"+l+" "+i+"L"+d+" "+p+"L"+s+" "+u}).attr("marker-end",function(e){if(b.link.SHOW_MARKER)if(!0===e.target.isParentRelReverse){if(e.source.x>e.target.x)return"url(#arrow)"}else if(e.source.x<=e.target.x)return"url(#arrow)";return null}).attr("marker-start",function(e){if(b.link.SHOW_MARKER)if(!0===e.target.isParentRelReverse){if(e.source.x<=e.target.x)return"url(#reverse-arrow)"}else if(e.source.x>e.target.x)return"url(#reverse-arrow)";return null}),e.selectAll(".ppt-textPath").attr("xlink:href",function(e){return"#ppt-path_"+e.id}),b.svg.selectAll("#"+b.node.gID+" > g").attr("transform",function(e){return"translate("+e.x+","+e.y+")"}),!0===b.USE_VORONOI_LAYOUT){var t=d.select("#voronoi-clip-path").selectAll(".voroclip").data(b.recenterVoronoi(m.nodes),function(e){return e.point.id});t.enter().append("clipPath").attr("id",function(e){return"voroclip-"+e.point.id}).attr("class","voroclip"),t.exit().remove(),t.selectAll("path").remove(),t.append("path").attr("id",function(e){return"pvoroclip-"+e.point.id}).attr("d",function(e){return"M"+e.join(",")+"Z"})}},b.computeParentAngle=function(e){var t=0;if(e.parent){var n=e.parent.x,r=e.parent.y,a=e.x,o=e.y,l=100/(Math.sqrt(Math.pow(n-a,2)+Math.pow(r-o,2))-100),i=((a+l*n)/(1+l)-a)/100;i<-1&&(i=-1),1<i&&(i=1),t=Math.acos(i),o<r&&(t=2*Math.PI-t)}return t},b.addRelationshipData=function(e,t,n,r,a){var o={id:""+m.generateId(),parent:e,parentRel:t.label,type:b.node.NodeTypes.CHOOSE,label:t.target,fixed:!1,internalLabel:b.node.generateInternalLabel(t.target),relationships:[]};!0===t.isReverse&&(o.isParentRelReverse=!0),void 0!==r&&0<r.length&&(o.value=r),void 0!==a&&!0===a&&(o.isNegative=!0);var l={id:"l"+m.generateId(),source:e,target:o,type:b.link.LinkTypes.RELATION,label:t.label};o.x=e.x+2*O.link.getDistance(l)/3*Math.cos(t.directionAngle-Math.PI/2)+10*Math.random(),o.y=e.y+2*O.link.getDistance(l)/3*Math.sin(t.directionAngle-Math.PI/2)+10*Math.random(),o.tx=e.tx+O.link.getDistance(l)*Math.cos(t.directionAngle-Math.PI/2),o.ty=e.ty+O.link.getDistance(l)*Math.sin(t.directionAngle-Math.PI/2),m.nodes.push(o),m.links.push(l),b.hasGraphChanged=!0,h(),b.node.loadRelationshipData(o,function(e){o.relationships=e,b.hasGraphChanged=!0,h(),O.node.getIsAutoExpandRelations(o.label)?b.node.expandRelationships(o,function(){n(o)}):n(o)},t.directionAngle)},b.voronoi=d.voronoi().x(function(e){return e.x}).y(function(e){return e.y}),b.recenterVoronoi=function(e){var r=[];return b.voronoi.polygons(e.map(function(e){return e.x=e.x||0,e.y=e.y||0,e})).forEach(function(t){if(t.length){var n=[];t.forEach(function(e){n.push([e[0]-t.data.x,e[1]-t.data.y])}),n.point=t.data,r.push(n)}}),r};var O={};O.colorScale=d.scaleOrdinal(d.schemeCategory10),O.link={},O.link.Provider={},O.taxonomy={},O.taxonomy.Provider={},O.node={},O.node.Provider={},O.link.getTextValue=function(e){return O.link.Provider.hasOwnProperty("getTextValue")?O.link.Provider.getTextValue(e):O.link.DEFAULT_PROVIDER.hasOwnProperty("getTextValue")?O.link.DEFAULT_PROVIDER.getTextValue(e):void p.error("No provider defined for link getTextValue")},O.link.getColor=function(e,t,n){return O.link.Provider.hasOwnProperty("getColor")?O.link.Provider.getColor(e,t,n):O.link.DEFAULT_PROVIDER.hasOwnProperty("getColor")?O.link.DEFAULT_PROVIDER.getColor(e,t,n):void p.error("No provider defined for getColor")},O.link.getCSSClass=function(e,t){return O.link.Provider.hasOwnProperty("getCSSClass")?O.link.Provider.getCSSClass(e,t):O.link.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass")?O.link.DEFAULT_PROVIDER.getCSSClass(e,t):void p.error("No provider defined for getCSSClass")},O.link.getDistance=function(e){return O.link.Provider.hasOwnProperty("getDistance")?O.link.Provider.getDistance(e):O.link.DEFAULT_PROVIDER.hasOwnProperty("getDistance")?O.link.DEFAULT_PROVIDER.getDistance(e):void p.error("No provider defined for getDistance")},O.link.getSemanticValue=function(e){return O.link.Provider.hasOwnProperty("getSemanticValue")?O.link.Provider.getSemanticValue(e):O.link.DEFAULT_PROVIDER.hasOwnProperty("getSemanticValue")?O.link.DEFAULT_PROVIDER.getSemanticValue(e):void p.error("No provider defined for getSemanticValue")},O.colorLuminance=function(e,t){(e=String(e).replace(/[^0-9a-f]/gi,"")).length<6&&(e=e[0]+e[0]+e[1]+e[1]+e[2]+e[2]),t=t||0;var n,r,a="#";for(r=0;r<3;r++)n=parseInt(e.substr(2*r,2),16),a+=("00"+(n=Math.round(Math.min(Math.max(0,n+n*t),255)).toString(16))).substr(n.length);return a},O.link.DEFAULT_PROVIDER={getTextValue:function(e){if(e.type===b.link.LinkTypes.VALUE)return O.node.isTextDisplayed(e.target)?"":O.node.getTextValue(e.target);var t="";return e.type===b.link.LinkTypes.SEGMENT&&(t=" "+O.node.getTextValue(e.target)),e.label+t},getDistance:function(e){return e.type===b.link.LinkTypes.VALUE?13/8*(O.node.getSize(e.source)+O.node.getSize(e.target)):2.5*(O.node.getSize(e.source)+O.node.getSize(e.target))},getColor:function(e,t,n){if(e.type===b.link.LinkTypes.VALUE)return"#525863";var r=e.source.label+e.label+e.target.label,a=O.colorScale(r);return"stroke"===n?O.colorLuminance(a,-.2):a},getCSSClass:function(e,t){var n="ppt-link__"+t;if(e.type===b.link.LinkTypes.VALUE)n+="--value";else{var r="ppt-"+e.label.replace(/[^0-9a-z\-_]/gi,"");e.type===b.link.LinkTypes.RELATION&&(n+="--relation",0===e.target.count&&(n+="--disabled"),n=n+" "+r)}return n},getSemanticValue:function(e){return O.link.getTextValue(e)}},O.link.Provider=O.link.DEFAULT_PROVIDER,O.taxonomy.getTextValue=function(e){return O.taxonomy.Provider.hasOwnProperty("getTextValue")?O.taxonomy.Provider.getTextValue(e):O.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getTextValue")?O.taxonomy.DEFAULT_PROVIDER.getTextValue(e):void p.error("No provider defined for taxonomy getTextValue")},O.taxonomy.getCSSClass=function(e,t){return O.taxonomy.Provider.hasOwnProperty("getCSSClass")?O.taxonomy.Provider.getCSSClass(e,t):O.taxonomy.DEFAULT_PROVIDER.hasOwnProperty("getCSSClass")?O.taxonomy.DEFAULT_PROVIDER.getCSSClass(e,t):void p.error("No provider defined for taxonomy getCSSClass")},O.taxonomy.DEFAULT_PROVIDER={getTextValue:function(e){return e},getCSSClass:function(e,t){return"ppt-taxo__"+t+" "+e.replace(/[^0-9a-z\-_]/gi,"")}},O.taxonomy.Provider=O.taxonomy.DEFAULT_PROVIDER,O.node.DisplayTypes=Object.freeze({TEXT:0,IMAGE:1,SVG:2,SYMBOL:3}),O.node.getProvider=function(e){if(void 0!==e){if(O.node.Provider.hasOwnProperty(e))return O.node.Provider[e];for(var t in p.debug("No direct provider found for label "+e),O.node.Provider)if(O.node.Provider.hasOwnProperty(t)){var n=O.node.Provider[t];if(n.hasOwnProperty("children")&&-1<n.children.indexOf(e)){p.debug("No provider is defined for label ("+e+"), parent ("+t+") will be used");var r={parent:t};for(var a in n)n.hasOwnProperty(a)&&"children"!==a&&"parent"!==a&&(r[a]=n[a]);return O.node.Provider[e]=r,O.node.Provider[e]}}for(var o in p.debug("No label provider defined for label ("+e+") default one will be created from provider.node.DEFAULT_PROVIDER"),O.node.Provider[e]={},O.node.DEFAULT_PROVIDER)O.node.DEFAULT_PROVIDER.hasOwnProperty(o)&&(O.node.Provider[e][o]=O.node.DEFAULT_PROVIDER[o]);return O.node.Provider[e]}p.error("Node label is undefined, no label provider can be found.")},O.node.getProperty=function(e,t){var n=O.node.getProvider(e);if(!n.hasOwnProperty(t)){for(var r=n,a=!1;r.hasOwnProperty("parent")&&!a;)(r=O.node.getProvider(r.parent)).hasOwnProperty(t)&&(n[t]=r[t],a=!0);a||(p.debug('No "'+t+'" property found for node label provider ('+e+"), default value will be used"),O.node.DEFAULT_PROVIDER.hasOwnProperty(t)?n[t]=O.node.DEFAULT_PROVIDER[t]:p.debug('No default value for "'+t+'" property found for label provider ('+e+")"))}return n[t]},O.node.getIsAutoLoadValue=function(e){return O.node.getProperty(e,"isAutoLoadValue")},O.node.getIsSearchable=function(e){return O.node.getProperty(e,"isSearchable")},O.node.getIsAutoExpandRelations=function(e){return O.node.getProperty(e,"autoExpandRelations")},O.node.getSchema=function(e){return O.node.getProperty(e,"schema")},O.node.getReturnAttributes=function(e){var t=O.node.getProvider(e),n={};if(t.hasOwnProperty("returnAttributes"))for(var r=0;r<t.returnAttributes.length;r++)t.returnAttributes[r]===A.NEO4J_INTERNAL_ID?n[A.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[t.returnAttributes[r]]=!0;for(;t.hasOwnProperty("parent");)if((t=O.node.getProvider(t.parent)).hasOwnProperty("returnAttributes"))for(var a=0;a<t.returnAttributes.length;a++)t.returnAttributes[a]===A.NEO4J_INTERNAL_ID?n[A.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[t.returnAttributes[a]]=!0;if(O.node.DEFAULT_PROVIDER.hasOwnProperty("returnAttributes"))for(var o=0;o<O.node.DEFAULT_PROVIDER.returnAttributes.length;o++)O.node.DEFAULT_PROVIDER.returnAttributes[o]!==A.NEO4J_INTERNAL_ID&&(n[O.node.DEFAULT_PROVIDER.returnAttributes[o]]=!0);var l=O.node.getConstraintAttribute(e);l===A.NEO4J_INTERNAL_ID?n[A.NEO4J_INTERNAL_ID.queryInternalName]=!0:n[l]=!0;var i=[];for(var s in n)n.hasOwnProperty(s)&&(s===A.NEO4J_INTERNAL_ID.queryInternalName?i.push(A.NEO4J_INTERNAL_ID):i.push(s));return i.length<=0&&i.push(A.NEO4J_INTERNAL_ID),i},O.node.getConstraintAttribute=function(e){return O.node.getProperty(e,"constraintAttribute")},O.node.getDisplayAttribute=function(e){var t=O.node.getProperty(e,"displayAttribute");if(void 0===t){var n=O.node.getReturnAttributes(e);t=0<n.length?n[0]:O.node.getConstraintAttribute(e)}return t},O.node.getPredefinedConstraints=function(e){return O.node.getProperty(e,"getPredefinedConstraints")()},O.node.filterResultQuery=function(e,t){return O.node.getProperty(e,"filterResultQuery")(t)},O.node.getValueOrderByAttribute=function(e){return O.node.getProperty(e,"valueOrderByAttribute")},O.node.isValueOrderAscending=function(e){return O.node.getProperty(e,"isValueOrderAscending")},O.node.getResultOrderByAttribute=function(e){return O.node.getProperty(e,"resultOrderByAttribute")},O.node.isResultOrderAscending=function(e){return O.node.getProperty(e,"isResultOrderAscending")},O.node.getTextValue=function(e,t){return O.node.getProperty(e.label,"getTextValue")(e,t)},O.node.getSemanticValue=function(e){return O.node.getProperty(e.label,"getSemanticValue")(e)},O.node.getSVGPaths=function(e){return O.node.getProperty(e.label,"getSVGPaths")(e)},O.node.isTextDisplayed=function(e){return O.node.getProperty(e.label,"getIsTextDisplayed")(e)},O.node.getSize=function(e){return O.node.getProperty(e.label,"getSize")(e)},O.node.getColor=function(e,t){return O.node.getProperty(e.label,"getColor")(e,t)},O.node.getCSSClass=function(e,t){return O.node.getProperty(e.label,"getCSSClass")(e,t)},O.node.getIsGroup=function(e){return O.node.getProperty(e.label,"getIsGroup")(e)},O.node.getNodeDisplayType=function(e){return O.node.getProperty(e.label,"getDisplayType")(e)},O.node.getImagePath=function(e){return O.node.getProperty(e.label,"getImagePath")(e)},O.node.getImageWidth=function(e){return O.node.getProperty(e.label,"getImageWidth")(e)},O.node.getImageHeight=function(e){return O.node.getProperty(e.label,"getImageHeight")(e)},O.node.filterNodeValueQuery=function(e,t){return O.node.getProperty(e.label,"filterNodeValueQuery")(e,t)},O.node.filterNodeCountQuery=function(e,t){return O.node.getProperty(e.label,"filterNodeCountQuery")(e,t)},O.node.filterNodeRelationQuery=function(e,t){return O.node.getProperty(e.label,"filterNodeRelationQuery")(e,t)},O.node.getGenerateNodeValueConstraints=function(e){return O.node.getProperty(e.label,"generateNodeValueConstraints")},O.node.getDisplayResults=function(e){return O.node.getProperty(e,"displayResults")},O.node.DEFAULT_PROVIDER={isSearchable:!0,autoExpandRelations:!1,isAutoLoadValue:!1,returnAttributes:[A.NEO4J_INTERNAL_ID],valueOrderByAttribute:"count",isValueOrderAscending:!1,resultOrderByAttribute:null,isResultOrderAscending:!0,constraintAttribute:A.NEO4J_INTERNAL_ID,displayAttribute:void 0,getPredefinedConstraints:function(){return[]},filterResultQuery:function(e){return e},getDisplayType:function(e){return O.node.DisplayTypes.TEXT},getSize:function(e){return 50},getColor:function(e){if(e.type===b.node.NodeTypes.VALUE)return O.node.getColor(e.parent);var t="";e.hasOwnProperty("parent")&&(t=e.parent.label);var n=t+(e.parentRel||"")+e.label;return O.colorScale(n)},getCSSClass:function(e,t){var n=e.label.replace(/[^0-9a-z\-_]/gi,""),r="ppt-node__"+t;return e.type===b.node.NodeTypes.ROOT&&(r+="--root"),e.type===b.node.NodeTypes.CHOOSE&&(r+="--choose"),e.type===b.node.NodeTypes.GROUP&&(r+="--group"),e.type===b.node.NodeTypes.VALUE&&(r+="--value"),void 0!==e.value&&0<e.value.length&&(r+="--value-selected"),0===e.count&&(r+="--disabled"),r+" "+n},getIsGroup:function(e){return!1},getIsTextDisplayed:function(e){return!0},getTextValue:function(e,t){var n="",r=O.node.getDisplayAttribute(e.label);if(e.type===b.node.NodeTypes.VALUE)n=r===A.NEO4J_INTERNAL_ID?""+e.internalID:""+e.attributes[r];else if(void 0!==e.value&&0<e.value.length)if(r===A.NEO4J_INTERNAL_ID){var a="";e.value.forEach(function(e){n+=a+e.internalID,a=" or "})}else{a="";e.value.forEach(function(e){n+=a+e.attributes[r],a=" or "})}else n=e.label;return n},getSemanticValue:function(e){var t="",n=O.node.getDisplayAttribute(e.label);if(e.type===b.node.NodeTypes.VALUE)t=n===A.NEO4J_INTERNAL_ID?""+e.internalID:""+e.attributes[n];else if(void 0!==e.value&&0<e.value.length)if(n===A.NEO4J_INTERNAL_ID){var r="";e.value.forEach(function(e){t+=r+e.internalID,r=" or "})}else{r="";e.value.forEach(function(e){t+=r+e.attributes[n],r=" or "})}else t=e.label;return t},getImagePath:function(e){return"image/node/"+e.label.toLowerCase()+"/"+e.label.toLowerCase()+".svg"},getSVGPaths:function(e){var t=O.node.getSize(e);return[{d:"M 0, 0 m -"+t+", 0 a "+t+","+t+" 0 1,0 "+2*t+",0 a "+t+","+t+" 0 1,0 -"+2*t+",0",fill:"transparent",stroke:O.node.getColor(e),"stroke-width":"2px"}]},getImageWidth:function(e){return 2*O.node.getSize(e)},getImageHeight:function(e){return 2*O.node.getSize(e)},filterNodeValueQuery:function(e,t){return t},filterNodeCountQuery:function(e,t){return t},filterNodeRelationQuery:function(e,t){return t},displayResults:function(r){var a=r.data()[0];O.node.getReturnAttributes(a.label).forEach(function(e){var t=r.append("div").attr("class","ppt-result-attribute-div"),n=e;A.NEO4J_INTERNAL_ID===e&&(n=A.NEO4J_INTERNAL_ID.queryInternalName),t.append("span").text(function(){return e===A.NEO4J_INTERNAL_ID?"internal ID:":e+":"}),void 0!==a.attributes[n]&&t.append("span").text(function(e){return e.attributes[n]})})}};var L={containerId:"popoto-query",QUERY_STARTER:"I'm looking for",CHOOSE_LABEL:"choose",createQueryArea:function(){var e="#"+L.containerId;L.queryConstraintSpanElements=d.select(e).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan"),L.querySpanElements=d.select(e).append("p").attr("class","ppt-query-elements").selectAll(".querySpan")},updateQuery:function(){L.queryConstraintSpanElements=L.queryConstraintSpanElements.data([]),L.querySpanElements=L.querySpanElements.data([]),L.queryConstraintSpanElements.exit().remove(),L.querySpanElements.exit().remove(),L.queryConstraintSpanElements=L.queryConstraintSpanElements.data(L.generateConstraintData(m.links,m.nodes)),L.querySpanElements=L.querySpanElements.data(L.generateData(m.links,m.nodes)),L.queryConstraintSpanElements=L.queryConstraintSpanElements.enter().append("span").on("contextmenu",L.rightClickSpan).on("click",L.clickSpan).on("mouseover",L.mouseOverSpan).on("mouseout",L.mouseOutSpan).merge(L.queryConstraintSpanElements),L.querySpanElements=L.querySpanElements.enter().append("span").on("contextmenu",L.rightClickSpan).on("click",L.clickSpan).on("mouseover",L.mouseOverSpan).on("mouseout",L.mouseOutSpan).merge(L.querySpanElements),L.queryConstraintSpanElements.attr("id",function(e){return e.id}).attr("class",function(e){return e.isLink?"ppt-span-link":e.type===b.node.NodeTypes.ROOT?"ppt-span-root":e.type===b.node.NodeTypes.CHOOSE?void 0!==e.ref.value&&0<e.ref.value.length?"ppt-span-value":"ppt-span-choose":e.type===b.node.NodeTypes.VALUE?"ppt-span-value":e.type===b.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(e){return e.term+" "}),L.querySpanElements.attr("id",function(e){return e.id}).attr("class",function(e){return e.isLink?"ppt-span-link":e.type===b.node.NodeTypes.ROOT?"ppt-span-root":e.type===b.node.NodeTypes.CHOOSE?void 0!==e.ref.value&&0<e.ref.value.length?"ppt-span-value":"ppt-span-choose":e.type===b.node.NodeTypes.VALUE?"ppt-span-value":e.type===b.node.NodeTypes.GROUP?"ppt-span-group":"ppt-span"}).text(function(e){return e.term+" "})},generateConstraintData:function(e,t){var r=[],a=0;return r.push({id:a++,term:L.QUERY_STARTER}),0<t.length&&r.push({id:a++,type:t[0].type,term:O.node.getSemanticValue(t[0]),ref:t[0]}),e.forEach(function(e){var t=e.source,n=e.target;e.type===b.link.LinkTypes.RELATION&&n.type!==b.node.NodeTypes.GROUP&&void 0!==n.value&&0<n.value.length&&(t.type===b.node.NodeTypes.GROUP&&r.push({id:a++,type:t.type,term:O.node.getSemanticValue(t),ref:t}),r.push({id:a++,isLink:!0,term:O.link.getSemanticValue(e),ref:e}),n.type!==b.node.NodeTypes.GROUP&&(void 0!==n.value&&0<n.value.length?r.push({id:a++,type:n.type,term:O.node.getSemanticValue(n),ref:n}):r.push({id:a++,type:n.type,term:"<"+L.CHOOSE_LABEL+" "+O.node.getSemanticValue(n)+">",ref:n})))}),r},generateData:function(e,t){var r=[],a=[],o=0;return e.forEach(function(e){var t=e.source,n=e.target;n.type===b.node.NodeTypes.GROUP&&a.push({id:o++,type:n.type,term:O.node.getSemanticValue(n),ref:n}),e.type!==b.link.LinkTypes.RELATION||n.type===b.node.NodeTypes.GROUP||void 0!==n.value&&0!==n.value.length||(t.type===b.node.NodeTypes.GROUP&&r.push({id:o++,type:t.type,term:O.node.getSemanticValue(t),ref:t}),r.push({id:o++,isLink:!0,term:O.link.getSemanticValue(e),ref:e}),n.type!==b.node.NodeTypes.GROUP&&r.push({id:o++,type:n.type,term:"<"+L.CHOOSE_LABEL+" "+O.node.getSemanticValue(n)+">",ref:n}))}),r.concat(a)},mouseOverSpan:function(){d.select(this).classed("hover",function(e){return e.ref});var t=d.select(this).data()[0];if(t.ref){var e=b.svg.selectAll("#"+b.link.gID+" > g").filter(function(e){return e===t.ref});e.select("path").classed("ppt-link-hover",!0),e.select("text").classed("ppt-link-hover",!0),b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5),I.isActive&&I.querySpanElements.filter(function(e){return e.node===t.ref||e.link===t.ref}).classed("hover",!0)}},rightClickSpan:function(){var t=d.select(this).data()[0];if(!t.isLink&&t.ref){var e=b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.ref});e.on("contextmenu").call(e.node(),t.ref)}},clickSpan:function(){var t=d.select(this).data()[0];if(!t.isLink&&t.ref){var e=b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.ref});e.on("click").call(e.node(),t.ref)}},mouseOutSpan:function(){d.select(this).classed("hover",!1);var t=d.select(this).data()[0];if(t.ref){var e=b.svg.selectAll("#"+b.link.gID+" > g").filter(function(e){return e===t.ref});e.select("path").classed("ppt-link-hover",!1),e.select("text").classed("ppt-link-hover",!1),b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.ref}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0),I.isActive&&I.querySpanElements.filter(function(e){return e.node===t.ref||e.link===t.ref}).classed("hover",!1)}}},I={containerId:"popoto-cypher",MATCH:"MATCH",RETURN:"RETURN",WHERE:"WHERE"};I.QueryElementTypes=Object.freeze({KEYWORD:0,NODE:1,SEPARATOR:2,SOURCE:3,LINK:4,TARGET:5,RETURN:6,WHERE:7}),I.createQueryArea=function(){var e="#"+I.containerId;I.querySpanElements=d.select(e).append("p").attr("class","ppt-query-constraint-elements").selectAll(".queryConstraintSpan")},I.updateQuery=function(){I.querySpanElements=I.querySpanElements.data([]),I.querySpanElements.exit().remove(),I.querySpanElements=I.querySpanElements.data(I.generateData(m.links,m.nodes)),I.querySpanElements=I.querySpanElements.enter().append("span").attr("id",function(e){return"cypher-"+e.id}).on("mouseover",I.mouseOverSpan).on("mouseout",I.mouseOutSpan).on("contextmenu",I.rightClickSpan).on("click",I.clickSpan).merge(I.querySpanElements),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.KEYWORD}).attr("class","ppt-span").text(function(e){return" "+e.value+" "}),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.SEPARATOR}).attr("class","ppt-span").text(function(e){return e.value+" "}),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.NODE}).attr("class",function(e){return void 0!==e.node.value&&0<e.node.value.length?"ppt-span-root-value":"ppt-span-root"}).text(function(e){return"("+e.node.internalLabel+":`"+e.node.label+"`)"}),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.SOURCE}).attr("class",function(e){return e.node===m.getRootNode()?void 0!==e.node.value&&0<e.node.value.length?"ppt-span-root-value":"ppt-span-root":void 0!==e.node.value&&0<e.node.value.length?"ppt-span-value":"ppt-span-choose"}).text(function(e){var t=e.node;return"("+t.internalLabel+":`"+t.label+"`)"}),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.LINK}).attr("class","ppt-span-link").text(function(e){return!0===e.link.target.isParentRelReverse?"<-[:`"+e.link.label+"`]-":"-[:`"+e.link.label+"`]-"+(A.USE_RELATION_DIRECTION?">":"")}),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.TARGET}).attr("class",function(e){return void 0!==e.node.value&&0<e.node.value.length?"ppt-span-value":"ppt-span-choose"}).text(function(e){return"("+e.node.internalLabel+":`"+e.node.label+"`)"}),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.WHERE}).attr("class",function(e){return e.node===m.getRootNode()?"ppt-span-root-value":"ppt-span-value"}).text(function(t){var e=t.node;if(!0===e.isNegative){if(!e.hasOwnProperty("value")||e.value.length<=0)return"(NOT ("+t.link.source.internalLabel+":`"+t.link.source.label+"`)-[:`"+t.link.label+"`]->(:`"+t.link.target.label+"`))";var n=[],r=O.node.getConstraintAttribute(e.label);return e.value.forEach(function(e){n.push("(NOT ("+t.link.source.internalLabel+":`"+t.link.source.label+"`)-[:`"+t.link.label+"`]->(:`"+t.link.target.label+"`{"+r+":"+e.attributes[r]+"}))")}),n.join(" AND ")}var a=O.node.getConstraintAttribute(e.label),o="",l="";return a===A.NEO4J_INTERNAL_ID?o+=e.internalLabel+".id":o+=e.internalLabel+"."+a,e.hasOwnProperty("value")&&1<e.value.length?o+=" IN [":o+=" = ",e.value.forEach(function(e){if(o+=l,l=", ",a===A.NEO4J_INTERNAL_ID)o+=e.internalID;else{var t=e.attributes[a];o+="boolean"==typeof t||"number"==typeof t?t:'"'+t+'"'}}),1<e.value.length&&(o+="]"),"("+o+")"}),I.querySpanElements.filter(function(e){return e.type===I.QueryElementTypes.RETURN}).attr("class",function(e){return void 0!==e.node.value&&0<e.node.value.length?"ppt-span-root-value":"ppt-span-root"}).text(function(e){return e.node.internalLabel})},I.generateData=function(e){var t=[],n=0,r=m.getRootNode(),a=A.getRelevantLinks(r,r,e),o=a.filter(function(e){return!0===e.target.isNegative&&(!e.target.hasOwnProperty("value")||e.target.value.length<=0)});t.push({id:n++,type:I.QueryElementTypes.KEYWORD,value:I.MATCH}),r&&t.push({id:n++,type:I.QueryElementTypes.NODE,node:r}),0<a.length&&a.length>o.length&&t.push({id:n++,type:I.QueryElementTypes.SEPARATOR,value:","});for(var l=0;l<a.length;l++){!0===(s=a[l]).target.isNegative&&(!s.target.hasOwnProperty("value")||s.target.value.length<=0)||(t.push({id:n++,type:I.QueryElementTypes.SOURCE,node:s.source}),t.push({id:n++,type:I.QueryElementTypes.LINK,link:s}),t.push({id:n++,type:I.QueryElementTypes.TARGET,node:s.target}),l<a.length-1&&t.push({id:n++,type:I.QueryElementTypes.SEPARATOR,value:","}))}(r&&void 0!==r.value&&0<r.value.length||0<a.length)&&t.push({id:n++,type:I.QueryElementTypes.KEYWORD,value:I.WHERE}),r&&void 0!==r.value&&0<r.value.length&&(t.push({id:n++,type:I.QueryElementTypes.WHERE,node:r}),0<a.length&&t.push({id:n++,type:I.QueryElementTypes.SEPARATOR,value:" AND "}));var i=!1;for(l=0;l<a.length;l++){var s;!0===(s=a[l]).target.isNegative?(i&&t.push({id:n++,type:I.QueryElementTypes.SEPARATOR,value:" AND "}),t.push({id:n++,type:I.QueryElementTypes.WHERE,node:s.target,link:s}),i=!0):void 0!==s.target.value&&0<s.target.value.length&&(i&&t.push({id:n++,type:I.QueryElementTypes.SEPARATOR,value:" AND "}),t.push({id:n++,type:I.QueryElementTypes.WHERE,node:s.target}),i=!0)}return t.push({id:n++,type:I.QueryElementTypes.KEYWORD,value:I.RETURN}),r&&t.push({id:n++,type:I.QueryElementTypes.RETURN,node:r}),t},I.mouseOverSpan=function(){var t=d.select(this).data()[0];if(t.node)I.querySpanElements.filter(function(e){return e.node===t.node}).classed("hover",!0),b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",.5),L.isActive&&(L.queryConstraintSpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!0),L.querySpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!0));else if(t.link){d.select(this).classed("hover",!0);var e=b.svg.selectAll("#"+b.link.gID+" > g").filter(function(e){return e===t.link});e.select("path").classed("ppt-link-hover",!0),e.select("text").classed("ppt-link-hover",!0)}},I.mouseOutSpan=function(){var t=d.select(this).data()[0];if(t.node)I.querySpanElements.filter(function(e){return e.node===t.node}).classed("hover",!1),b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.node}).select(".ppt-g-node-background").selectAll("circle").transition().style("fill-opacity",0),L.isActive&&(L.queryConstraintSpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!1),L.querySpanElements.filter(function(e){return e.ref===t.node}).classed("hover",!1));else if(t.link){d.select(this).classed("hover",!1);var e=b.svg.selectAll("#"+b.link.gID+" > g").filter(function(e){return e===t.link});e.select("path").classed("ppt-link-hover",!1),e.select("text").classed("ppt-link-hover",!1)}},I.clickSpan=function(){var t=d.select(this).data()[0];if(t.node){var e=b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.node});e.on("click").call(e.node(),t.node)}},I.rightClickSpan=function(){var t=d.select(this).data()[0];if(t.node){var e=b.svg.selectAll("#"+b.node.gID+" > g").filter(function(e){return e===t.node});e.on("contextmenu").call(e.node(),t.node)}},e.version=t,e.cypherviewer=I,e.dataModel=m,e.graph=b,e.logger=p,e.provider=O,e.query=A,e.queryviewer=L,e.rest=c,e.result=g,e.taxonomy=i,e.tools=n,e.start=function(e){if(p.info("Popoto 2.0.8 start on "+e),b.mainLabel=e,void 0===c.CYPHER_URL)p.error("popoto.rest.CYPHER_URL is not set but is required.");else{if(n=d.select("#"+b.containerId),r=d.select("#"+i.containerId),a=d.select("#"+L.containerId),o=d.select("#"+I.containerId),l=d.select("#"+g.containerId),n.empty()?(p.debug("The page doesn't contain a container with ID = \""+b.containerId+'" no graph area will be generated. This ID is defined in graph.containerId property.'),b.isActive=!1):b.isActive=!0,r.empty()?(p.debug("The page doesn't contain a container with ID = \""+i.containerId+'" no taxonomy filter will be generated. This ID is defined in taxonomy.containerId property.'),i.isActive=!1):i.isActive=!0,a.empty()?(p.debug("The page doesn't contain a container with ID = \""+L.containerId+'" no query viewer will be generated. This ID is defined in queryviewer.containerId property.'),L.isActive=!1):L.isActive=!0,o.empty()?(p.debug("The page doesn't contain a container with ID = \""+I.containerId+'" no cypher query viewer will be generated. This ID is defined in cypherviewer.containerId property.'),I.isActive=!1):I.isActive=!0,l.empty()?(p.debug("The page doesn't contain a container with ID = \""+g.containerId+'" no result area will be generated. This ID is defined in result.containerId property.'),g.isActive=!1):g.isActive=!0,i.isActive&&i.createTaxonomyPanel(),b.isActive)if(b.createGraphArea(),b.createForceLayout(),"string"==typeof e||e instanceof String){var t=O.node.getSchema(e);void 0!==t?b.addSchema(t):b.addRootNode(e)}else b.loadSchema(e);L.isActive&&L.createQueryArea(),I.isActive&&I.createQueryArea(),!0===b.USE_VORONOI_LAYOUT&&b.voronoi.extent([[-popoto.graph.getSVGWidth(),-popoto.graph.getSVGWidth()],[2*popoto.graph.getSVGWidth(),2*popoto.graph.getSVGHeight()]]),f()}var n,r,a,o,l},e.update=f,e.updateGraph=h,e.appendFittedText=s,Object.defineProperty(e,"__esModule",{value:!0})});